<form class="osp sheet actor character" autocomplete="off" style="height: 700px; position: relative; overflow: visible; font-family: 'Minion Pro', serif; font-weight: normal; width: 600px; background: white; background-color: white;">
  <style>
    /* White Background Override - Apply to entire sheet and window */
    form.osp.sheet.actor.character,
    .osp.sheet.actor.character,
    .application.window-app.sheet.actor.character.osp,
    .application.window-app.sheet.actor.character.osp .window-content,
    .window-content form.osp.sheet.actor.character,
    .window-content .osp.sheet.actor.character,
    .window-content .window-content form.osp.sheet.actor.character,
    .osp .window-content {
      background: white !important;
      background-color: white !important;
      background-image: none !important;
    }
    
    /* Single Background Image System - Applied to window instead of form */
    form.osp.sheet.actor.character {
      position: relative;
    }
    
    /* Override any Foundry default backgrounds */
    .osp.sheet.actor.character,
    .application.window-app.sheet.actor.character.osp,
    .window-content form.osp.sheet.actor.character,
    .window-content .osp.sheet.actor.character,
    .window-content .window-content form.osp.sheet.actor.character {
      background: white !important;
      background-color: white !important;
      background-image: none !important;
    }
    
    /* Ensure the application window allows tabs to extend beyond right edge */
    .application.window-app.sheet.actor.character.osp {
      overflow: visible !important; /* Allow tabs to extend beyond window */
    }
    
    /* Also override the window content wrapper */
    .application.window-app.sheet.actor.character.osp .window-content,
    .osp .window-content {
      background: white !important;
      background-color: white !important;
      background-image: none !important;
      padding: 0 !important;
      overflow: visible !important; /* Allow tabs to show beyond content area */
    }
    
    /* Keep character name with its original styling */
    .char-name {
  font-family: inherit !important;
  font-weight: bold !important;
  /* font-size intentionally unset here; set via inline style in HTML for px control */
    }
    
    /* Character name background should be transparent */
    form.osp.sheet.actor.character input.char-name,
    form.osp.sheet.actor.character input#char-name,
    .osp.sheet.actor.character input.char-name,
    .osp.sheet.actor.character input#char-name {
      background-color: transparent !important;
      background: transparent !important;
    }
    
  
    /* XP progress bar should be visible with different color */
    form.osp.sheet.actor.character .xp-progress-bar,
    .osp.sheet.actor.character .xp-progress-bar {
      background-color: #4a90e2 !important;
    }
    
    /* Static header background image override - use existing file */
    form.osp.sheet.actor.character .static-header {
  background: url('systems/osp-houserules/assets/character-sheet/main-sheet.webp') no-repeat !important;
  background-position: left top !important;
  background-size: contain !important;
  background-color: transparent !important;
  margin-top: 0 !important;
  padding-top: 0 !important;
      background-color: transparent !important;
    }
    
    /* Tab system styles - Individual absolute positioned tabs */
    .sheet-tabs {
      position: absolute;
      left: 600px; /* Position tabs to extend from right edge */
      top: 50px; /* Starting position */
      width: 30px; /* Container width */
      height: 400px; /* Container height to accommodate all tabs */
      z-index: -1; /* Behind other content */
      pointer-events: auto;
    }

    .sheet-tabs a.item {
      position: absolute;
      width: 32px; /* Tab width (becomes height after rotation) */
      height: 80px; /* Tab height (becomes width after rotation) */
      background: #b5dcb8; /* Matching green background */
      border: 1px solid #8b7355;
      color: #4a3a1a;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Minion Pro', serif;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      border-radius: 0 10px 10px 0;
      transform-origin: center center;
      transition: all 0.2s ease;
      writing-mode: vertical-rl; /* Rotate text 90 degrees */
      text-orientation: mixed; /* Keep letters upright */
      
      /* Remove any default focus/outline styles */
      outline: none !important;
      /* Remove any text shadows */
      text-shadow: none !important;
      
      /* Shading for inactive tabs */
      box-shadow: inset 0 0 0 1000px rgba(139, 115, 85, 0.3); /* Brown overlay for inactive state */
      opacity: 0.7; /* Slightly reduce overall opacity */
    }

    /* Remove red highlighting on focus */
    .sheet-tabs a.item:focus {
      outline: none !important;
      text-shadow: none !important;
      box-shadow: inset 0 0 0 1000px rgba(139, 115, 85, 0.3); /* Maintain same styling as default */
    }

    /* Position each tab individually with precise spacing */
    .sheet-tabs a.item:nth-child(1) { top: -219px; left: -8px; } /* Adjusted to fit the background */
    .sheet-tabs a.item:nth-child(2) { top: -140px; left: -42px; } /* 30px height + 1px gap */
    .sheet-tabs a.item:nth-child(3) { top: -61px; left: -76px; }
    .sheet-tabs a.item:nth-child(4) { top: 18px; left: -110px; }

    .sheet-tabs a.item:hover {
      background: #a0d1a3; /* Slightly darker green on hover */
      color: #3a2915; /* Darker brown */
      border-color: #6b4112; /* Darker brown border */
      text-shadow: none !important; /* Remove any text shadows */
      /* Reduce shading on hover to show interaction */
      box-shadow: inset 0 0 0 1000px rgba(139, 115, 85, 0.15); /* Lighter brown overlay */
      opacity: 0.9; /* Slightly higher opacity on hover */
    }

    .sheet-tabs a.item.active {
      background: #c9e7cc; /* Lighter green background for active tab */
      color: #2d1f0f; /* Darkest brown text */
      border-color: #5a3508; /* Darkest border */
      text-shadow: none !important; /* Remove any text shadows */
      /* Remove shading for active tab */
      box-shadow: none; /* No overlay for active state */
      opacity: 1; /* Full opacity for active tab */
      /* Add slight inset shadow for depth */
      box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1);
      font-weight: bold;
      z-index: 1; /* Bring active tab forward */
    }
    .sheet-body .tab {
      display: none;
    }
    .sheet-body .tab.active {
      display: block;
    }
    /* Ensure tab container doesn't block clicks */
    .sheet-tabs {
      position: relative;
      z-index: 10;
    }
    /* XP Award Button Hover Effect */
    button.xp-award-btn {
      color: #333 !important;
      background: none !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
    }
    button.xp-award-btn:hover {
      color: #dc2626 !important;
      background: none !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
    }
    button.xp-award-btn:focus {
      color: #dc2626 !important;
      outline: none !important;
      box-shadow: none !important;
      background: none !important;
      border: none !important;
    }
  </style>
  <script>
    console.log('Character sheet script loaded');
    
    // Function to run when DOM is ready
    function initializeCharacterSheet() {
      console.log('Initializing character sheet...');
      
      // Set encumbrance bar width after rendering
      const bar = document.querySelector('.encumbrance-bar[data-encumbrance]');
      if (bar) {
        const percent = bar.getAttribute('data-encumbrance');
        bar.style.width = percent + '%';
      }
      
      // Character Portrait Image Resize and Position System
      console.log('Looking for image elements...');
      
      // Try multiple selector strategies
      const imageContainer = document.querySelector('.character-image-container') || 
                            document.querySelector('[class*="character-image-container"]');
      const portrait = document.querySelector('.character-portrait') || 
                      document.querySelector('img.character-portrait') ||
                      document.querySelector('.character-image img');
      const imageControls = document.querySelector('.image-controls');
      const resetButton = document.querySelector('.reset-image');
      const fitButton = document.querySelector('.fit-image');
      
      console.log('Image elements found:', {
        imageContainer: !!imageContainer,
        portrait: !!portrait,
        imageControls: !!imageControls,
        resetButton: !!resetButton,
        fitButton: !!fitButton
      });
      
      if (imageContainer) {
        console.log('Image container found, classes:', imageContainer.className);
      }
      if (portrait) {
        console.log('Portrait found, classes:', portrait.className);
      }
      
      if (imageContainer && portrait) {
        console.log('Setting up image resize functionality...');
        
        // Check if image already has a transform and preserve it
        const existingTransform = portrait.style.transform;
        console.log('Existing transform:', existingTransform);
        
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        
        // Parse existing transform if it exists
        if (existingTransform) {
          const scaleMatch = existingTransform.match(/scale\(([^)]+)\)/);
          const translateMatch = existingTransform.match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
          
          if (scaleMatch) {
            scale = parseFloat(scaleMatch[1]);
            console.log('Preserved scale:', scale);
          }
          if (translateMatch) {
            translateX = parseFloat(translateMatch[1]);
            translateY = parseFloat(translateMatch[2]);
            console.log('Preserved translate:', translateX, translateY);
          }
        }
        
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let dragStartTranslate = { x: 0, y: 0 };
        
        // Function to apply transform
        function updateTransform() {
          const transformString = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
          portrait.style.transform = transformString;
          console.log(`Transform applied: ${transformString}`);
        }
        
        // Show/hide controls (only if they exist)
        if (imageControls) {
          imageContainer.addEventListener('mouseenter', () => {
            imageControls.style.display = 'flex';
          });
          
          imageContainer.addEventListener('mouseleave', () => {
            if (!isDragging) {
              imageControls.style.display = 'none';
            }
          });
        }
        
        // Mouse wheel for scaling
        const handleWheel = (e) => {
          console.log('Wheel event detected!', e.deltaY);
          e.preventDefault();
          e.stopPropagation();
          const delta = e.deltaY > 0 ? -0.1 : 0.1;
          const newScale = Math.max(0.1, Math.min(3, scale + delta));
          if (newScale !== scale) {
            scale = newScale;
            updateTransform();
            console.log(`Image scale: ${scale.toFixed(2)}`);
          }
        };
        
        // Add wheel event to both container and portrait for better coverage
        imageContainer.addEventListener('wheel', handleWheel, { passive: false });
        portrait.addEventListener('wheel', handleWheel, { passive: false });
        
        console.log('Wheel events attached to image elements');
        
        // Mouse drag for positioning
        portrait.addEventListener('mousedown', (e) => {
          if (e.button === 0) { // Left mouse button
            console.log(`Starting drag. Current scale: ${scale}, translate: ${translateX}, ${translateY}`);
            isDragging = true;
            dragStart.x = e.clientX;
            dragStart.y = e.clientY;
            dragStartTranslate.x = translateX;
            dragStartTranslate.y = translateY;
            portrait.style.cursor = 'grabbing';
            if (imageControls) imageControls.style.display = 'flex';
            e.preventDefault();
          }
        });
        
        document.addEventListener('mousemove', (e) => {
          if (isDragging) {
            const deltaX = e.clientX - dragStart.x;
            const deltaY = e.clientY - dragStart.y;
            translateX = dragStartTranslate.x + deltaX;
            translateY = dragStartTranslate.y + deltaY;
            updateTransform();
          }
        });
        
        document.addEventListener('mouseup', () => {
          if (isDragging) {
            console.log(`Ending drag. Final scale: ${scale}, translate: ${translateX}, ${translateY}`);
            isDragging = false;
            portrait.style.cursor = 'grab';
            if (imageControls) {
              setTimeout(() => {
                if (!imageContainer.matches(':hover')) {
                  imageControls.style.display = 'none';
                }
              }, 100);
            }
          }
        });
        
        // Reset button functionality (only if it exists)
        if (resetButton) {
          resetButton.addEventListener('click', (e) => {
            e.stopPropagation();
            scale = 1;
            translateX = 0;
            translateY = 0;
            updateTransform();
          });
        }
        
    // ...existing code...
                  const z = parseInt($html.find('.z-index').val()) || field.defaultZ;
                  updateZIndex(z);
                });
                $html.find('.apply-zindex').click(() => {
                  const z = parseInt($html.find('.z-index').val()) || field.defaultZ;
                  updateZIndex(z);
                });
                $html.find('.z-behind').click(() => updateZIndex(-1));
                $html.find('.z-front').click(() => updateZIndex(20));
                $html.find('.z-reset').click(() => updateZIndex(field.defaultZ));
              }
            });
            positionDialog.render(true);
          }

          // Attach right-click event
          el.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (positionDialog) {
              positionDialog.close();
              positionDialog = null;
            } else {
              showPositionDialog();
            }
          });
        });
      }

      // Call the universal positioning initializer
      setTimeout(initializeUniversalPositioning, 0);
        
        // Function to update position
        function updatePosition(x, y) {
          // Constrain to static header area (0 to 600-130 width, 0 to 300-130 height)
          x = Math.max(0, Math.min(470, x)); // 600 - 130 = 470
          y = Math.max(0, Math.min(170, y)); // 300 - 130 = 170
          
          currentX = x;
          currentY = y;
          
          // Update position
          positionContainer.style.left = x + 'px';
          positionContainer.style.top = y + 'px';
          positionContainer.setAttribute('data-x', x);
          positionContainer.setAttribute('data-y', y);
          
          // Update dialog fields if dialog is open
          if (positionDialog && positionDialog.element) {
            const xInput = positionDialog.element.find('.x-input')[0];
            const yInput = positionDialog.element.find('.y-input')[0];
            const xCoord = positionDialog.element.find('.x-coord')[0];
            const yCoord = positionDialog.element.find('.y-coord')[0];
            
            if (xInput) xInput.value = x;
            if (yInput) yInput.value = y;
            if (xCoord) xCoord.textContent = x;
            if (yCoord) yCoord.textContent = y;
          }
          
          // Save to actor data
          const form = positionContainer.closest('form');
          if (form) {
            // Update hidden input fields
            const xInput = form.querySelector('[name="system.portraitPosition.x"]');
            const yInput = form.querySelector('[name="system.portraitPosition.y"]');
            if (xInput) xInput.value = x;
            if (yInput) yInput.value = y;
            
            // If this is a Foundry actor sheet, save immediately
            if (form.closest('.character-sheet')) {
              console.log('Position updated:', x, y);
            }
          }
        }
        
        // Function to create and show the positioning dialog
        function showPositionDialog() {
          if (positionDialog) {
            positionDialog.bringToTop();
            return;
          }
          
          // Get current border settings
          const characterImage = positionContainer.querySelector('.character-image');
          const form = positionContainer.closest('form');
          let currentBorderEnabled = true;
          let currentBorderSize = 1;
          let currentBorderColor = '#000000';
          let currentFrameWidth = 130;
          let currentFrameHeight = 130;
          let currentZIndex = 5;
          
          if (form) {
            const enabledInput = form.querySelector('[name="system.portraitBorder.enabled"]');
            const sizeInput = form.querySelector('[name="system.portraitBorder.size"]');
            const colorInput = form.querySelector('[name="system.portraitBorder.color"]');
            const widthInput = form.querySelector('[name="system.portraitFrame.width"]');
            const heightInput = form.querySelector('[name="system.portraitFrame.height"]');
            const zIndexInput = form.querySelector('[name="system.portraitPosition.zIndex"]');
            
            if (enabledInput && enabledInput.value) currentBorderEnabled = enabledInput.value === 'true';
            if (sizeInput && sizeInput.value) currentBorderSize = parseInt(sizeInput.value) || 1;
            if (colorInput && colorInput.value) currentBorderColor = colorInput.value;
            if (widthInput && widthInput.value) currentFrameWidth = parseInt(widthInput.value) || 130;
            if (heightInput && heightInput.value) currentFrameHeight = parseInt(heightInput.value) || 130;
            if (zIndexInput && zIndexInput.value) currentZIndex = parseInt(zIndexInput.value) || 5;
          }
          
          const dialogContent = `
            <div class="portrait-position-dialog" style="padding: 10px;">
              <div style="margin-bottom: 10px;">
                <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">Portrait Position & Border Controls</h3>
              </div>
              
              <!-- Manual Coordinate Entry -->
              <div class="coordinates-entry" style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px; padding: 8px; background: #f0f0f0; border-radius: 4px;">
                <label style="font-size: 12px; font-weight: bold;">X:</label>
                <input type="number" class="x-input" min="0" max="470" style="width: 50px; height: 24px; font-size: 11px; text-align: center; border: 1px solid #ccc; border-radius: 3px;" value="${currentX}" />
                <label style="font-size: 12px; font-weight: bold;">Y:</label>
                <input type="number" class="y-input" min="0" max="170" style="width: 50px; height: 24px; font-size: 11px; text-align: center; border: 1px solid #ccc; border-radius: 3px;" value="${currentY}" />
                <button type="button" class="apply-coords" title="Apply Coordinates" style="width: 28px; height: 24px; border: none; background: #10b981; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px;">✓</button>
              </div>
              
              <!-- Current Position Display -->
              <div class="coordinates-display" style="text-align: center; font-size: 12px; margin-bottom: 15px; padding: 5px; background: #e8f4f8; border-radius: 3px;">
                <strong>Current Position: X: <span class="x-coord">${currentX}</span>, Y: <span class="y-coord">${currentY}</span></strong>
              </div>
              
              <!-- Border Controls -->
              <div class="border-controls" style="margin-bottom: 15px; padding: 8px; background: #f9f9f9; border-radius: 4px; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 8px 0; font-size: 12px; color: #333;">Border Settings</h4>
                
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 11px;">
                    <input type="checkbox" class="border-enabled" ${currentBorderEnabled ? 'checked' : ''} />
                    Enable Border
                  </label>
                </div>
                
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                  <label style="font-size: 11px; font-weight: bold;">Size:</label>
                  <input type="number" class="border-size" min="0" max="10" style="width: 40px; height: 20px; font-size: 10px; text-align: center; border: 1px solid #ccc; border-radius: 2px;" value="${currentBorderSize}" />
                  <span style="font-size: 10px; color: #666;">px</span>
                  
                  <label style="font-size: 11px; font-weight: bold; margin-left: 8px;">Color:</label>
                  <input type="color" class="border-color" style="width: 30px; height: 20px; border: 1px solid #ccc; border-radius: 2px; cursor: pointer;" value="${currentBorderColor}" />
                </div>
                
                <button type="button" class="apply-border" title="Apply Border Settings" style="width: 100%; height: 24px; border: none; background: #8b5cf6; color: white; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; margin-bottom: 4px;">Apply Border</button>
                
                <button type="button" class="save-border-default" title="Save Border as Default for New Characters" style="width: 100%; height: 24px; border: none; background: #3b82f6; color: white; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px;">💾 Save Border Default</button>
              </div>
              
              <!-- Frame Size Controls -->
              <div class="frame-controls" style="margin-bottom: 15px; padding: 8px; background: #f5f5f5; border-radius: 4px; border: 1px solid #ddd;">
                <h4 style="margin: 0 0 8px 0; font-size: 12px; color: #333;">Frame Size</h4>
                
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                  <label style="font-size: 11px; font-weight: bold;">Width:</label>
                  <input type="number" class="frame-width" min="50" max="300" style="width: 50px; height: 20px; font-size: 10px; text-align: center; border: 1px solid #ccc; border-radius: 2px;" value="${currentFrameWidth}" />
                  <span style="font-size: 10px; color: #666;">px</span>
                  
                  <label style="font-size: 11px; font-weight: bold; margin-left: 8px;">Height:</label>
                  <input type="number" class="frame-height" min="50" max="300" style="width: 50px; height: 20px; font-size: 10px; text-align: center; border: 1px solid #ccc; border-radius: 2px;" value="${currentFrameHeight}" />
                  <span style="font-size: 10px; color: #666;">px</span>
                </div>
                
                <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                  <button type="button" class="frame-square" title="Make Square" style="flex: 1; height: 20px; border: none; background: #6b7280; color: white; font-size: 9px; cursor: pointer; border-radius: 2px;">Square</button>
                  <button type="button" class="frame-reset" title="Reset to 130x130" style="flex: 1; height: 20px; border: none; background: #6b7280; color: white; font-size: 9px; cursor: pointer; border-radius: 2px;">Reset</button>
                </div>
                
                <button type="button" class="apply-frame" title="Apply Frame Size" style="width: 100%; height: 24px; border: none; background: #059669; color: white; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; margin-bottom: 4px;">Apply Frame Size</button>
                
                <button type="button" class="save-frame-default" title="Save Frame Size as Default for New Characters" style="width: 100%; height: 24px; border: none; background: #7c3aed; color: white; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px;">💾 Save Frame Default</button>
              </div>
              
              <!-- Z-Index Controls -->
              <div style="border-top: 1px solid #e5e7eb; padding-top: 10px; margin-top: 10px;">
                <h4 style="margin: 0 0 8px 0; font-size: 12px; color: #333;">Layer (Z-Index)</h4>
                
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                  <label style="font-size: 11px; font-weight: bold;">Z-Index:</label>
                  <input type="number" class="z-index" min="-10" max="50" style="width: 50px; height: 20px; font-size: 10px; text-align: center; border: 1px solid #ccc; border-radius: 2px;" value="${currentZIndex}" />
                  <span style="font-size: 10px; color: #666;">(-10 to 50)</span>
                </div>
                
                <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                  <button type="button" class="z-behind" title="Send Behind (z-index: -1)" style="flex: 1; height: 20px; border: none; background: #6b7280; color: white; font-size: 9px; cursor: pointer; border-radius: 2px;">Behind</button>
                  <button type="button" class="z-front" title="Bring to Front (z-index: 20)" style="flex: 1; height: 20px; border: none; background: #6b7280; color: white; font-size: 9px; cursor: pointer; border-radius: 2px;">Front</button>
                  <button type="button" class="z-reset" title="Reset to Default (z-index: 5)" style="flex: 1; height: 20px; border: none; background: #6b7280; color: white; font-size: 9px; cursor: pointer; border-radius: 2px;">Default</button>
                </div>
                
                <button type="button" class="apply-zindex" title="Apply Z-Index" style="width: 100%; height: 24px; border: none; background: #059669; color: white; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; margin-bottom: 4px;">Apply Z-Index</button>
                
                <button type="button" class="save-zindex-default" title="Save Z-Index as Default for New Characters" style="width: 100%; height: 24px; border: none; background: #dc2626; color: white; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px;">💾 Save Z-Index Default</button>
              </div>
              
              <!-- Arrow Controls -->
              <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 3px; margin-bottom: 5px;">
                  <!-- Top row -->
                  <div></div>
                  <button type="button" class="move-up" title="Move Up (1px)" style="width: 32px; height: 32px; border: none; background: #4a5568; color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px;">↑</button>
                  <div></div>
                  
                  <!-- Middle row -->
                  <button type="button" class="move-left" title="Move Left (1px)" style="width: 32px; height: 32px; border: none; background: #4a5568; color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px;">←</button>
                  <div style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: #e2e8f0; border-radius: 4px; font-size: 14px;">⊕</div>
                  <button type="button" class="move-right" title="Move Right (1px)" style="width: 32px; height: 32px; border: none; background: #4a5568; color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px;">→</button>
                  
                  <!-- Bottom row -->
                  <div></div>
                  <button type="button" class="move-down" title="Move Down (1px)" style="width: 32px; height: 32px; border: none; background: #4a5568; color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px;">↓</button>
                  <div></div>
                </div>
                <div style="font-size: 10px; color: #666; text-align: center;">Use arrow buttons for 1-pixel precision</div>
              </div>
              
              <!-- Save Button -->
              <button type="button" class="save-position-permanent" title="Save Position as Default for New Characters" style="width: 100%; height: 32px; border: none; background: #f59e0b; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: bold; margin-bottom: 10px;">💾 SAVE AS DEFAULT</button>
              
              <div style="font-size: 10px; color: #666; text-align: center; line-height: 1.3;">
                Right-click the portrait again to close this dialog<br>
                Dialog can be moved by dragging the title bar
              </div>
            </div>
          `;
          
          positionDialog = new Dialog({
            title: "Portrait Position Controller",
            content: dialogContent,
            buttons: {
              close: {
                icon: '<i class="fas fa-times"></i>',
                label: "Close",
                callback: () => {
                  positionDialog = null;
                }
              }
            },
            close: () => {
              positionDialog = null;
            },
            render: (html) => {
              // Setup event handlers for the dialog controls
              const $html = $(html);
              
              // Arrow button controls
              $html.find('.move-up').click(() => updatePosition(currentX, currentY - 1));
              $html.find('.move-down').click(() => updatePosition(currentX, currentY + 1));
              $html.find('.move-left').click(() => updatePosition(currentX - 1, currentY));
              $html.find('.move-right').click(() => updatePosition(currentX + 1, currentY));
              
              // Manual coordinate entry
              $html.find('.apply-coords').click(() => {
                const newX = parseInt($html.find('.x-input').val()) || 0;
                const newY = parseInt($html.find('.y-input').val()) || 0;
                updatePosition(newX, newY);
                console.log('Applied manual coordinates:', newX, newY);
              });
              
              // Enter key support for coordinate inputs
              $html.find('.x-input, .y-input').keypress((e) => {
                if (e.which === 13) { // Enter key
                  $html.find('.apply-coords').click();
                }
              });
              
              // Border control functionality
              function updateBorder(enabled, size, color) {
                const characterImage = positionContainer.querySelector('.character-image');
                if (characterImage) {
                  if (enabled && size > 0) {
                    characterImage.style.border = `${size}px solid ${color}`;
                  } else {
                    characterImage.style.border = 'none';
                  }
                  
                  // Update hidden input fields
                  const form = positionContainer.closest('form');
                  if (form) {
                    const enabledInput = form.querySelector('[name="system.portraitBorder.enabled"]');
                    const sizeInput = form.querySelector('[name="system.portraitBorder.size"]');
                    const colorInput = form.querySelector('[name="system.portraitBorder.color"]');
                    
                    if (enabledInput) enabledInput.value = enabled ? 'true' : 'false';
                    if (sizeInput) sizeInput.value = size;
                    if (colorInput) colorInput.value = color;
                    
                    console.log('Border updated:', enabled, size, color);
                  }
                }
              }

              // Frame size control functionality
              function updateFrameSize(width, height) {
                const characterImage = positionContainer.querySelector('.character-image');
                if (characterImage) {
                  // Ensure values are within valid range
                  width = Math.max(50, Math.min(300, width || 130));
                  height = Math.max(50, Math.min(300, height || 130));
                  
                  characterImage.style.width = `${width}px`;
                  characterImage.style.height = `${height}px`;
                  
                  // Update hidden input fields
                  const form = positionContainer.closest('form');
                  if (form) {
                    const widthInput = form.querySelector('[name="system.portraitFrame.width"]');
                    const heightInput = form.querySelector('[name="system.portraitFrame.height"]');
                    
                    if (widthInput) widthInput.value = width;
                    if (heightInput) heightInput.value = height;
                    
                    console.log('Frame size updated:', width, height);
                  }
                }
              }

              // Z-index control functionality
              function updateZIndex(zIndex) {
                console.log('updateZIndex called with:', zIndex);
                console.log('positionContainer element:', positionContainer);
                
                // Ensure value is within valid range
                zIndex = Math.max(-10, Math.min(50, zIndex || 5));
                
                console.log('Setting z-index to:', zIndex);
                positionContainer.style.zIndex = zIndex;
                positionContainer.setAttribute('data-z', zIndex);
                
                console.log('Updated style.zIndex:', positionContainer.style.zIndex);
                console.log('Updated data-z attribute:', positionContainer.getAttribute('data-z'));
                
                // Update hidden input field
                const form = positionContainer.closest('form');
                if (form) {
                  const zIndexInput = form.querySelector('[name="system.portraitPosition.zIndex"]');
                  
                  if (zIndexInput) zIndexInput.value = zIndex;
                  
                  console.log('Z-index updated:', zIndex);
                }
              }
              
              // Border control event handlers
              $html.find('.apply-border').click(() => {
                const enabled = $html.find('.border-enabled').is(':checked');
                const size = parseInt($html.find('.border-size').val()) || 0;
                const color = $html.find('.border-color').val() || '#000000';
                updateBorder(enabled, size, color);
                console.log('Applied border settings:', { enabled, size, color });
              });
              
              // Real-time border preview
              $html.find('.border-enabled, .border-size, .border-color').on('change input', () => {
                const enabled = $html.find('.border-enabled').is(':checked');
                const size = parseInt($html.find('.border-size').val()) || 0;
                const color = $html.find('.border-color').val() || '#000000';
                updateBorder(enabled, size, color);
              });
              
              // Save border as default functionality
              $html.find('.save-border-default').click(async () => {
                try {
                  const button = $html.find('.save-border-default')[0];
                  const originalText = button.textContent;
                  button.textContent = '💾 SAVING...';
                  button.disabled = true;
                  
                  const enabled = $html.find('.border-enabled').is(':checked');
                  const size = parseInt($html.find('.border-size').val()) || 0;
                  const color = $html.find('.border-color').val() || '#000000';
                  
                  // Show confirmation dialog
                  const confirmed = await Dialog.confirm({
                    title: "Save Border Settings as Default",
                    content: `<p>This will set the default border settings for all NEW characters:</p><ul><li>Enabled: ${enabled ? 'Yes' : 'No'}</li><li>Size: ${size}px</li><li>Color: ${color}</li></ul><p><strong>Existing characters will keep their current border settings unless reset.</strong></p>`,
                    yes: () => true,
                    no: () => false
                  });
                  
                  if (confirmed) {
                    await game.settings.set('osp-houserules', 'defaultPortraitBorder', {
                      enabled: enabled,
                      size: size,
                      color: color,
                      timestamp: Date.now()
                    });
                    
                    button.textContent = '✓ SAVED!';
                    button.style.background = '#10b981';
                    setTimeout(() => {
                      button.textContent = originalText;
                      button.style.background = '#3b82f6';
                      button.disabled = false;
                    }, 2000);
                    
                    ui.notifications.info(`Default border settings saved: ${enabled ? 'Enabled' : 'Disabled'}, ${size}px, ${color}`);
                    console.log('Default border settings saved:', { enabled, size, color });
                  } else {
                    button.textContent = originalText;
                    button.disabled = false;
                  }
                } catch (error) {
                  console.error('Failed to save default border settings:', error);
                  const button = $html.find('.save-border-default')[0];
                  button.textContent = '❌ FAILED';
                  button.style.background = '#dc2626';
                  setTimeout(() => {
                    button.textContent = '💾 Save Border Default';
                    button.style.background = '#3b82f6';
                    button.disabled = false;
                  }, 2000);
                  ui.notifications.error('Failed to save default border settings.');
                }
              });
              
              // Frame size control event handlers
              $html.find('.apply-frame').click(() => {
                const widthInput = $html.find('.frame-width')[0];
                const heightInput = $html.find('.frame-height')[0];
                
                if (widthInput && heightInput) {
                  const width = Math.max(50, Math.min(300, parseInt(widthInput.value) || 130));
                  const height = Math.max(50, Math.min(300, parseInt(heightInput.value) || 130));
                  
                  updateFrameSize(width, height);
                  
                  // Update dialog inputs to show constrained values
                  widthInput.value = width;
                  heightInput.value = height;
                  
                  // Update current frame variables
                  currentFrameWidth = width;
                  currentFrameHeight = height;
                }
              });
              
              // Square button functionality
              $html.find('.frame-square').click(() => {
                const widthInput = $html.find('.frame-width')[0];
                const heightInput = $html.find('.frame-height')[0];
                
                if (widthInput && heightInput) {
                  const size = Math.max(50, Math.min(300, parseInt(widthInput.value) || 130));
                  
                  updateFrameSize(size, size);
                  
                  widthInput.value = size;
                  heightInput.value = size;
                  
                  currentFrameWidth = size;
                  currentFrameHeight = size;
                }
              });
              
              // Reset frame button functionality
              $html.find('.frame-reset').click(() => {
                const defaultFrame = game.settings.get('osp-houserules', 'defaultPortraitFrame') || { width: 130, height: 130 };
                
                updateFrameSize(defaultFrame.width, defaultFrame.height);
                
                $html.find('.frame-width')[0].value = defaultFrame.width;
                $html.find('.frame-height')[0].value = defaultFrame.height;
                
                currentFrameWidth = defaultFrame.width;
                currentFrameHeight = defaultFrame.height;
              });
              
              // Frame size enter key handling
              $html.find('.frame-width, .frame-height').keypress((e) => {
                if (e.which === 13) { // Enter key
                  $html.find('.apply-frame').click();
                }
              });
              
              // Save frame default functionality
              $html.find('.save-frame-default').click(async () => {
                try {
                  const button = $html.find('.save-frame-default')[0];
                  const originalText = button.textContent;
                  button.textContent = '💾 SAVING...';
                  button.disabled = true;
                  
                  const width = currentFrameWidth;
                  const height = currentFrameHeight;
                  
                  // Show confirmation dialog
                  const confirmed = await Dialog.confirm({
                    title: "Save Frame Size as Default",
                    content: `<p>This will set the default frame size for all NEW characters:</p><ul><li>Width: ${width}px</li><li>Height: ${height}px</li></ul><p><strong>Existing characters will keep their current frame sizes unless reset.</strong></p>`,
                    yes: () => true,
                    no: () => false
                  });
                  
                  if (confirmed) {
                    await game.settings.set('osp-houserules', 'defaultPortraitFrame', {
                      width: width,
                      height: height,
                      timestamp: Date.now()
                    });
                    
                    button.textContent = '✓ SAVED!';
                    button.style.background = '#10b981';
                    setTimeout(() => {
                      button.textContent = originalText;
                      button.style.background = '#3b82f6';
                      button.disabled = false;
                    }, 2000);
                    
                    ui.notifications.info(`Default frame size saved: ${width}px x ${height}px`);
                    console.log('Default frame size saved:', { width, height });
                  } else {
                    button.textContent = originalText;
                    button.disabled = false;
                  }
                } catch (error) {
                  console.error('Failed to save default frame size:', error);
                  const button = $html.find('.save-frame-default')[0];
                  button.textContent = '❌ FAILED';
                  button.style.background = '#dc2626';
                  setTimeout(() => {
                    button.textContent = '💾 Save Frame Default';
                    button.style.background = '#3b82f6';
                    button.disabled = false;
                  }, 2000);
                  ui.notifications.error('Failed to save default frame size.');
                }
              });
              
              // Z-index control event handlers
              $html.find('.apply-zindex').click(() => {
                const zIndexInput = $html.find('.z-index')[0];
                
                if (zIndexInput) {
                  const zIndex = Math.max(-10, Math.min(50, parseInt(zIndexInput.value) || 5));
                  
                  updateZIndex(zIndex);
                  
                  // Update dialog input to show constrained value
                  zIndexInput.value = zIndex;
                  
                  // Update current z-index variable
                  currentZIndex = zIndex;
                }
              });
              
              // Z-index helper buttons
              $html.find('.z-behind').click(() => {
                updateZIndex(-1);
                $html.find('.z-index')[0].value = -1;
                currentZIndex = -1;
              });
              
              $html.find('.z-front').click(() => {
                updateZIndex(20);
                $html.find('.z-index')[0].value = 20;
                currentZIndex = 20;
              });
              
              $html.find('.z-reset').click(() => {
                const defaultPosition = game.settings.get('osp-houserules', 'defaultPortraitPosition') || { x: 25, y: 12, zIndex: 5 };
                const defaultZIndex = defaultPosition.zIndex || 5;
                
                updateZIndex(defaultZIndex);
                $html.find('.z-index')[0].value = defaultZIndex;
                currentZIndex = defaultZIndex;
              });
              
              // Z-index enter key handling
              $html.find('.z-index').keypress((e) => {
                if (e.which === 13) { // Enter key
                  $html.find('.apply-zindex').click();
                }
              });
              
              // Save z-index default functionality
              $html.find('.save-zindex-default').click(async () => {
                try {
                  const button = $html.find('.save-zindex-default')[0];
                  const originalText = button.textContent;
                  button.textContent = '💾 SAVING...';
                  button.disabled = true;
                  
                  const zIndex = currentZIndex;
                  
                  // Show confirmation dialog
                  const confirmed = await Dialog.confirm({
                    title: "Save Z-Index as Default",
                    content: `<p>This will set the default z-index for all NEW characters:</p><ul><li>Z-Index: ${zIndex}</li></ul><p><strong>Existing characters will keep their current z-index unless reset.</strong></p>`,
                    yes: () => true,
                    no: () => false
                  });
                  
                  if (confirmed) {
                    const currentDefaults = game.settings.get('osp-houserules', 'defaultPortraitPosition') || { x: 25, y: 12, zIndex: 5 };
                    await game.settings.set('osp-houserules', 'defaultPortraitPosition', {
                      x: currentDefaults.x,
                      y: currentDefaults.y,
                      zIndex: zIndex,
                      timestamp: Date.now()
                    });
                    
                    button.textContent = '✓ SAVED!';
                    button.style.background = '#10b981';
                    setTimeout(() => {
                      button.textContent = originalText;
                      button.style.background = '#dc2626';
                      button.disabled = false;
                    }, 2000);
                    
                    ui.notifications.info(`Default z-index saved: ${zIndex}`);
                    console.log('Default z-index saved:', zIndex);
                  } else {
                    button.textContent = originalText;
                    button.disabled = false;
                  }
                } catch (error) {
                  console.error('Failed to save default z-index:', error);
                  const button = $html.find('.save-zindex-default')[0];
                  button.textContent = '❌ FAILED';
                  button.style.background = '#7f1d1d';
                  setTimeout(() => {
                    button.textContent = '💾 Save Z-Index Default';
                    button.style.background = '#dc2626';
                    button.disabled = false;
                  }, 2000);
                  ui.notifications.error('Failed to save default z-index.');
                }
              });
              
              // Save as default functionality
              $html.find('.save-position-permanent').click(async () => {
                try {
                  const button = $html.find('.save-position-permanent')[0];
                  const originalText = button.textContent;
                  button.textContent = '💾 SAVING...';
                  button.disabled = true;
                  
                  // Show confirmation dialog
                  const confirmed = await Dialog.confirm({
                    title: "Save Portrait Position as Default",
                    content: `<p>This will set the default portrait position to X: ${currentX}, Y: ${currentY} for all NEW characters.</p><p><strong>Existing characters will keep their current positions unless reset.</strong></p>`,
                    yes: () => true,
                    no: () => false
                  });
                  
                  if (confirmed) {
                    await game.settings.set('osp-houserules', 'defaultPortraitPosition', {
                      x: currentX,
                      y: currentY,
                      timestamp: Date.now()
                    });
                    
                    button.textContent = '✓ SAVED!';
                    button.style.background = '#10b981';
                    setTimeout(() => {
                      button.textContent = originalText;
                      button.style.background = '#f59e0b';
                      button.disabled = false;
                    }, 2000);
                    
                    ui.notifications.info(`Default portrait position saved: X:${currentX}, Y:${currentY}`);
                    console.log('Default portrait position saved:', currentX, currentY);
                  } else {
                    button.textContent = originalText;
                    button.disabled = false;
                  }
                } catch (error) {
                  console.error('Failed to save default position:', error);
                  const button = $html.find('.save-position-permanent')[0];
                  button.textContent = '❌ FAILED';
                  button.style.background = '#dc2626';
                  setTimeout(() => {
                    button.textContent = '💾 SAVE AS DEFAULT';
                    button.style.background = '#f59e0b';
                    button.disabled = false;
                  }, 2000);
                  ui.notifications.error('Failed to save default portrait position.');
                }
              });
            }
          }, {
            width: 320,
            height: 680,
            resizable: true,
            top: 100,
            left: 200
          });
          
          positionDialog.render(true);
        }
        
        // Right-click to open positioning dialog - Enhanced with z-index debugging and global capture
        console.log('Adding contextmenu event listener to:', positionContainer);
        console.log('Container z-index:', positionContainer.style.zIndex);
        console.log('Container pointer-events:', window.getComputedStyle(positionContainer).pointerEvents);
        
        // Check for z-index blocking elements
        const staticHeader = document.querySelector('.static-header');
        if (staticHeader) {
          console.log('Static header z-index:', window.getComputedStyle(staticHeader).zIndex);
          console.log('Static header position:', window.getComputedStyle(staticHeader).position);
        }
        
        // Enhanced event handler function
        function handleRightClick(e, source) {
          console.log(`Right-click detected on ${source}!`, e);
          console.log('Event target:', e.target);
          console.log('Current target:', e.currentTarget);
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          
          if (positionDialog) {
            console.log('Closing existing dialog');
            positionDialog.close();
            positionDialog = null;
          } else {
            console.log('Opening positioning dialog');
            showPositionDialog();
          }
          console.log('Portrait positioning dialog toggled');
        }
        
        // Add to the container with multiple event listeners for better coverage
        positionContainer.addEventListener('contextmenu', (e) => handleRightClick(e, 'container'), true);
        positionContainer.addEventListener('contextmenu', (e) => handleRightClick(e, 'container-bubble'), false);
        
        // Also add to the character-image div
        const characterImage = positionContainer.querySelector('.character-image');
        if (characterImage) {
          console.log('Adding contextmenu event listener to character-image div:', characterImage);
          characterImage.addEventListener('contextmenu', (e) => handleRightClick(e, 'character-image'), true);
          characterImage.addEventListener('contextmenu', (e) => handleRightClick(e, 'character-image-bubble'), false);
        }
        
        // Also add to the portrait image directly
        const portraitImg = positionContainer.querySelector('.character-portrait');
        if (portraitImg) {
          console.log('Adding contextmenu event listener to portrait image:', portraitImg);
          portraitImg.addEventListener('contextmenu', (e) => handleRightClick(e, 'portrait-image'), true);
          portraitImg.addEventListener('contextmenu', (e) => handleRightClick(e, 'portrait-image-bubble'), false);
        } else {
          // Try alternative selectors for the image
          const altImg = positionContainer.querySelector('img');
          if (altImg) {
            console.log('Adding contextmenu event listener to alternative img:', altImg);
            altImg.addEventListener('contextmenu', (e) => handleRightClick(e, 'alt-image'), true);
            altImg.addEventListener('contextmenu', (e) => handleRightClick(e, 'alt-image-bubble'), false);
          }
        }
        
        // CRITICAL: Add global event listener to capture right-clicks on portrait area regardless of z-index
        document.addEventListener('contextmenu', (e) => {
          // Get portrait container bounds
          const containerRect = positionContainer.getBoundingClientRect();
          const clickX = e.clientX;
          const clickY = e.clientY;
          
          // Check if click is within portrait bounds
          const isWithinPortrait = clickX >= containerRect.left && 
                                  clickX <= containerRect.right && 
                                  clickY >= containerRect.top && 
                                  clickY <= containerRect.bottom;
          
          if (isWithinPortrait) {
            console.log('Global contextmenu captured for portrait area!');
            console.log('Click coordinates:', {x: clickX, y: clickY});
            console.log('Portrait bounds:', containerRect);
            console.log('Clicked element:', e.target);
            console.log('Portrait container element:', positionContainer);
            
            // Check if the clicked element is part of the portrait or blocking it
            const isPortraitElement = positionContainer.contains(e.target);
            const isStaticHeader = e.target.closest('.static-header');
            
            console.log('Is portrait element:', isPortraitElement);
            console.log('Is static header:', !!isStaticHeader);
            
            // Handle the right-click even if it hit a blocking element
            handleRightClick(e, 'global-portrait-area');
          }
        }, true);
        
        console.log('Contextmenu event listeners attached successfully');
        
        // Initialize position
        updatePosition(currentX, currentY);
        
        console.log('Portrait positioning system with moveable dialog initialized');
      }
      
      // Call the initialization function
      initializePortraitPositioning();
      
      // Ability Score Tooltips System
      const TOOLTIP_DELAY = 800; // Configurable delay in milliseconds
      
      const abilityScoreData = {
        "Strength": [
          { "score_range": "3", "melee": -3, "open_doors": "1-in-6" },
          { "score_range": "4-5", "melee": -2, "open_doors": "1-in-6" },
          { "score_range": "6-8", "melee": -1, "open_doors": "1-in-6" },
          { "score_range": "9-12", "melee": 0, "open_doors": "2-in-6" },
          { "score_range": "13-15", "melee": 1, "open_doors": "3-in-6" },
          { "score_range": "16-17", "melee": 2, "open_doors": "4-in-6" },
          { "score_range": "18", "melee": 3, "open_doors": "5-in-6" }
        ],
        "Intelligence": [
          { "score_range": "3", "languages": "Native (broken speech)", "literacy": "Illiterate" },
          { "score_range": "4-5", "languages": "Native", "literacy": "Illiterate" },
          { "score_range": "6-8", "languages": "Native", "literacy": "Basic" },
          { "score_range": "9-12", "languages": "Native", "literacy": "Literate" },
          { "score_range": "13-15", "languages": "Native +1 additional", "literacy": "Literate" },
          { "score_range": "16-17", "languages": "Native +2 additional", "literacy": "Literate" },
          { "score_range": "18", "languages": "Native +3 additional", "literacy": "Literate" }
        ],
        "Wisdom": [
          { "score_range": "3", "magic_saves": -3 },
          { "score_range": "4-5", "magic_saves": -2 },
          { "score_range": "6-8", "magic_saves": -1 },
          { "score_range": "9-12", "magic_saves": 0 },
          { "score_range": "13-15", "magic_saves": 1 },
          { "score_range": "16-17", "magic_saves": 2 },
          { "score_range": "18", "magic_saves": 3 }
        ],
        "Dexterity": [
          { "score_range": "3", "ac": -3, "missile": -3, "initiative": -2 },
          { "score_range": "4-5", "ac": -2, "missile": -2, "initiative": -1 },
          { "score_range": "6-8", "ac": -1, "missile": -1, "initiative": -1 },
          { "score_range": "9-12", "ac": 0, "missile": 0, "initiative": 0 },
          { "score_range": "13-15", "ac": 1, "missile": 1, "initiative": 1 },
          { "score_range": "16-17", "ac": 2, "missile": 2, "initiative": 1 },
          { "score_range": "18", "ac": 3, "missile": 3, "initiative": 2 }
        ],
        "Constitution": [
          { "score_range": "3", "hit_points": -3 },
          { "score_range": "4-5", "hit_points": -2 },
          { "score_range": "6-8", "hit_points": -1 },
          { "score_range": "9-12", "hit_points": 0 },
          { "score_range": "13-15", "hit_points": 1 },
          { "score_range": "16-17", "hit_points": 2 },
          { "score_range": "18", "hit_points": 3 }
        ],
        "Charisma": [
          { "score_range": "3", "npc_reactions": -2, "max_retainers": 1, "loyalty": 4 },
          { "score_range": "4-5", "npc_reactions": -1, "max_retainers": 2, "loyalty": 5 },
          { "score_range": "6-8", "npc_reactions": -1, "max_retainers": 3, "loyalty": 6 },
          { "score_range": "9-12", "npc_reactions": 0, "max_retainers": 4, "loyalty": 7 },
          { "score_range": "13-15", "npc_reactions": 1, "max_retainers": 5, "loyalty": 8 },
          { "score_range": "16-17", "npc_reactions": 1, "max_retainers": 6, "loyalty": 9 },
          { "score_range": "18", "npc_reactions": 2, "max_retainers": 7, "loyalty": 10 }
        ]
      };
      
      // Helper function to format modifier values
      function formatModifier(value) {
        if (typeof value === 'number') {
          return value > 0 ? `+${value}` : value.toString();
        }
        return value;
      }
      
      // Helper function to find score data based on ability score
      function getScoreData(abilityName, score) {
        const data = abilityScoreData[abilityName];
        if (!data) return null;
        
        for (const entry of data) {
          const range = entry.score_range;
          if (range.includes('-')) {
            const [min, max] = range.split('-').map(Number);
            if (score >= min && score <= max) return entry;
          } else {
            if (score === parseInt(range)) return entry;
          }
        }
        return null;
      }
      
      // Helper function to create tooltip content
      function createTooltipContent(abilityName, scoreData) {
        if (!scoreData) return '';
        
        const lines = [];
        
        if (abilityName === 'Strength') {
          lines.push(`Melee: ${formatModifier(scoreData.melee)}`);
          lines.push(`Open Doors: ${scoreData.open_doors}`);
        } else if (abilityName === 'Intelligence') {
          lines.push(`Languages: ${scoreData.languages}`);
          lines.push(`Literacy: ${scoreData.literacy}`);
        } else if (abilityName === 'Wisdom') {
          lines.push(`Magic Saves: ${formatModifier(scoreData.magic_saves)}`);
        } else if (abilityName === 'Dexterity') {
          lines.push(`AC: ${formatModifier(scoreData.ac)}`);
          lines.push(`Missile: ${formatModifier(scoreData.missile)}`);
          lines.push(`Initiative: ${formatModifier(scoreData.initiative)}`);
        } else if (abilityName === 'Constitution') {
          lines.push(`HP: ${formatModifier(scoreData.hit_points)}`);
        } else if (abilityName === 'Charisma') {
          lines.push(`NPC Reactions: ${formatModifier(scoreData.npc_reactions)}`);
          lines.push(`Max Retainers: ${scoreData.max_retainers}`);
          lines.push(`Loyalty: ${scoreData.loyalty}`);
        }
        
        return lines.join('<br>');
      }
      
      // Create tooltip element
      const tooltip = document.createElement('div');
      tooltip.id = 'ability-tooltip';
      tooltip.style.cssText = `
        position: absolute;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        line-height: 1.4;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        white-space: nowrap;
      `;
      document.body.appendChild(tooltip);
      
      let tooltipTimeout;
      
      // Setup tooltips for ability scores
      const abilityMappings = [
        { selector: '.attr-str', name: 'Strength' },
        { selector: '.attr-dex', name: 'Dexterity' },
        { selector: '.attr-con', name: 'Constitution' },
        { selector: '.attr-int', name: 'Intelligence' },
        { selector: '.attr-wis', name: 'Wisdom' },
        { selector: '.attr-cha', name: 'Charisma' }
      ];
      
      abilityMappings.forEach(({ selector, name }) => {
        const element = document.querySelector(selector);
        if (element) {
          element.addEventListener('mouseenter', (e) => {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
              const score = parseInt(element.value);
              const scoreData = getScoreData(name, score);
              const content = createTooltipContent(name, scoreData);
              
              if (content) {
                tooltip.innerHTML = content;
                
                // Position tooltip above the element
                const rect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                
                tooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
                tooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
                tooltip.style.opacity = '1';
              }
            }, TOOLTIP_DELAY);
          });
          
          element.addEventListener('mouseleave', () => {
            clearTimeout(tooltipTimeout);
            tooltip.style.opacity = '0';
          });
          
          // Update tooltip when value changes
          element.addEventListener('change', () => {
            if (tooltip.style.opacity === '1') {
              const score = parseInt(element.value);
              const scoreData = getScoreData(name, score);
              const content = createTooltipContent(name, scoreData);
              if (content) {
                tooltip.innerHTML = content;
              }
            }
          });
        }
      });

      // Saving Throw Tooltips System
      function initializeSavingThrowTooltips() {
        console.log('Initializing saving throw tooltips...');
        
        // Get character data
        const race = (document.querySelector('#char-race')?.value || '').toLowerCase().trim();
        const characterClass = (document.querySelector('#char-class')?.value || '').toLowerCase().trim();
        const conScore = parseInt(document.querySelector('[name="system.abilities.con.value"]')?.value) || 10;
        
        console.log(`Character: Race="${race}", Class="${characterClass}", CON=${conScore}`);
        
        // Check if character is an elf (race or class)
        const isElf = race === 'elf' || characterClass === 'elf';
        
        // Only show CON-based racial tooltips if race is different from class (race+class combo, not race-as-class)
        const showRacialBonuses = race && race !== characterClass;
        
        if (!showRacialBonuses && !isElf) {
          console.log('No tooltips needed');
          return;
        }
        
        // Calculate racial bonuses and special abilities
        function getRacialBonus(race, characterClass, saveType, conScore) {
          let bonus = 0;
          let description = '';
          
          // Elf paralysis immunity (works for race or class)
          const isElf = race === 'elf' || characterClass === 'elf';
          if (isElf && saveType === 'paralysis') {
            description = 'Unaffected by the paralysis that ghouls can inflict.';
            return { bonus, description };
          }
          
          // CON-based racial bonuses (only for race+class combinations, not race-as-class)
          if (!race || race === characterClass) {
            return { bonus, description };
          }
          
          if (race === 'dwarf') {
            if (saveType === 'death') { // Death Ray/Poison - only poison part
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Poison';
            } else if (saveType === 'wands' || saveType === 'spells') {
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Magic';
            }
          } else if (race === 'gnome') {
            if (saveType === 'wands' || saveType === 'spells') {
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Magic';
            }
          } else if (race === 'hobbit' || race === 'halfling') {
            if (saveType === 'death') { // Death Ray/Poison - only poison part
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Poison';
            } else if (saveType === 'wands' || saveType === 'spells') {
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Magic';
            }
          }
          
          return { bonus, description };
        }
        
        // Create tooltip element for saving throws
        let saveTooltip = document.getElementById('save-tooltip');
        if (!saveTooltip) {
          saveTooltip = document.createElement('div');
          saveTooltip.id = 'save-tooltip';
          saveTooltip.style.cssText = `
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.4;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
          `;
          document.body.appendChild(saveTooltip);
        }
        
        let saveTooltipTimeout;
        
        // Setup tooltips for each saving throw
        const saveTypes = ['death', 'wands', 'paralysis', 'breath', 'spells'];
        
        saveTypes.forEach(saveType => {
          const saveElement = document.querySelector(`.save-group-${saveType} .save span`);
          if (!saveElement) return;
          
          const racialData = getRacialBonus(race, characterClass, saveType, conScore);
          
          // Show tooltip if there's a racial bonus OR if it's elf paralysis immunity
          if (racialData.bonus > 0 || racialData.description) {
            console.log(`Adding tooltip to ${saveType}: ${racialData.description}`);
            
            saveElement.addEventListener('mouseenter', () => {
              clearTimeout(saveTooltipTimeout);
              saveTooltipTimeout = setTimeout(() => {
                saveTooltip.innerHTML = racialData.description;
                saveTooltip.style.opacity = '1';
                
                // Position tooltip above the saving throw circle
                const rect = saveElement.getBoundingClientRect();
                const tooltipRect = saveTooltip.getBoundingClientRect();
                
                saveTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
                saveTooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
              }, TOOLTIP_DELAY);
            });
            
            saveElement.addEventListener('mouseleave', () => {
              clearTimeout(saveTooltipTimeout);
              saveTooltip.style.opacity = '0';
            });
          }
        });
      }
      
      // Initialize saving throw tooltips after ability tooltips
      setTimeout(initializeSavingThrowTooltips, 100);

      // Dynamic Character Name Positioning and Sizing System
      function initializeCharacterNameSystem() {
        const nameInput = document.getElementById('char-name');
        const nameContainer = document.getElementById('character-name-container');
        
        if (!nameInput || !nameContainer) {
          console.log('Character name system: Required elements not found');
          return;
        }
        
        const DEFAULT_FONT_SIZE = 45;
        const MIN_FONT_SIZE = 24;
        const PORTRAIT_END = 155; // 25px left + 130px width
        const MAX_RIGHT_EDGE = 450; // Hard limit for right edge of name
        const MARGIN = 10;
        
        function updateCharacterNamePosition() {
          const textValue = nameInput.value || nameInput.placeholder || '';
          if (!textValue) return;
          
          let fontSize = DEFAULT_FONT_SIZE;
          let measuredWidth;
          
          // Create temporary span to measure text accurately
          const measurer = document.createElement('span');
          measurer.style.cssText = `
            position: absolute;
            visibility: hidden;
            white-space: nowrap;
            font-family: ${getComputedStyle(nameInput).fontFamily};
            font-weight: ${getComputedStyle(nameInput).fontWeight};
            padding: 6px;
            border: 1px solid transparent;
          `;
          document.body.appendChild(measurer);
          
          // Calculate maximum allowed width
          const maxAllowedWidth = MAX_RIGHT_EDGE - PORTRAIT_END - MARGIN;
          
          // Find the right font size
          do {
            measurer.style.fontSize = fontSize + 'px';
            measurer.textContent = textValue;
            measuredWidth = measurer.offsetWidth;
            
            if (measuredWidth <= maxAllowedWidth || fontSize <= MIN_FONT_SIZE) {
              break;
            }
            fontSize -= 1; // Reduce by 1px for finer control
          } while (fontSize >= MIN_FONT_SIZE);
          
          // Handle truncation if needed
          let finalText = textValue;
          if (measuredWidth > maxAllowedWidth && fontSize === MIN_FONT_SIZE) {
            // Truncate text to fit
            let testLength = textValue.length;
            while (testLength > 0) {
              finalText = textValue.substring(0, testLength) + '...';
              measurer.textContent = finalText;
              if (measurer.offsetWidth <= maxAllowedWidth) {
                break;
              }
              testLength--;
            }
            measuredWidth = measurer.offsetWidth;
          }
          
          document.body.removeChild(measurer);
          
          // Apply font size
          nameInput.style.fontSize = fontSize + 'px';
          
          // Position the name container
          const availableSpace = maxAllowedWidth;
          const centerPoint = PORTRAIT_END + MARGIN + (availableSpace / 2);
          let leftPosition = centerPoint - (measuredWidth / 2);
          
          // Ensure it doesn't go too far left or right
          const minLeft = PORTRAIT_END + MARGIN;
          const maxLeft = MAX_RIGHT_EDGE - measuredWidth;
          leftPosition = Math.max(minLeft, Math.min(leftPosition, maxLeft));
          
          nameContainer.style.left = leftPosition + 'px';
          
          // Apply truncation if needed
          if (finalText !== textValue) {
            nameInput.dataset.originalValue = textValue;
            nameInput.value = finalText;
          } else if (nameInput.dataset.originalValue) {
            delete nameInput.dataset.originalValue;
          }
          
          console.log(`Name: "${finalText}" | Font: ${fontSize}px | Width: ${measuredWidth}px | Position: ${leftPosition}px | Max allowed: ${maxAllowedWidth}px`);
        }
        
        // Event listeners
        nameInput.addEventListener('input', () => {
          // Restore original value if it was truncated
          if (nameInput.dataset.originalValue) {
            const cursorPos = nameInput.selectionStart;
            nameInput.value = nameInput.dataset.originalValue;
            nameInput.setSelectionRange(cursorPos, cursorPos);
            delete nameInput.dataset.originalValue;
          }
          updateCharacterNamePosition();
        });
        
        nameInput.addEventListener('blur', updateCharacterNamePosition);
        
        // Initial update
        setTimeout(updateCharacterNamePosition, 100);
        
        console.log('Character name positioning system initialized');
      }
      
      // Initialize the character name system
      setTimeout(initializeCharacterNameSystem, 200);
    }
    
    // Check if DOM is already ready or wait for it
    if (document.readyState === 'loading') {
      console.log('DOM still loading, waiting for DOMContentLoaded...');
      document.addEventListener('DOMContentLoaded', initializeCharacterSheet);
    } else {
      console.log('DOM already ready, initializing immediately...');
      // DOM is already ready, run immediately
      setTimeout(initializeCharacterSheet, 0);
    }
  </script>

  <!-- Portrait positioning wrapper - maintains same coordinate system as static-header -->
  <div style="position: absolute; top: 0; left: 0; width: 100%; height: 300px; pointer-events: none; z-index: 5;">
    <!-- Portrait container with independent z-index -->
  <div class="character-image-container char-field-group"
     style="position: absolute; pointer-events: auto;"
     data-x="{{#if system.portraitPosition.x}}{{system.portraitPosition.x}}{{else}}25{{/if}}"
     data-y="{{#if system.portraitPosition.y}}{{system.portraitPosition.y}}{{else}}12{{/if}}"
     data-z="{{#if system.portraitPosition.zIndex}}{{system.portraitPosition.zIndex}}{{else}}5{{/if}}">
      <div class="character-image"
           style="position: relative; border-radius: 9px; overflow: hidden;"
           data-width="{{#if system.portraitFrame.width}}{{system.portraitFrame.width}}{{else}}130{{/if}}"
           data-height="{{#if system.portraitFrame.height}}{{system.portraitFrame.height}}{{else}}130{{/if}}"
           data-border="{{#if system.portraitBorder.enabled}}{{#if system.portraitBorder.size}}{{system.portraitBorder.size}}{{else}}1{{/if}}px solid {{#if system.portraitBorder.color}}{{system.portraitBorder.color}}{{else}}#000{{/if}}{{else}}none{{/if}}">
        <script>
          // Set portrait frame and border dynamically (for template compatibility)
          (function() {
            const container = document.currentScript.parentElement;
            if (container) {
              const w = container.getAttribute('data-width');
              const h = container.getAttribute('data-height');
              const b = container.getAttribute('data-border');
              if (w) container.style.width = w + 'px';
              if (h) container.style.height = h + 'px';
              if (b) container.style.border = b;
            }
          })();
        </script>
        <img src="{{actor.img}}" alt="{{actor.name}}" title="{{actor.name}}"
             class="character-portrait" 
             style="position: absolute; width: 100%; height: 100%; object-fit: cover; transform-origin: top left; user-select: none; pointer-events: auto;" 
             draggable="false" />
      </div>
      
      <!-- Control buttons -->
      <div class="image-controls" style="position: absolute; top: -8px; right: -8px; display: none; gap: 4px;">
        <button type="button" class="reset-image" title="Reset Position & Size" style="width: 24px; height: 24px; border: none; border-radius: 50%; background: #4a5568; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">↻</button>
        <button type="button" class="fit-image" title="Fit to Container" style="width: 24px; height: 24px; border: none; border-radius: 50%; background: #4a5568; color: white; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;">⌂</button>
      </div>
    </div>
  </div>

  <!-- Static Header Section - Absolute Positioning Layout -->
  <div class="static-header" style="height: 300px; flex-shrink: 0; position: relative; z-index: 10; background: url('systems/osp-houserules/assets/character-sheet/main-sheet.webp') no-repeat left top !important; background-size: 100% auto !important; background-color: transparent !important; margin-top: 0 !important; padding-top: 0 !important;">

      <!-- Character Name - Centered positioning -->
  <div class="character-name-section" id="character-name-container"
    style="position: absolute; left: 44px; top: 14px; z-index: 10;">
  <input class="char-name" id="char-name" name="name" type="text" value="{{actor.name}}" style="text-align: center; font-size: 36px; background-color: transparent !important; box-shadow: none !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; display: flex; align-items: center; justify-content: center; padding: 3px; margin: 0; border-radius: 9px; font-weight: bold; border: 1px solid #000; outline: none; width: 320px; height: 44px;"/>
      </div>
      
  <!-- Hidden inputs for portrait position data -->
  <input type="hidden" name="system.portraitPosition.x" value="{{system.portraitPosition.x}}" />
  <input type="hidden" name="system.portraitPosition.y" value="{{system.portraitPosition.y}}" />
  <input type="hidden" name="system.portraitPosition.zIndex" value="{{system.portraitPosition.zIndex}}" />

  <!-- Hidden inputs for name position data -->
  <input type="hidden" name="system.namePosition.x" value="{{system.namePosition.x}}" />
  <input type="hidden" name="system.namePosition.y" value="{{system.namePosition.y}}" />
  <input type="hidden" name="system.namePosition.zIndex" value="{{system.namePosition.zIndex}}" />

  <!-- Hidden inputs for portrait border data -->
  <input type="hidden" name="system.portraitBorder.enabled" value="{{system.portraitBorder.enabled}}" />
  <input type="hidden" name="system.portraitBorder.size" value="{{system.portraitBorder.size}}" />
  <input type="hidden" name="system.portraitBorder.color" value="{{system.portraitBorder.color}}" />

  <!-- Hidden inputs for portrait frame size data -->
  <input type="hidden" name="system.portraitFrame.width" value="{{system.portraitFrame.width}}" />
  <input type="hidden" name="system.portraitFrame.height" value="{{system.portraitFrame.height}}" />
      
  <!-- Character Level - Absolute positioned -->
  <div class="level-progress-ring-container" id="level-container"
       style="position: absolute; width: 100px; height: 120px; left: 487px; top: 24px; z-index: 10;">
  <!-- Hidden inputs for level position data -->
  <input type="hidden" name="system.levelPosition.x" value="{{system.levelPosition.x}}" />
  <input type="hidden" name="system.levelPosition.y" value="{{system.levelPosition.y}}" />
  <input type="hidden" name="system.levelPosition.zIndex" value="{{system.levelPosition.zIndex}}" />
        <!-- Independent Curved Level Title -->
  <!-- Removed Level title -->
        
        <!-- SVG Progress Ring -->
        <svg width="100" height="120" style="position: absolute; top: 0; left: 0; transform: rotate(-90deg);">
          <!-- Background ring -->
          <circle cx="50" cy="60" r="32.5" fill="none" stroke="white" stroke-width="10" stroke-opacity="1" />
          <!-- Progress ring -->
          <circle cx="50" cy="60" r="32.5" fill="none" stroke="#22c55e" stroke-width="10" 
                  stroke-dasharray="204.2" stroke-dashoffset="204.2" 
                  class="level-progress-ring" 
                  style="transition: stroke-dashoffset 0.3s ease; stroke-opacity: 1;" />
          <!-- Outline ring - outer edge -->
          <circle cx="50" cy="60" r="37.5" fill="none" stroke="#000" stroke-width="1" stroke-opacity="0.75" />
          <!-- Outline ring - inner edge -->
          <circle cx="50" cy="60" r="27.5" fill="none" stroke="#000" stroke-width="1" stroke-opacity="0.75" />
        </svg>
        <!-- Center circle with inset shadow styling like Level field -->
        <div style="position: absolute; top: 32.5px; left: 22.5px; width: 55px; height: 55px; border-radius: 50%; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15); z-index: 11;"></div>
        <!-- Level display in center -->
        <div class="level-display" style="
          position: absolute; 
          top: 34px; 
          left: 21px; 
          width: 55px; 
          height: 55px; 
          font-size: 48px; 
          font-weight: bold; 
          color: #000; 
          cursor: pointer; 
          z-index: 12; 
          border-radius: 50%;
          line-height: 1;
          font-family: 'Minion Pro', serif;
          padding-top: 5px;
          text-align: center;
          box-sizing: border-box;
          background: transparent !important;
          box-shadow: none !important;
        " title="Award XP">{{system.level}}</div>
      </div>
      
  <!-- Character Class & Alignment - Centered under name as one element -->
  <!-- Character Class - Independent container for positioning -->
  <div class="class-group" id="class-container"
       style="position: absolute; left: 300px; top: 12px; z-index: 10;">
    <input type="hidden" name="system.classPosition.x" value="{{system.classPosition.x}}" />
    <input type="hidden" name="system.classPosition.y" value="{{system.classPosition.y}}" />
    <input type="hidden" name="system.classPosition.zIndex" value="{{system.classPosition.zIndex}}" />
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
  <select class="char-class" id="char-class" name="system.class" style="width: 140px; height: 34px; text-align: center; font-size: 24px; background-color: transparent !important; box-shadow: none !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 6px 5px 2px 5px; margin: 0; transform: translateY(4px); border-radius: 9px; font-weight: bold; overflow: visible; white-space: nowrap; text-overflow: clip;">
        <option value="Assassin" {{#if (eq system.class "Assassin")}}selected{{/if}}>Assassin</option>
        <option value="Barbarian" {{#if (eq system.class "Barbarian")}}selected{{/if}}>Barbarian</option>
        <option value="Bard" {{#if (eq system.class "Bard")}}selected{{/if}}>Bard</option>
        <option value="Beast Master" {{#if (eq system.class "Beast Master")}}selected{{/if}}>Beast Master</option>
        <option value="Cleric" {{#if (eq system.class "Cleric")}}selected{{/if}}>Cleric</option>
        <option value="Druid" {{#if (eq system.class "Druid")}}selected{{/if}}>Druid</option>
        <option value="Dwarf" {{#if (eq system.class "Dwarf")}}selected{{/if}}>Dwarf</option>
        <option value="Elf" {{#if (eq system.class "Elf")}}selected{{/if}}>Elf</option>
        <option value="Fighter" {{#if (eq system.class "Fighter")}}selected{{/if}}>Fighter</option>
        <option value="Gnome" {{#if (eq system.class "Gnome")}}selected{{/if}}>Gnome</option>
        <option value="Half-Elf" {{#if (eq system.class "Half-Elf")}}selected{{/if}}>Half-Elf</option>
        <option value="Half-Orc" {{#if (eq system.class "Half-Orc")}}selected{{/if}}>Half-Orc</option>
        <option value="Hobbit" {{#if (eq system.class "Hobbit")}}selected{{/if}}>Hobbit</option>
        <option value="Illusionist" {{#if (eq system.class "Illusionist")}}selected{{/if}}>Illusionist</option>
        <option value="Knight" {{#if (eq system.class "Knight")}}selected{{/if}}>Knight</option>
        <option value="Mage" {{#if (eq system.class "Mage")}}selected{{/if}}>Mage</option>
        <option value="Magic-User" {{#if (eq system.class "Magic-User")}}selected{{/if}}>Magic-User</option>
        <option value="Paladin" {{#if (eq system.class "Paladin")}}selected{{/if}}>Paladin</option>
        <option value="Ranger" {{#if (eq system.class "Ranger")}}selected{{/if}}>Ranger</option>
        <option value="Thief" {{#if (eq system.class "Thief")}}selected{{/if}}>Thief</option>
        <option value="Warden" {{#if (eq system.class "Warden")}}selected{{/if}}>Warden</option>
      </select>
    </div>
  </div>

  <!-- Character Alignment - Independent container for positioning -->
  <div class="alignment-group" id="alignment-container"
       style="position: absolute; left: 460px; top: 12px; z-index: 10;">
    <input type="hidden" name="system.alignmentPosition.x" value="{{system.alignmentPosition.x}}" />
    <input type="hidden" name="system.alignmentPosition.y" value="{{system.alignmentPosition.y}}" />
    <input type="hidden" name="system.alignmentPosition.zIndex" value="{{system.alignmentPosition.zIndex}}" />
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
  <select class="char-align" id="char-align" name="system.alignment" style="width: 100px; height: 34px; text-align: center; font-size: 24px; background-color: transparent !important; box-shadow: none !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 6px 5px 5px 5px; margin: 0; transform: translateY(4px); border-radius: 9px; font-weight: bold;">
        <option value="Chaotic" {{#if (eq system.alignment "Chaotic")}}selected{{/if}}>Chaotic</option>
        <option value="Lawful" {{#if (eq system.alignment "Lawful")}}selected{{/if}}>Lawful</option>
        <option value="Neutral" {{#if (eq system.alignment "Neutral")}}selected{{/if}}>Neutral</option>
      </select>
    </div>
  </div>
      
      <!-- Horizontal separator line at bottom of static header -->
      <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 1px; background-color: #000; z-index: 15;"></div>
      
    </div>

    <!-- Right-side Tab Navigation -->
    <nav class="sheet-tabs tabs" data-group="primary">
      <a class="item" data-tab="combat">Combat</a>
      <a class="item" data-tab="skills">Skills</a>
      <a class="item" data-tab="equipment">Equipment</a>
      <a class="item" data-tab="bio">Bio</a>
    </nav>

    <!-- Sheet Body - Tab Content Area -->
    <section class="sheet-body" style="position: absolute; top: 350px; left: 0; right: 0; bottom: 0; padding: 1rem 0.75rem; overflow-y: auto;">
      <!-- Combat Tab -->
      <div class="tab" data-group="primary" data-tab="combat">
        <div class="combat-section">
          <div class="combat-stats" style="display: flex; gap: 1.5rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap;">
            <div class="combat-stat" style="display: flex; flex-direction: column; align-items: center;">
              <label for="char-ac" style="margin-bottom: 0.5rem; font-size: 1.1rem;">Armor Class</label>
              <input class="char-ac" id="char-ac" name="system.ac" type="number" value="{{system.ac}}" min="0" max="20" style="width: 80px; height: 40px; text-align: center; font-size: 1.2rem; border: 2px solid #4a5568; border-radius: 8px; background-color: white;" />
            </div>
            <div class="combat-stat" style="display: flex; flex-direction: column; align-items: center;">
              <label style="margin-bottom: 0.5rem; font-size: 1.1rem;">Unarmored AC</label>
              <div style="width: 80px; height: 40px; text-align: center; font-size: 1.2rem; border: 2px solid #4a5568; border-radius: 8px; display: flex; align-items: center; justify-content: center; background-color: white;">
                {{unarmoredAC system.attributes.dex.value}}
              </div>
            </div>
            <div class="combat-stat" style="display: flex; flex-direction: column; align-items: center;">
              <label for="char-hp" style="margin-bottom: 0.5rem; font-size: 1.1rem;">Current HP</label>
              <input class="char-hp" id="char-hp" name="system.hitpoints" type="number" value="{{system.hitpoints}}" min="0" style="width: 80px; height: 40px; text-align: center; font-size: 1.2rem; border: 2px solid #4a5568; border-radius: 8px; background-color: white;" />
            </div>
            <div class="combat-stat" style="display: flex; flex-direction: column; align-items: center;">
              <label for="char-max-hp" style="margin-bottom: 0.5rem; font-size: 1.1rem;">Max HP</label>
              <input class="char-max-hp" id="char-max-hp" name="system.maxhitpoints" type="number" value="{{system.maxhitpoints}}" min="0" style="width: 80px; height: 40px; text-align: center; font-size: 1.2rem; border: 2px solid #4a5568; border-radius: 8px; background-color: white;" />
            </div>
          </div>

          <!-- Saving Throw Groups - Positioned relative to combat section -->
          <!-- Death Ray/Poison Group -->
          <div class="save-group-death" style="position: relative; display: inline-block; margin: 0 10px;">
            <div class="save death-save" style="position: relative; display: flex; flex-direction: column; align-items: center; width: 80px; height: 80px; overflow: visible;">
              <div style="width: 75px; height: 75px; border: 2px solid #4a5568; border-radius: 50%; position: relative; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);">
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) translateY(5px); font-size: 60px; font-weight: bold; line-height: 1; font-family: 'Minion Pro', serif; letter-spacing: -1px;">{{saves.death.value}}</span>
              </div>
            </div>
            <div class="save-label-death" style="position: absolute; left: -161px; top: 14px; width: 400px; height: 60px; overflow: visible; z-index: 15; pointer-events: none;">
              <svg width="400" height="60" style="overflow: visible;">
                <defs>
                  <path id="deathTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text style="font-family: 'Minion Pro', serif; font-size: 14px; font-weight: bold; fill: #000; letter-spacing: 0.5px;">
                  <textPath href="#deathTextPath" startOffset="50%" text-anchor="middle">
                    Death / Poison
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Wands Group -->
          <div class="save-group-wands" style="position: relative; display: inline-block; margin: 0 10px;">
            <div class="save wands-save" style="position: relative; display: flex; flex-direction: column; align-items: center; width: 80px; height: 80px; overflow: visible;">
              <div style="width: 75px; height: 75px; border: 2px solid #4a5568; border-radius: 50%; position: relative; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);">
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) translateY(5px); font-size: 60px; font-weight: bold; line-height: 1; font-family: 'Minion Pro', serif; letter-spacing: -1px;">{{saves.wands.value}}</span>
              </div>
            </div>
            <div class="save-label-wands" style="position: absolute; left: -161px; top: 14px; width: 400px; height: 60px; overflow: visible; z-index: 15; pointer-events: none;">
              <svg width="400" height="60" style="overflow: visible;">
                <defs>
                  <path id="wandsTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text style="font-family: 'Minion Pro', serif; font-size: 14px; font-weight: bold; fill: #000; letter-spacing: 0.8px;">
                  <textPath href="#wandsTextPath" startOffset="50%" text-anchor="middle">
                    Wands
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Paralysis Group -->
          <div class="save-group-paralysis" style="position: relative; display: inline-block; margin: 0 10px;">
            <div class="save paralysis-save" style="position: relative; display: flex; flex-direction: column; align-items: center; width: 80px; height: 80px; overflow: visible;">
              <div style="width: 75px; height: 75px; border: 2px solid #4a5568; border-radius: 50%; position: relative; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);">
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) translateY(5px); font-size: 60px; font-weight: bold; line-height: 1; font-family: 'Minion Pro', serif; letter-spacing: -1px;">{{saves.paralysis.value}}</span>
              </div>
            </div>
            <div class="save-label-paralysis" style="position: absolute; left: -161px; top: 14px; width: 400px; height: 60px; overflow: visible; z-index: 15; pointer-events: none;">
              <svg width="400" height="60" style="overflow: visible;">
                <defs>
                  <path id="paralysisTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text style="font-family: 'Minion Pro', serif; font-size: 14px; font-weight: bold; fill: #000; letter-spacing: 0.3px;">
                  <textPath href="#paralysisTextPath" startOffset="50%" text-anchor="middle">
                    Paralysis / Petrification
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Breath Attacks Group -->
          <div class="save-group-breath" style="position: relative; display: inline-block; margin: 0 10px;">
            <div class="save breath-save" style="position: relative; display: flex; flex-direction: column; align-items: center; width: 80px; height: 80px; overflow: visible;">
              <div style="width: 75px; height: 75px; border: 2px solid #4a5568; border-radius: 50%; position: relative; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);">
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) translateY(5px); font-size: 60px; font-weight: bold; line-height: 1; font-family: 'Minion Pro', serif; letter-spacing: -1px;">{{saves.breath.value}}</span>
              </div>
            </div>
            <div class="save-label-breath" style="position: absolute; left: -161px; top: 14px; width: 400px; height: 60px; overflow: visible; z-index: 15; pointer-events: none;">
              <svg width="400" height="60" style="overflow: visible;">
                <defs>
                  <path id="breathTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text style="font-family: 'Minion Pro', serif; font-size: 14px; font-weight: bold; fill: #000; letter-spacing: 0.8px;">
                  <textPath href="#breathTextPath" startOffset="50%" text-anchor="middle">
                    Breath Attacks
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Spells/Rods/Staves Group -->
          <div class="save-group-spells" style="position: relative; display: inline-block; margin: 0 10px;">
            <div class="save spells-save" style="position: relative; display: flex; flex-direction: column; align-items: center; width: 80px; height: 80px; overflow: visible;">
              <div style="width: 75px; height: 75px; border: 2px solid #4a5568; border-radius: 50%; position: relative; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);">
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) translateY(5px); font-size: 60px; font-weight: bold; line-height: 1; font-family: 'Minion Pro', serif; letter-spacing: -1px;">{{saves.spells.value}}</span>
              </div>
            </div>
            <div class="save-label-spells" style="position: absolute; left: -161px; top: 14px; width: 400px; height: 60px; overflow: visible; z-index: 15; pointer-events: none;">
              <svg width="400" height="60" style="overflow: visible;">
                <defs>
                  <path id="spellsTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text style="font-family: 'Minion Pro', serif; font-size: 14px; font-weight: bold; fill: #000; letter-spacing: 0.5px;">
                  <textPath href="#spellsTextPath" startOffset="50%" text-anchor="middle">
                    Spells / Rods / Staves
                  </textPath>
                </text>
              </svg>
            </div>
          </div>
        </div>
      </div>
      <!-- Skills Tab -->
  <div class="tab" data-group="primary" data-tab="skills" style="position: relative;">
        <!-- Ability Scores Section -->
        <div class="ability-scores-section" style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap;">
          
          <!-- STR Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Council', serif; letter-spacing: 0.03em;">STR</label>
            <select class="attr-str" id="attr-str" name="system.attributes.str.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: bold; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.str.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
          <!-- DEX Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Council', serif; letter-spacing: 0.03em;">DEX</label>
            <select class="attr-dex" id="attr-dex" name="system.attributes.dex.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: bold; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.dex.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
          <!-- CON Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Council', serif; letter-spacing: 0.03em;">CON</label>
            <select class="attr-con" id="attr-con" name="system.attributes.con.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: bold; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.con.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
          <!-- INT Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Council', serif; letter-spacing: 0.03em;">INT</label>
            <select class="attr-int" id="attr-int" name="system.attributes.int.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: bold; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.int.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
          <!-- WIS Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Council', serif; letter-spacing: 0.03em;">WIS</label>
            <select class="attr-wis" id="attr-wis" name="system.attributes.wis.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: bold; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.wis.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
          <!-- CHA Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Council', serif; letter-spacing: 0.03em;">CHA</label>
            <select class="attr-cha" id="attr-cha" name="system.attributes.cha.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: bold; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.cha.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
        </div>
        
        <!-- Additional Skills content can go here -->
        
      </div>
      <!-- Equipment Tab -->
      <div class="tab" data-group="primary" data-tab="equipment">
        <section class="equipment-tab">
          {{!-- Weapons Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Weapons</div>
              <div class="field-short">Damage</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="weapon" title="Add Weapon">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each weapons as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow {{#if item.isWeapon}}item-rollable{{/if}}">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.damage}}</div>
                  <div class="field-short">{{item.system.weight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-hand"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                  {{#if item.displayTags}}
                  <div class="item-tags">
                    {{#each item.displayTags as |tag|}}
                    <span class="tag">{{tag.value}}</span>
                    {{/each}}
                  </div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Armor Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Armor</div>
              <div class="field-short">AC</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="armor" title="Add Armor">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each armor as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.ac.value}}</div>
                  <div class="field-short">{{item.system.weight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-tshirt"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Containers Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Containers</div>
              <div class="field-short">Capacity</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="container" title="Add Container">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each containers as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.capacity.value}}/{{item.system.capacity.max}}</div>
                  <div class="field-short">{{item.system.weight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-hand"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- General Items Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Items</div>
              <div class="field-short">Qty</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="item" title="Add Item">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each items as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short quantity">
                    <input 
                      value="{{item.system.quantity.value}}" 
                      type="number" 
                      min="0" 
                      data-field="system.quantity.value"
                      data-item-id="{{item.id}}"
                    />
                    {{#if item.system.quantity.max}}
                    <span>/{{item.system.quantity.max}}</span>
                    {{/if}}
                  </div>
                  <div class="field-short">{{multiply item.system.weight item.system.quantity.value}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-hand"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Treasure Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Treasure</div>
              <div class="field-short">Value</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="item" data-treasure="true" title="Add Treasure">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each treasures as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.cumulativeCost}} gp</div>
                  <div class="field-short">{{item.system.cumulativeWeight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Encumbrance Bar --}}
          <section class="encumbrance-section">
            <div class="encumbrance-label">Encumbrance</div>
            <div class="encumbrance-bar-container">
              <div class="encumbrance-bar" data-encumbrance="{{encumbrancePercentage}}"></div>
              <span class="encumbrance-text">{{totalWeight}} / {{maxWeight}} lbs</span>
            </div>
          </section>
          </section>
        </div>

      <!-- Bio Tab -->
      <div class="tab" data-group="primary" data-tab="bio">
        <div class="bio-content" style="padding: 1rem; display: flex; flex-direction: column; gap: 1rem;">          <!-- Physical Characteristics Section -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Physical Characteristics</h3>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-start; padding: 10px;">
              <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center;">
                <label for="char-race" style="margin-bottom: 2px; text-align: center; font-size: 14px;">Race</label>
                <select class="char-race" id="char-race" name="system.race" style="width: 80px; height: 2.5em; text-align: center; background-color: white;">
                  <option value="Dwarf" {{#if (eq system.race "Dwarf")}}selected{{/if}}>Dwarf</option>
                  <option value="Elf" {{#if (eq system.race "Elf")}}selected{{/if}}>Elf</option>
                  <option value="Gnome" {{#if (eq system.race "Gnome")}}selected{{/if}}>Gnome</option>
                  <option value="Half-Elf" {{#if (eq system.race "Half-Elf")}}selected{{/if}}>Half-Elf</option>
                  <option value="Half-Orc" {{#if (eq system.race "Half-Orc")}}selected{{/if}}>Half-Orc</option>
                  <option value="Hobbit" {{#if (eq system.race "Hobbit")}}selected{{/if}}>Hobbit</option>
                  <option value="Human" {{#if (eq system.race "Human")}}selected{{/if}}>Human</option>
                </select>
              </div>
              <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center;">
                <label for="char-sex" style="margin-bottom: 2px; text-align: center; font-size: 14px;">Sex</label>
                <select class="char-sex" id="char-sex" name="system.sex" style="width: 70px; height: 2.5em; text-align: center; background-color: white;">
                  <option value="Male" {{#if (eq system.sex "Male")}}selected{{/if}}>Male</option>
                  <option value="Female" {{#if (eq system.sex "Female")}}selected{{/if}}>Female</option>
                  <option value="Other" {{#if (eq system.sex "Other")}}selected{{/if}}>Other</option>
                </select>
              </div>
              <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center;">
                <label for="char-age" style="margin-bottom: 2px; text-align: center; font-size: 14px;">Age</label>
                <input class="char-age" id="char-age" name="system.age" type="text" value="{{system.age}}" style="width: 60px; height: 2.5em; text-align: center; background-color: white;" />
              </div>
              <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center;">
                <label for="char-height" style="margin-bottom: 2px; text-align: center; font-size: 14px;">Height</label>
                <input class="char-height" id="char-height" name="system.height" type="text" value="{{system.height}}" style="width: 70px; height: 2.5em; text-align: center; background-color: white;" />
              </div>
              <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center;">
                <label for="char-weight" style="margin-bottom: 2px; text-align: center; font-size: 14px;">Weight</label>
                <input class="char-weight" id="char-weight" name="system.weight" type="text" value="{{system.weight}}" style="width: 70px; height: 2.5em; text-align: center; background-color: white;" />
              </div>
            </div>
          </div>
          
          <!-- Background and Languages Section -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Background & Languages</h3>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-start;">
              <!-- Background Field -->
              <div class="char-field-group" style="display: flex; flex-direction: column; align-items: flex-start;">
                <label for="char-background" style="margin-bottom: 0.5rem;">Background</label>
                <select class="char-background" id="char-background" name="system.background" style="width: 180px; height: 2.5em; text-align: left; font-size: 14px; padding: 0.25rem; background-color: white;">
                  <option value="" {{#unless system.background}}selected{{/unless}}>-- Select Background --</option>
                  <option value="Actor" {{#if (eq system.background "Actor")}}selected{{/if}}>Actor</option>
                  <option value="Armorer" {{#if (eq system.background "Armorer")}}selected{{/if}}>Armorer</option>
                  <option value="Artisan" {{#if (eq system.background "Artisan")}}selected{{/if}}>Artisan</option>
                  <option value="Baker" {{#if (eq system.background "Baker")}}selected{{/if}}>Baker</option>
                  <option value="Banker" {{#if (eq system.background "Banker")}}selected{{/if}}>Banker</option>
                  <option value="Barber" {{#if (eq system.background "Barber")}}selected{{/if}}>Barber</option>
                  <option value="Barkeep" {{#if (eq system.background "Barkeep")}}selected{{/if}}>Barkeep</option>
                  <option value="Beggar" {{#if (eq system.background "Beggar")}}selected{{/if}}>Beggar</option>
                  <option value="Blacksmith" {{#if (eq system.background "Blacksmith")}}selected{{/if}}>Blacksmith</option>
                  <option value="Bookbinder" {{#if (eq system.background "Bookbinder")}}selected{{/if}}>Bookbinder</option>
                  <option value="Bouncer" {{#if (eq system.background "Bouncer")}}selected{{/if}}>Bouncer</option>
                  <option value="Bowyer" {{#if (eq system.background "Bowyer")}}selected{{/if}}>Bowyer</option>
                  <option value="Brewer" {{#if (eq system.background "Brewer")}}selected{{/if}}>Brewer</option>
                  <option value="Bricklayer" {{#if (eq system.background "Bricklayer")}}selected{{/if}}>Bricklayer</option>
                  <option value="Butcher" {{#if (eq system.background "Butcher")}}selected{{/if}}>Butcher</option>
                  <option value="Caretaker" {{#if (eq system.background "Caretaker")}}selected{{/if}}>Caretaker</option>
                  <option value="Carpenter" {{#if (eq system.background "Carpenter")}}selected{{/if}}>Carpenter</option>
                  <option value="Cartographer" {{#if (eq system.background "Cartographer")}}selected{{/if}}>Cartographer</option>
                  <option value="Charcoal Maker" {{#if (eq system.background "Charcoal Maker")}}selected{{/if}}>Charcoal Maker</option>
                  <option value="Clerk" {{#if (eq system.background "Clerk")}}selected{{/if}}>Clerk</option>
                  <option value="Coachman" {{#if (eq system.background "Coachman")}}selected{{/if}}>Coachman</option>
                  <option value="Cobbler" {{#if (eq system.background "Cobbler")}}selected{{/if}}>Cobbler</option>
                  <option value="Cook" {{#if (eq system.background "Cook")}}selected{{/if}}>Cook</option>
                  <option value="Cooper" {{#if (eq system.background "Cooper")}}selected{{/if}}>Cooper</option>
                  <option value="Courier" {{#if (eq system.background "Courier")}}selected{{/if}}>Courier</option>
                  <option value="Crier" {{#if (eq system.background "Crier")}}selected{{/if}}>Crier</option>
                  <option value="Dairyboy" {{#if (eq system.background "Dairyboy")}}selected{{/if}}>Dairyboy</option>
                  <option value="Distiller" {{#if (eq system.background "Distiller")}}selected{{/if}}>Distiller</option>
                  <option value="Ditch Digger" {{#if (eq system.background "Ditch Digger")}}selected{{/if}}>Ditch Digger</option>
                  <option value="Dyer" {{#if (eq system.background "Dyer")}}selected{{/if}}>Dyer</option>
                  <option value="Engraver" {{#if (eq system.background "Engraver")}}selected{{/if}}>Engraver</option>
                  <option value="Entertainer" {{#if (eq system.background "Entertainer")}}selected{{/if}}>Entertainer</option>
                  <option value="Falconer" {{#if (eq system.background "Falconer")}}selected{{/if}}>Falconer</option>
                  <option value="Farmer" {{#if (eq system.background "Farmer")}}selected{{/if}}>Farmer</option>
                  <option value="Ferrier" {{#if (eq system.background "Ferrier")}}selected{{/if}}>Ferrier</option>
                  <option value="Fishmonger" {{#if (eq system.background "Fishmonger")}}selected{{/if}}>Fishmonger</option>
                  <option value="Fletcher" {{#if (eq system.background "Fletcher")}}selected{{/if}}>Fletcher</option>
                  <option value="Fuller" {{#if (eq system.background "Fuller")}}selected{{/if}}>Fuller</option>
                  <option value="Furrier" {{#if (eq system.background "Furrier")}}selected{{/if}}>Furrier</option>
                  <option value="Gardener" {{#if (eq system.background "Gardener")}}selected{{/if}}>Gardener</option>
                  <option value="Glassblower" {{#if (eq system.background "Glassblower")}}selected{{/if}}>Glassblower</option>
                  <option value="Glazier" {{#if (eq system.background "Glazier")}}selected{{/if}}>Glazier</option>
                  <option value="Glover" {{#if (eq system.background "Glover")}}selected{{/if}}>Glover</option>
                  <option value="Gong Farmer" {{#if (eq system.background "Gong Farmer")}}selected{{/if}}>Gong Farmer</option>
                  <option value="Gravedigger" {{#if (eq system.background "Gravedigger")}}selected{{/if}}>Gravedigger</option>
                  <option value="Groom" {{#if (eq system.background "Groom")}}selected{{/if}}>Groom</option>
                  <option value="Guard" {{#if (eq system.background "Guard")}}selected{{/if}}>Guard</option>
                  <option value="Hatmaker" {{#if (eq system.background "Hatmaker")}}selected{{/if}}>Hatmaker</option>
                  <option value="Herdsman" {{#if (eq system.background "Herdsman")}}selected{{/if}}>Herdsman</option>
                  <option value="Houndsman" {{#if (eq system.background "Houndsman")}}selected{{/if}}>Houndsman</option>
                  <option value="Innkeeper" {{#if (eq system.background "Innkeeper")}}selected{{/if}}>Innkeeper</option>
                  <option value="Jailer" {{#if (eq system.background "Jailer")}}selected{{/if}}>Jailer</option>
                  <option value="Jester" {{#if (eq system.background "Jester")}}selected{{/if}}>Jester</option>
                  <option value="Joiner" {{#if (eq system.background "Joiner")}}selected{{/if}}>Joiner</option>
                  <option value="Juggler" {{#if (eq system.background "Juggler")}}selected{{/if}}>Juggler</option>
                  <option value="Laborer" {{#if (eq system.background "Laborer")}}selected{{/if}}>Laborer</option>
                  <option value="Launderer" {{#if (eq system.background "Launderer")}}selected{{/if}}>Launderer</option>
                  <option value="Lector" {{#if (eq system.background "Lector")}}selected{{/if}}>Lector</option>
                  <option value="Librarian" {{#if (eq system.background "Librarian")}}selected{{/if}}>Librarian</option>
                  <option value="Lumberjack" {{#if (eq system.background "Lumberjack")}}selected{{/if}}>Lumberjack</option>
                  <option value="Maid/Butler" {{#if (eq system.background "Maid/Butler")}}selected{{/if}}>Maid/Butler</option>
                  <option value="Mason" {{#if (eq system.background "Mason")}}selected{{/if}}>Mason</option>
                  <option value="Merchant" {{#if (eq system.background "Merchant")}}selected{{/if}}>Merchant</option>
                  <option value="Messenger" {{#if (eq system.background "Messenger")}}selected{{/if}}>Messenger</option>
                  <option value="Miller" {{#if (eq system.background "Miller")}}selected{{/if}}>Miller</option>
                  <option value="Millwright" {{#if (eq system.background "Millwright")}}selected{{/if}}>Millwright</option>
                  <option value="Mortician" {{#if (eq system.background "Mortician")}}selected{{/if}}>Mortician</option>
                  <option value="Musician" {{#if (eq system.background "Musician")}}selected{{/if}}>Musician</option>
                  <option value="Ne'er-do-well" {{#if (eq system.background "Ne'er-do-well")}}selected{{/if}}>Ne'er-do-well</option>
                  <option value="Page" {{#if (eq system.background "Page")}}selected{{/if}}>Page</option>
                  <option value="Painter" {{#if (eq system.background "Painter")}}selected{{/if}}>Painter</option>
                  <option value="Philosopher" {{#if (eq system.background "Philosopher")}}selected{{/if}}>Philosopher</option>
                  <option value="Porter" {{#if (eq system.background "Porter")}}selected{{/if}}>Porter</option>
                  <option value="Potter" {{#if (eq system.background "Potter")}}selected{{/if}}>Potter</option>
                  <option value="Printer" {{#if (eq system.background "Printer")}}selected{{/if}}>Printer</option>
                  <option value="Prostitute" {{#if (eq system.background "Prostitute")}}selected{{/if}}>Prostitute</option>
                  <option value="Rag & Bone" {{#if (eq system.background "Rag & Bone")}}selected{{/if}}>Rag & Bone</option>
                  <option value="Ratter" {{#if (eq system.background "Ratter")}}selected{{/if}}>Ratter</option>
                  <option value="Runaway Slave" {{#if (eq system.background "Runaway Slave")}}selected{{/if}}>Runaway Slave</option>
                  <option value="Scavenger" {{#if (eq system.background "Scavenger")}}selected{{/if}}>Scavenger</option>
                  <option value="Scholar" {{#if (eq system.background "Scholar")}}selected{{/if}}>Scholar</option>
                  <option value="Serf" {{#if (eq system.background "Serf")}}selected{{/if}}>Serf</option>
                  <option value="Server" {{#if (eq system.background "Server")}}selected{{/if}}>Server</option>
                  <option value="Sexton" {{#if (eq system.background "Sexton")}}selected{{/if}}>Sexton</option>
                  <option value="Squire" {{#if (eq system.background "Squire")}}selected{{/if}}>Squire</option>
                  <option value="Stablehand" {{#if (eq system.background "Stablehand")}}selected{{/if}}>Stablehand</option>
                  <option value="Stonecutter" {{#if (eq system.background "Stonecutter")}}selected{{/if}}>Stonecutter</option>
                  <option value="Street Sweeper" {{#if (eq system.background "Street Sweeper")}}selected{{/if}}>Street Sweeper</option>
                  <option value="Tailor" {{#if (eq system.background "Tailor")}}selected{{/if}}>Tailor</option>
                  <option value="Tallow Chandler" {{#if (eq system.background "Tallow Chandler")}}selected{{/if}}>Tallow Chandler</option>
                  <option value="Tanner" {{#if (eq system.background "Tanner")}}selected{{/if}}>Tanner</option>
                  <option value="Thatcher" {{#if (eq system.background "Thatcher")}}selected{{/if}}>Thatcher</option>
                  <option value="Tobacconist" {{#if (eq system.background "Tobacconist")}}selected{{/if}}>Tobacconist</option>
                  <option value="Trapper" {{#if (eq system.background "Trapper")}}selected{{/if}}>Trapper</option>
                  <option value="Wainwright" {{#if (eq system.background "Wainwright")}}selected{{/if}}>Wainwright</option>
                  <option value="Washer" {{#if (eq system.background "Washer")}}selected{{/if}}>Washer</option>
                  <option value="Weaver" {{#if (eq system.background "Weaver")}}selected{{/if}}>Weaver</option>
                  <option value="Wheelwright" {{#if (eq system.background "Wheelwright")}}selected{{/if}}>Wheelwright</option>
                  <option value="Winemaker" {{#if (eq system.background "Winemaker")}}selected{{/if}}>Winemaker</option>
                  <option value="Woodcutter" {{#if (eq system.background "Woodcutter")}}selected{{/if}}>Woodcutter</option>
                </select>
              </div>
              
              <!-- Languages Field -->
              <div class="char-field-group" style="display: flex; flex-direction: column; align-items: flex-start;">
                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 0.5rem;">
                  <label for="char-languages">Languages</label>
                  <button type="button" class="open-language-dialog" title="Add Language"></button>
                </div>
                <div class="languages-row" style="border: 1px solid #ccc; border-radius: 3px; padding: 0.5rem; width: 100%; background-color: white;">
                  <div class="languages-tags"></div>
                </div>
                <input type="hidden" name="system.languages" class="char-languages" value="{{system.languages}}" />
              </div>
            </div>
          </div>
          
          <!-- Character Appearance -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Appearance</h3>
            <textarea name="system.bio.appearance" placeholder="Describe your character's physical appearance..." 
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px; resize: vertical; font-family: inherit; background-color: white;">{{system.bio.appearance}}</textarea>
          </div>

          <!-- Character Personality -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Personality</h3>
            <textarea name="system.bio.personality" placeholder="Describe your character's personality, traits, and mannerisms..." 
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px; resize: vertical; font-family: inherit; background-color: white;">{{system.bio.personality}}</textarea>
          </div>

          <!-- Character Background/History -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Background & History</h3>
            <textarea name="system.bio.history" placeholder="Tell your character's story, background, and important life events..." 
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px; resize: vertical; font-family: inherit; background-color: white;">{{system.bio.history}}</textarea>
          </div>

          <!-- Character Goals & Motivations -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Goals & Motivations</h3>
            <textarea name="system.bio.goals" placeholder="What drives your character? What are their goals and motivations..." 
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px; resize: vertical; font-family: inherit; background-color: white;">{{system.bio.goals}}</textarea>
          </div>

          <!-- Additional Notes -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Additional Notes</h3>
            <textarea name="system.bio.notes" placeholder="Any additional notes, relationships, or important details..." 
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px; resize: vertical; font-family: inherit; background-color: white;">{{system.bio.notes}}</textarea>
          </div>

        </div>
      </div>
    </section>
</form>