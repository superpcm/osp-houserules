<form class="osp sheet actor character" autocomplete="off" style="height: 700px; position: relative; overflow: visible; font-family: 'Minion Pro', serif; font-weight: normal; width: 600px; background: white; background-color: white;">
  <style>
    /* White Background Override - Apply to entire sheet and window */
    form.osp.sheet.actor.character,
    .osp.sheet.actor.character,
    .application.window-app.sheet.actor.character.osp,
    .application.window-app.sheet.actor.character.osp .window-content,
    .window-content form.osp.sheet.actor.character,
    .window-content .osp.sheet.actor.character,
    .window-content .window-content form.osp.sheet.actor.character,
    .osp .window-content {
      background: white !important;
      background-color: white !important;
      background-image: none !important;
    }
    
    /* Single Background Image System - Applied to window instead of form */
    form.osp.sheet.actor.character {
      position: relative;
    }
    
    /* Override any Foundry default backgrounds */
    .osp.sheet.actor.character,
    .application.window-app.sheet.actor.character.osp,
    .window-content form.osp.sheet.actor.character,
    .window-content .osp.sheet.actor.character,
    .window-content .window-content form.osp.sheet.actor.character {
      background: white !important;
      background-color: white !important;
      background-image: none !important;
    }
    
    /* Ensure the application window allows tabs to extend beyond right edge */
    .application.window-app.sheet.actor.character.osp {
      overflow: visible !important; /* Allow tabs to extend beyond window */
    }
    
    /* Also override the window content wrapper */
    .application.window-app.sheet.actor.character.osp .window-content,
    .osp .window-content {
      background: white !important;
      background-color: white !important;
      background-image: none !important;
      padding: 0 !important;
      overflow: visible !important; /* Allow tabs to show beyond content area */
    }
    
    /* Black title bar for character sheet window */
    .application.window-app.sheet.actor.character.osp .window-header,
    .osp .window-header {
      background: black !important;
      background-color: black !important;
      border-bottom: 1px solid #333 !important;
    }
    
    /* Ensure title text is visible on black background */
    .application.window-app.sheet.actor.character.osp .window-header .window-title,
    .osp .window-header .window-title {
      color: white !important;
    }
    
    /* Style the window controls (close, minimize, etc.) for black background */
    .application.window-app.sheet.actor.character.osp .window-header .header-button,
    .osp .window-header .header-button {
      color: white !important;
    }
    
    .application.window-app.sheet.actor.character.osp .window-header .header-button:hover,
    .osp .window-header .header-button:hover {
      background: rgba(255, 255, 255, 0.2) !important;
    }
    

    /* XP progress bar should be visible with different color */
    form.osp.sheet.actor.character .xp-progress-bar,
    .osp.sheet.actor.character .xp-progress-bar {
      background-color: #4a90e2 !important;
    }
    
    /* Static header background image override - use existing file */
    form.osp.sheet.actor.character .static-header {
  background: url('systems/osp-houserules/assets/character-sheet/main-sheet.webp') no-repeat !important;
  background-position: left top !important;
  background-size: contain !important;
  background-color: transparent !important;
  margin-top: 0 !important;
  padding-top: 0 !important;
      background-color: transparent !important;
    }
    
    /* Tab system styles - Individual absolute positioned tabs */
    .sheet-tabs {
      position: absolute;
      left: 600px; /* Position tabs to extend from right edge */
      top: 50px; /* Starting position */
      width: 30px; /* Container width */
      height: 400px; /* Container height to accommodate all tabs */
      z-index: -1; /* Behind other content */
      pointer-events: auto;
    }
    
    /* Remove all shadow effects from Height and Weight fields */
    .char-height, .char-weight {
      box-shadow: none !important;
      -webkit-box-shadow: none !important;
      -moz-box-shadow: none !important;
      text-shadow: none !important;
      filter: none !important;
      background: transparent !important;
      background-color: transparent !important;
      background-image: none !important;
      outline: none !important;
      border: none !important;
      border-radius: 0 !important;
    }
    
    /* Remove shadows from Height and Weight containers */
    .height-group, .weight-group {
      box-shadow: none !important;
      -webkit-box-shadow: none !important;
      -moz-box-shadow: none !important;
      filter: none !important;
      background: transparent !important;
      background-color: transparent !important;
      background-image: none !important;
      border: none !important;
      border-radius: 0 !important;
      outline: none !important;
    }
    
    /* Override any border styles on HandW field */
    .char-handw, .handw-group {
      border: none !important;
      border-width: 0 !important;
      border-style: none !important;
      border-color: transparent !important;
      outline: none !important;
      box-sizing: border-box !important;
    }
    
    /* Remove shadows from Height and Weight field groups */
    .height-group .char-field-group, .weight-group .char-field-group {
      box-shadow: none !important;
      -webkit-box-shadow: none !important;
      -moz-box-shadow: none !important;
      filter: none !important;
      background: transparent !important;
      background-color: transparent !important;
      background-image: none !important;
      border: none !important;
      border-radius: 0 !important;
      outline: none !important;
    }

    .sheet-tabs a.item {
      position: absolute;
      width: 32px; /* Tab width (becomes height after rotation) */
      height: 80px; /* Tab height (becomes width after rotation) */
      background: #b5dcb8; /* Matching green background */
      border: 1px solid #8b7355;
      color: #4a3a1a;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Minion Pro', serif;
      font-size: 15px;
      cursor: pointer;
      user-select: none;
      border-radius: 0 10px 10px 0;
      transform-origin: center center;
      transition: all 0.2s ease;
      writing-mode: vertical-rl; /* Rotate text 90 degrees */
      text-orientation: mixed; /* Keep letters upright */
      
      /* Remove any default focus/outline styles */
      outline: none !important;
      /* Remove any text shadows */
      text-shadow: none !important;
      
      /* Shading for inactive tabs */
      box-shadow: inset 0 0 0 1000px rgba(139, 115, 85, 0.3); /* Brown overlay for inactive state */
      opacity: 0.7; /* Slightly reduce overall opacity */
    }

    /* Remove red highlighting on focus */
    .sheet-tabs a.item:focus {
      outline: none !important;
      text-shadow: none !important;
      box-shadow: inset 0 0 0 1000px rgba(139, 115, 85, 0.3); /* Maintain same styling as default */
    }

    /* Position each tab individually with precise spacing - using negative values to align left edges */
    .sheet-tabs a.item:nth-child(1) { top: -215px; left: 0px; } /* Combat tab */
    .sheet-tabs a.item:nth-child(2) { top: -135px; left: -31px; } /* Skills tab - move further left */
    .sheet-tabs a.item:nth-child(3) { top: -55px; left: -64px; } /* Equipment tab - move even further left */
    .sheet-tabs a.item:nth-child(4) { top: 25px; left: -96px; } /* Bio tab - move furthest left */

    .sheet-tabs a.item:hover {
      background: #a0d1a3; /* Slightly darker green on hover */
      color: #3a2915; /* Darker brown */
      border-color: #6b4112; /* Darker brown border */
      text-shadow: none !important; /* Remove any text shadows */
      /* Reduce shading on hover to show interaction */
      box-shadow: inset 0 0 0 1000px rgba(139, 115, 85, 0.15); /* Lighter brown overlay */
      opacity: 0.9; /* Slightly higher opacity on hover */
    }

    .sheet-tabs a.item.active {
      background: #c9e7cc; /* Lighter green background for active tab */
      color: #2d1f0f; /* Darkest brown text */
      border-color: #5a3508; /* Darkest border */
      text-shadow: none !important; /* Remove any text shadows */
      /* Remove shading for active tab */
      box-shadow: none; /* No overlay for active state */
      opacity: 1; /* Full opacity for active tab */
      /* Add slight inset shadow for depth */
      box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1);
      z-index: 1; /* Bring active tab forward */
    }
    .sheet-body .tab {
      display: none;
    }
    .sheet-body .tab.active {
      display: block;
    }
    /* Ensure tab container doesn't block clicks */
    .sheet-tabs {
      position: relative;
      z-index: 10;
    }
    /* XP Award Button Hover Effect */
    button.xp-award-btn {
      color: #333 !important;
      background: none !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
    }
    button.xp-award-btn:hover {
      color: #dc2626 !important;
      background: none !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
    }
    button.xp-award-btn:focus {
      color: #dc2626 !important;
      outline: none !important;
      box-shadow: none !important;
      background: none !important;
      border: none !important;
    }

    /* Language tag styling */
    .languages-tags .lang-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #e0e0e0;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: normal;
      color: black !important;
      pointer-events: auto;
    }

    .languages-tags .lang-tag button.remove-lang {
      background: none;
      border: none;
      color: black !important;
      cursor: pointer;
      width: auto;
      height: auto;
      padding: 0 2px;
      font-size: 14px;
      line-height: 1;
      pointer-events: auto;
      z-index: 102;
    }

    .languages-tags .lang-tag button.remove-lang:hover {
      color: black !important;
      background: rgba(0, 0, 0, 0.1);
    }

    .languages-row.open-language-dialog {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }

    .languages-row.open-language-dialog:hover {
      background-color: transparent !important;
      border: none !important;
      box-shadow: none !important;
      color: black !important;
    }

    .languages-tags {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      color: black !important;
      font-weight: normal !important;
    }

    .languages-tags:hover {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      color: black !important;
    }

    .languages-row.open-language-dialog:empty::before {
      content: "Click to add languages...";
      color: black !important;
      font-style: italic;
      font-size: 12px;
    }

    /* Remove any + sign from languages field */
    .languages-row::before,
    .languages-row::after,
    .languages-tags::before,
    .languages-tags::after,
    .open-language-dialog::before,
    .open-language-dialog::after {
      content: none !important;
    }

    .languages-row .fa-plus,
    .languages-tags .fa-plus,
    .open-language-dialog .fa-plus {
      display: none !important;
    }

    /* Languages field positioning and centering variables */
    :root {
      --languages-horizontal-offset: 0px;
      --languages-vertical-offset: 0px;
      --languages-font-size: 24px;
      --languages-min-font-size: 10px;
      --languages-line-height: 1;
      --languages-letter-spacing: 0px;
    }

    .languages-tags {
      transform: translate(var(--languages-horizontal-offset), var(--languages-vertical-offset));
      font-size: var(--languages-font-size);
      line-height: var(--languages-line-height);
      letter-spacing: var(--languages-letter-spacing);
    }

    /* Ensure languages field starts with correct font size */
    .languages-tags:not([style*="font-size"]) {
      font-size: 24px !important;
    }
    
    /* Portrait transform system for end-user adjustment */
    .portrait-img {
      transform: scale(var(--user-portrait-scale, 1)) 
                 translate(var(--user-portrait-x, 0px), var(--user-portrait-y, 0px));
      transform-origin: center center;
      transition: transform 0.2s ease;
    }
    
    /* Portrait adjustment controls */
    .portrait-controls {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 5px;
      background: rgba(0,0,0,0.95);
      color: white;
      padding: 3px;
      border-radius: 3px;
      display: none;
      z-index: 1000;
      font-size: 10px;
      white-space: nowrap;
      border: 1px solid #666;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    /* Force controls to stay visible when shown */
    .portrait-controls[style*="display: block"] {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .portrait-controls button {
      background: #555;
      color: white;
      border: 1px solid #777;
      padding: 2px 4px;
      margin: 1px;
      border-radius: 2px;
      cursor: pointer;
      font-size: 10px;
      width: 18px;
      height: 18px;
      line-height: 14px;
      display: inline-block;
      text-align: center;
      vertical-align: middle;
      box-sizing: border-box;
    }
    
    .portrait-controls button:hover {
      background: #777;
      border-color: #999;
    }
    
    .portrait-controls button:active {
      background: #333;
    }
    
    .portrait-controls .btn-group {
      display: inline-block;
      margin: 0 2px;
      vertical-align: top;
    }
    
    .portrait-controls .btn-group:not(:last-child) {
      border-right: 1px solid #777;
      padding-right: 3px;
    }
    
    .portrait-container.adjusting {
      outline: 1px dashed #00aaff;
      overflow: visible !important;
      z-index: 1001 !important;
    }
  </style>
  <script>
    console.log('Character sheet script loaded');
    
    // Function to update XP Modifier display
    function updateXPModifier() {
      const xpModField = document.getElementById('xp-mod-display');
      if (!xpModField) return;
      
      // Get current character data from form fields
      const characterClass = document.querySelector('.char-class')?.value || '';
      const attributes = {
        str: { value: parseInt(document.querySelector('.attr-str')?.value) || 10 },
        dex: { value: parseInt(document.querySelector('.attr-dex')?.value) || 10 },
        con: { value: parseInt(document.querySelector('.attr-con')?.value) || 10 },
        int: { value: parseInt(document.querySelector('.attr-int')?.value) || 10 },
        wis: { value: parseInt(document.querySelector('.attr-wis')?.value) || 10 },
        cha: { value: parseInt(document.querySelector('.attr-cha')?.value) || 10 }
      };
      
      // Calculate XP modifier using the same logic as the system
      const xpMod = calculateXPModifier(characterClass, attributes);
      
      // Format and display the modifier
      const formattedMod = xpMod >= 0 ? `+${xpMod}%` : `${xpMod}%`;
      xpModField.value = formattedMod;
    }
    
    // Function to format numbers with commas
    function formatNumberWithCommas(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Function to update XP display
    function updateXPDisplay() {
      const xpField = document.getElementById('xp-display');
      if (!xpField) return;
      
      // Check if we're in the middle of an XP update by our handler
      // If so, don't interfere with the display
      if (window.xpHandlerUpdating) return;
      
      // Only format if not currently focused (to avoid interfering with user input)
      if (document.activeElement !== xpField) {
        const currentXP = parseInt(xpField.value.replace(/,/g, '')) || 0;
        xpField.value = formatNumberWithCommas(currentXP);
      }
    }
    
    // Function to handle XP field formatting
    function setupXPFieldFormatting() {
      const xpField = document.getElementById('xp-display');
      if (!xpField) return;
      
      // Create a function to clean XP field value before any form operation
      function cleanXPFieldForSubmission() {
        if (xpField && xpField.value) {
          const cleanValue = xpField.value.replace(/,/g, '');
          if (cleanValue !== xpField.value) {
            console.log('Cleaning XP field before form operation: from', xpField.value, 'to', cleanValue);
            xpField.value = cleanValue;
          } else {
            console.log('XP field already clean:', xpField.value);
          }
        } else {
          console.log('XP field not found or empty during clean attempt');
        }
      }
      
      // Function to restore XP formatting after form operations
      function restoreXPFormatting() {
        if (xpField && xpField.value && !xpField.value.includes(',')) {
          const numericValue = parseInt(xpField.value) || 0;
          if (numericValue >= 1000) { // Only format numbers 1000 and above
            const formattedValue = numericValue.toLocaleString();
            console.log('Restoring XP formatting: from', xpField.value, 'to', formattedValue);
            xpField.value = formattedValue;
          }
        }
      }
      
      // Add comprehensive debugging for XP field changes
      const logXPFieldState = (context) => {
        if (xpField) {
          console.log(`XP Field State (${context}):`, {
            value: xpField.value,
            name: xpField.name,
            focused: document.activeElement === xpField,
            timestamp: new Date().toISOString()
          });
        }
      };
      
      // Add form submission handler to remove commas from XP field
      const form = xpField.closest('form');
      if (form) {
        console.log('Setting up comprehensive XP field protection...');
        
        // Handle form submit events
        form.addEventListener('submit', function(e) {
          console.log('Form submit event - preparing XP field for submission');
          isFormSubmitting = true;
          logXPFieldState('form submit');
          cleanXPFieldForSubmission();
          // Re-enable formatting after submission completes
          setTimeout(() => {
            isFormSubmitting = false;
            restoreXPFormatting();
          }, 100);
        });
        
        // Handle change events that might trigger auto-save
        form.addEventListener('change', function(e) {
          console.log('Form change event - preparing XP field, target:', e.target.name);
          isFormSubmitting = true;
          logXPFieldState('form change');
          cleanXPFieldForSubmission();
          // Re-enable formatting after change completes
          setTimeout(() => {
            isFormSubmitting = false;
            restoreXPFormatting();
          }, 100);
        });
        
        // Also handle input events that might trigger form processing
        form.addEventListener('input', function(e) {
          if (e.target !== xpField) { // Don't interfere with XP field's own input handling
            console.log('Form input event - preparing XP field, target:', e.target.name);
            isFormSubmitting = true;
            logXPFieldState('form input');
            cleanXPFieldForSubmission();
            // Re-enable formatting after input completes
            setTimeout(() => {
              isFormSubmitting = false;
              restoreXPFormatting();
            }, 100);
          }
        });
        
        // Set up a mutation observer to catch any form data collection
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && (
                mutation.attributeName === 'data-submitting' ||
                mutation.attributeName === 'data-processing'
            )) {
              console.log('Mutation observer detected form processing - cleaning XP field');
              cleanXPFieldForSubmission();
            }
          });
        });
        
        observer.observe(form, {
          attributes: true,
          attributeFilter: ['data-submitting', 'data-processing']
        });
        
        // Intercept any attempts to collect form data
        const originalFormData = window.FormData;
        let isIntercepting = false;
        
        function FormDataInterceptor(formElement) {
          if (!isIntercepting && formElement === form) {
            isIntercepting = true;
            console.log('FormData constructor intercepted for character sheet - cleaning XP field');
            cleanXPFieldForSubmission();
            setTimeout(() => { isIntercepting = false; }, 100);
          }
          return new originalFormData(...arguments);
        }
        
        // Copy prototype and properties
        FormDataInterceptor.prototype = originalFormData.prototype;
        Object.setPrototypeOf(FormDataInterceptor, originalFormData);
        
        // Temporarily replace FormData during critical operations
        const interceptFormData = () => {
          const originalFD = window.FormData;
          window.FormData = FormDataInterceptor;
          setTimeout(() => {
            if (window.FormData === FormDataInterceptor) {
              window.FormData = originalFD;
            }
          }, 1000);
        };
        
        // Set up interception on key events
        form.addEventListener('submit', interceptFormData);
        form.addEventListener('change', interceptFormData);
      }
      
      // Input validation - only allow numbers and commas
      xpField.addEventListener('input', function(e) {
        // Remove any non-digit characters except commas
        let value = this.value.replace(/[^\d,]/g, '');
        
        // Remove commas, parse as number, then reformat with commas
        const numericValue = parseInt(value.replace(/,/g, '')) || 0;
        
        // Only update if the field is focused (user is typing)
        if (document.activeElement === this) {
          // Just show the raw number while typing
          this.value = numericValue.toString();
        }
      });
      
      // Format on blur (when user leaves the field)
      xpField.addEventListener('blur', function() {
        const value = parseInt(this.value.replace(/,/g, '')) || 0;
        this.value = formatNumberWithCommas(value);
      });
      
      // Remove commas before change events (for auto-save)
      xpField.addEventListener('change', function() {
        const rawValue = this.value.replace(/,/g, '');
        console.log('XP change event: cleaning value from', this.value, 'to', rawValue);
        // Temporarily store raw value for form processing
        this.dataset.rawValue = rawValue;
        
        // Temporarily clean for any immediate form processing
        this.value = rawValue;
        
        // Restore formatting after a brief delay (unless we're in a form submission)
        setTimeout(() => {
          if (!isFormSubmitting && document.activeElement !== this) {
            const numericValue = parseInt(rawValue) || 0;
            if (numericValue >= 1000) {
              this.value = numericValue.toLocaleString();
              console.log('XP formatting restored to:', this.value);
            }
          }
        }, 200);
      });
      
      // Remove commas on focus (for easier editing)
      xpField.addEventListener('focus', function() {
        const value = parseInt(this.value.replace(/,/g, '')) || 0;
        this.value = value.toString();
      });
      
      // Add a smart monitoring system that preserves display formatting but ensures clean form submissions
      let cleanupInterval;
      let monitoringPaused = false;
      let isFormSubmitting = false;
      
      const startXPMonitoring = () => {
        if (cleanupInterval) return; // Already running
        
        // DO NOT continuously clean the display - only during actual form submissions
        cleanupInterval = setInterval(() => {
          if (monitoringPaused) return; // Skip if paused
          
          // Only check if we're in the middle of a form submission
          if (isFormSubmitting && xpField && xpField.value && xpField.value.includes(',')) {
            const cleanValue = xpField.value.replace(/,/g, '');
            console.log('Form submission cleanup: cleaning', xpField.value, 'to', cleanValue);
            xpField.value = cleanValue;
          }
        }, 50); // Check frequently during form submissions
      };
      
      const stopXPMonitoring = () => {
        if (cleanupInterval) {
          clearInterval(cleanupInterval);
          cleanupInterval = null;
        }
      };
      
      const pauseXPMonitoring = () => {
        monitoringPaused = true;
        console.log('XP monitoring paused');
      };
      
      const resumeXPMonitoring = () => {
        monitoringPaused = false;
        console.log('XP monitoring resumed');
      };
      
      // Export functions for portrait system
      window.pauseXPMonitoring = pauseXPMonitoring;
      window.resumeXPMonitoring = resumeXPMonitoring;
      
      // Start monitoring when document is ready
      startXPMonitoring();
      
      // Clean up interval when form is removed
      const formObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.removedNodes.forEach((node) => {
            if (node.contains && node.contains(xpField)) {
              stopXPMonitoring();
            }
          });
        });
      });
      
      formObserver.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    // Function to update Next Level display
    function updateNextLevelDisplay() {
      const nextLevelField = document.getElementById('next-level-display');
      if (!nextLevelField) return;
      
      // Get current level and class to calculate next level XP
      const level = parseInt(document.querySelector('input[name="system.level"]')?.value) || 1;
      const characterClass = document.querySelector('select[name="system.class"]')?.value || 'fighter';
      
      // Calculate next level XP using the same tables as the actor
      const nextLevelXP = calculateNextLevelXP(level, characterClass);
      nextLevelField.value = formatNumberWithCommas(nextLevelXP);
    }
    
    // Function to override XP Progress Handler formatting
    function formatExistingFields() {
      // Format XP display if it exists
      const xpField = document.getElementById('xp-display');
      if (xpField && xpField.value) {
        const currentXP = parseInt(xpField.value.replace(/,/g, '')) || 0;
        if (document.activeElement !== xpField) {
          xpField.value = formatNumberWithCommas(currentXP);
        }
      }
      
      // Format Next Level display if it exists
      const nextLevelField = document.getElementById('next-level-display');
      if (nextLevelField && nextLevelField.value) {
        const nextLevelXP = parseInt(nextLevelField.value.replace(/,/g, '')) || 0;
        nextLevelField.value = formatNumberWithCommas(nextLevelXP);
      }
    }

    // Function to calculate next level XP (matches actor.js logic)
    function calculateNextLevelXP(level, characterClass) {
      // OSE XP progression tables
      const xpTables = {
        'fighter': [0, 2000, 4000, 8000, 16000, 32000, 64000, 120000, 240000, 360000, 480000, 600000, 720000, 840000, 960000],
        'cleric': [0, 1500, 3000, 6000, 12000, 25000, 50000, 100000, 200000, 300000, 400000, 500000, 600000, 700000, 800000],
        'magic-user': [0, 2500, 5000, 10000, 20000, 40000, 80000, 150000, 300000, 450000, 600000, 750000, 900000, 1050000, 1200000],
        'thief': [0, 1200, 2400, 4800, 9600, 20000, 40000, 80000, 160000, 280000, 400000, 520000, 640000, 760000, 880000]
      };

      // Map additional classes to their XP patterns
      const classXPMapping = {
        'fighter': 'fighter',
        'cleric': 'cleric', 
        'magic-user': 'magic-user',
        'thief': 'thief',
        'assassin': 'thief',
        'barbarian': 'fighter',
        'bard': 'thief',
        'beast master': 'fighter',
        'druid': 'cleric',
        'knight': 'fighter',
        'paladin': 'cleric',
        'ranger': 'fighter',
        'warden': 'fighter',
        'illusionist': 'magic-user',
        'mage': 'magic-user',
        'dwarf': 'fighter',
        'elf': 'magic-user',
        'gnome': 'cleric',
        'half-elf': 'fighter',
        'half-orc': 'fighter',
        'hobbit': 'thief'
      };

      // Get the appropriate XP table for this class
      const mappedClass = classXPMapping[characterClass.toLowerCase()] || 'fighter';
      const xpTable = xpTables[mappedClass];
      
      // Calculate next level XP (if max level, show current level requirement)
      const nextLevel = Math.min(level + 1, 15); // Max level 15
      const nextLevelIndex = nextLevel - 1; // Convert to array index
      
      return xpTable[nextLevelIndex] || xpTable[14]; // Use max level XP if beyond table
    }
    
    // XP Modifier calculation function (matches the system logic)
    function calculateXPModifier(characterClass, attributes) {
      // Prime requisite mapping for each class
      const primeRequisites = {
        'fighter': ['str'],
        'cleric': ['wis'], 
        'magic-user': ['int'],
        'thief': ['dex'],
        'assassin': ['str', 'dex'],
        'barbarian': ['str', 'con'],
        'bard': ['dex', 'cha'],
        'beast master': ['str', 'wis'],
        'druid': ['wis'],
        'knight': ['str'],
        'paladin': ['str', 'cha'],
        'ranger': ['str', 'wis'],
        'warden': ['str', 'con']
      };
      
      const primes = primeRequisites[characterClass.toLowerCase()] || [];
      if (primes.length === 0) return 0;
      
      // Calculate modifier based on prime requisite scores
      let totalModifier = 0;
      
      if (primes.length === 1) {
        // Single prime requisite
        const score = attributes[primes[0]]?.value || 10;
        if (score >= 16) totalModifier = 10;
        else if (score >= 13) totalModifier = 5;
        else if (score <= 8) totalModifier = -10;
      } else {
        // Multiple prime requisites - both must be high for bonus
        const scores = primes.map(attr => attributes[attr]?.value || 10);
        const allHigh = scores.every(score => score >= 13);
        const anyLow = scores.some(score => score <= 8);
        
        if (allHigh && scores.every(score => score >= 16)) totalModifier = 10;
        else if (allHigh) totalModifier = 5;
        else if (anyLow) totalModifier = -10;
      }
      
      return totalModifier;
    }
    
    // Function to run when DOM is ready
    function initializeCharacterSheet() {
      console.log('Initializing character sheet...');
      
      // Set encumbrance bar width after rendering
      const bar = document.querySelector('.encumbrance-bar[data-encumbrance]');
      if (bar) {
        const percent = bar.getAttribute('data-encumbrance');
        bar.style.width = percent + '%';
      }
      
      // Update XP Modifier display
      updateXPModifier();
      
      // Setup XP field formatting
      setupXPFieldFormatting();
      
      // Update XP display with comma formatting
      updateXPDisplay();
      
      // Update Next Level display
      updateNextLevelDisplay();
      
      // Set up periodic formatting to override XP progress handler
      setInterval(formatExistingFields, 500); // Run every 500ms to catch updates from XP progress handler
      
      // Add event listeners to update XP modifier when class or attributes change
      const classField = document.querySelector('select[name="system.class"]');
      const levelField = document.querySelector('input[name="system.level"]');
      const attributeFields = document.querySelectorAll('.attr-str, .attr-dex, .attr-con, .attr-int, .attr-wis, .attr-cha');
      
      if (classField) {
        classField.addEventListener('change', updateXPModifier);
        classField.addEventListener('change', updateNextLevelDisplay);
      }
      
      if (levelField) {
        levelField.addEventListener('change', updateNextLevelDisplay);
      }
      
      attributeFields.forEach(field => {
        field.addEventListener('change', updateXPModifier);
      });
      
      // Add event listener to update XP display when XP changes
      const xpInput = document.querySelector('#xp-display');
      if (xpInput) {
        xpInput.addEventListener('change', updateXPDisplay);
        xpInput.addEventListener('input', updateXPDisplay);
      }
      
      // Ability Score Tooltips System
      const TOOLTIP_DELAY = 200; // Reduced delay for testing - was 800ms
      
      const abilityScoreData = {
        "Strength": [
          { "score_range": "3", "melee": -3, "open_doors": "1-in-6" },
          { "score_range": "4-5", "melee": -2, "open_doors": "1-in-6" },
          { "score_range": "6-8", "melee": -1, "open_doors": "1-in-6" },
          { "score_range": "9-12", "melee": 0, "open_doors": "2-in-6" },
          { "score_range": "13-15", "melee": 1, "open_doors": "3-in-6" },
          { "score_range": "16-17", "melee": 2, "open_doors": "4-in-6" },
          { "score_range": "18", "melee": 3, "open_doors": "5-in-6" }
        ],
        "Intelligence": [
          { "score_range": "3", "languages": "Native (broken speech)", "literacy": "Illiterate" },
          { "score_range": "4-5", "languages": "Native", "literacy": "Illiterate" },
          { "score_range": "6-8", "languages": "Native", "literacy": "Basic" },
          { "score_range": "9-12", "languages": "Native", "literacy": "Literate" },
          { "score_range": "13-15", "languages": "Native +1 additional", "literacy": "Literate" },
          { "score_range": "16-17", "languages": "Native +2 additional", "literacy": "Literate" },
          { "score_range": "18", "languages": "Native +3 additional", "literacy": "Literate" }
        ],
        "Wisdom": [
          { "score_range": "3", "magic_saves": -3 },
          { "score_range": "4-5", "magic_saves": -2 },
          { "score_range": "6-8", "magic_saves": -1 },
          { "score_range": "9-12", "magic_saves": 0 },
          { "score_range": "13-15", "magic_saves": 1 },
          { "score_range": "16-17", "magic_saves": 2 },
          { "score_range": "18", "magic_saves": 3 }
        ],
        "Dexterity": [
          { "score_range": "3", "ac": -3, "missile": -3, "initiative": -2 },
          { "score_range": "4-5", "ac": -2, "missile": -2, "initiative": -1 },
          { "score_range": "6-8", "ac": -1, "missile": -1, "initiative": -1 },
          { "score_range": "9-12", "ac": 0, "missile": 0, "initiative": 0 },
          { "score_range": "13-15", "ac": 1, "missile": 1, "initiative": 1 },
          { "score_range": "16-17", "ac": 2, "missile": 2, "initiative": 1 },
          { "score_range": "18", "ac": 3, "missile": 3, "initiative": 2 }
        ],
        "Constitution": [
          { "score_range": "3", "hit_points": -3 },
          { "score_range": "4-5", "hit_points": -2 },
          { "score_range": "6-8", "hit_points": -1 },
          { "score_range": "9-12", "hit_points": 0 },
          { "score_range": "13-15", "hit_points": 1 },
          { "score_range": "16-17", "hit_points": 2 },
          { "score_range": "18", "hit_points": 3 }
        ],
        "Charisma": [
          { "score_range": "3", "npc_reactions": -2, "max_retainers": 1, "loyalty": 4 },
          { "score_range": "4-5", "npc_reactions": -1, "max_retainers": 2, "loyalty": 5 },
          { "score_range": "6-8", "npc_reactions": -1, "max_retainers": 3, "loyalty": 6 },
          { "score_range": "9-12", "npc_reactions": 0, "max_retainers": 4, "loyalty": 7 },
          { "score_range": "13-15", "npc_reactions": 1, "max_retainers": 5, "loyalty": 8 },
          { "score_range": "16-17", "npc_reactions": 1, "max_retainers": 6, "loyalty": 9 },
          { "score_range": "18", "npc_reactions": 2, "max_retainers": 7, "loyalty": 10 }
        ]
      };
      
      // Helper function to format modifier values
      function formatModifier(value) {
        if (typeof value === 'number') {
          return value > 0 ? `+${value}` : value.toString();
        }
        return value;
      }
      
      // Helper function to find score data based on ability score
      function getScoreData(abilityName, score) {
        const data = abilityScoreData[abilityName];
        if (!data) return null;
        
        for (const entry of data) {
          const range = entry.score_range;
          if (range.includes('-')) {
            const [min, max] = range.split('-').map(Number);
            if (score >= min && score <= max) return entry;
          } else {
            if (score === parseInt(range)) return entry;
          }
        }
        return null;
      }
      
      // Helper function to create tooltip content
      function createTooltipContent(abilityName, scoreData) {
        if (!scoreData) return '';
        
        const lines = [];
        
        if (abilityName === 'Strength') {
          lines.push(`Melee: ${formatModifier(scoreData.melee)}`);
          lines.push(`Open Doors: ${scoreData.open_doors}`);
        } else if (abilityName === 'Intelligence') {
          lines.push(`Languages: ${scoreData.languages}`);
          lines.push(`Literacy: ${scoreData.literacy}`);
        } else if (abilityName === 'Wisdom') {
          lines.push(`Magic Saves: ${formatModifier(scoreData.magic_saves)}`);
        } else if (abilityName === 'Dexterity') {
          lines.push(`AC: ${formatModifier(scoreData.ac)}`);
          lines.push(`Missile: ${formatModifier(scoreData.missile)}`);
          lines.push(`Initiative: ${formatModifier(scoreData.initiative)}`);
        } else if (abilityName === 'Constitution') {
          lines.push(`HP: ${formatModifier(scoreData.hit_points)}`);
        } else if (abilityName === 'Charisma') {
          lines.push(`NPC Reactions: ${formatModifier(scoreData.npc_reactions)}`);
          lines.push(`Max Retainers: ${scoreData.max_retainers}`);
          lines.push(`Loyalty: ${scoreData.loyalty}`);
        }
        
        return lines.join('<br>');
      }
      
      // Create tooltip element
      const tooltip = document.createElement('div');
      tooltip.id = 'ability-tooltip';
      tooltip.style.cssText = `
        position: absolute;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        line-height: 1.4;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        white-space: nowrap;
      `;
      document.body.appendChild(tooltip);
      
      let tooltipTimeout;
      
      // Setup tooltips for ability scores
      const abilityMappings = [
        { selector: '.attr-str', name: 'Strength' },
        { selector: '.attr-dex', name: 'Dexterity' },
        { selector: '.attr-con', name: 'Constitution' },
        { selector: '.attr-int', name: 'Intelligence' },
        { selector: '.attr-wis', name: 'Wisdom' },
        { selector: '.attr-cha', name: 'Charisma' }
      ];
      
      abilityMappings.forEach(({ selector, name }) => {
        const element = document.querySelector(selector);
        if (element) {
          element.addEventListener('mouseenter', (e) => {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
              const score = parseInt(element.value);
              const scoreData = getScoreData(name, score);
              const content = createTooltipContent(name, scoreData);
              
              if (content) {
                tooltip.innerHTML = content;
                
                // Position tooltip above the element
                const rect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                
                tooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
                tooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
                tooltip.style.opacity = '1';
              }
            }, TOOLTIP_DELAY);
          });
          
          element.addEventListener('mouseleave', () => {
            clearTimeout(tooltipTimeout);
            tooltip.style.opacity = '0';
          });
          
          // Update tooltip when value changes
          element.addEventListener('change', () => {
            if (tooltip.style.opacity === '1') {
              const score = parseInt(element.value);
              const scoreData = getScoreData(name, score);
              const content = createTooltipContent(name, scoreData);
              if (content) {
                tooltip.innerHTML = content;
              }
            }
          });
        }
      });
      
      // Setup dedicated tooltip for XP field with improved event handling
      setTimeout(() => {
        const xpElement = document.querySelector('#xp-display');
        if (xpElement) {
          console.log('Setting up XP tooltip for element:', xpElement);
          
          // Create dedicated XP tooltip to avoid conflicts
          let xpTooltip = document.getElementById('xp-tooltip');
          if (!xpTooltip) {
            xpTooltip = document.createElement('div');
            xpTooltip.id = 'xp-tooltip';
            xpTooltip.style.cssText = `
              position: absolute;
              background: #333;
              color: white;
              padding: 8px 12px;
              border-radius: 4px;
              font-size: 12px;
              line-height: 1.4;
              z-index: 10000;
              pointer-events: none;
              opacity: 0;
              transition: opacity 0.2s;
              white-space: nowrap;
              box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(xpTooltip);
          }
          let xpTooltipTimeout;
          
          // Remove any existing event listeners and add new ones
          xpElement.removeEventListener('mouseenter', xpElement._tooltipMouseEnter);
          xpElement.removeEventListener('mouseleave', xpElement._tooltipMouseLeave);
          xpElement.removeEventListener('mouseover', xpElement._tooltipMouseOver);
          xpElement.removeEventListener('mouseout', xpElement._tooltipMouseOut);
          
          xpElement._tooltipMouseEnter = (e) => {
            console.log('XP mouseenter triggered');
            clearTimeout(xpTooltipTimeout);
            xpTooltipTimeout = setTimeout(() => {
              xpTooltip.innerHTML = 'Double-click to award XP â€¢ Click to edit';
              
              // Position tooltip above the element
              const rect = xpElement.getBoundingClientRect();
              const tooltipRect = xpTooltip.getBoundingClientRect();
              
              xpTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
              xpTooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
              xpTooltip.style.opacity = '1';
              console.log('XP tooltip shown');
            }, TOOLTIP_DELAY);
          };
          
          xpElement._tooltipMouseLeave = () => {
            console.log('XP mouseleave triggered');
            clearTimeout(xpTooltipTimeout);
            xpTooltip.style.opacity = '0';
          };
          
          // Try both mouseenter/mouseleave and mouseover/mouseout
          xpElement._tooltipMouseOver = xpElement._tooltipMouseEnter;
          xpElement._tooltipMouseOut = xpElement._tooltipMouseLeave;
          
          xpElement.addEventListener('mouseenter', xpElement._tooltipMouseEnter);
          xpElement.addEventListener('mouseleave', xpElement._tooltipMouseLeave);
          xpElement.addEventListener('mouseover', xpElement._tooltipMouseOver);
          xpElement.addEventListener('mouseout', xpElement._tooltipMouseOut);
        }
      }, 100);

      // Saving Throw Tooltips System
      function initializeSavingThrowTooltips() {
        console.log('Initializing saving throw tooltips...');
        
        // Get character data
        const race = (document.querySelector('#char-race')?.value || '').toLowerCase().trim();
        const characterClass = (document.querySelector('#char-class')?.value || '').toLowerCase().trim();
        const conScore = parseInt(document.querySelector('[name="system.abilities.con.value"]')?.value) || 10;
        
        console.log(`Character: Race="${race}", Class="${characterClass}", CON=${conScore}`);
        
        // Check if character is an elf (race or class)
        const isElf = race === 'elf' || characterClass === 'elf';
        
        // Only show CON-based racial tooltips if race is different from class (race+class combo, not race-as-class)
        const showRacialBonuses = race && race !== characterClass;
        
        if (!showRacialBonuses && !isElf) {
          console.log('No tooltips needed');
          return;
        }
        
        // Calculate racial bonuses and special abilities
        function getRacialBonus(race, characterClass, saveType, conScore) {
          let bonus = 0;
          let description = '';
          
          // Elf paralysis immunity (works for race or class)
          const isElf = race === 'elf' || characterClass === 'elf';
          if (isElf && saveType === 'paralysis') {
            description = 'Unaffected by the paralysis that ghouls can inflict.';
            return { bonus, description };
          }
          
          // CON-based racial bonuses (only for race+class combinations, not race-as-class)
          if (!race || race === characterClass) {
            return { bonus, description };
          }
          
          if (race === 'dwarf') {
            if (saveType === 'death') { // Death Ray/Poison - only poison part
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Poison';
            } else if (saveType === 'wands' || saveType === 'spells') {
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Magic';
            }
          } else if (race === 'gnome') {
            if (saveType === 'wands' || saveType === 'spells') {
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Magic';
            }
          } else if (race === 'hobbit' || race === 'halfling') {
            if (saveType === 'death') { // Death Ray/Poison - only poison part
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Poison';
            } else if (saveType === 'wands' || saveType === 'spells') {
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Magic';
            }
          }
          
          return { bonus, description };
        }
        
        // Create tooltip element for saving throws
        let saveTooltip = document.getElementById('save-tooltip');
        if (!saveTooltip) {
          saveTooltip = document.createElement('div');
          saveTooltip.id = 'save-tooltip';
          saveTooltip.style.cssText = `
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.4;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
          `;
          document.body.appendChild(saveTooltip);
        }
        
        let saveTooltipTimeout;
        
        // Setup tooltips for each saving throw
        const saveTypes = ['death', 'wands', 'paralysis', 'breath', 'spells'];
        
        saveTypes.forEach(saveType => {
          const saveElement = document.querySelector(`.save-group-${saveType} .save span`);
          if (!saveElement) return;
          
          const racialData = getRacialBonus(race, characterClass, saveType, conScore);
          
          // Show tooltip if there's a racial bonus OR if it's elf paralysis immunity
          if (racialData.bonus > 0 || racialData.description) {
            console.log(`Adding tooltip to ${saveType}: ${racialData.description}`);
            
            saveElement.addEventListener('mouseenter', () => {
              clearTimeout(saveTooltipTimeout);
              saveTooltipTimeout = setTimeout(() => {
                saveTooltip.innerHTML = racialData.description;
                saveTooltip.style.opacity = '1';
                
                // Position tooltip above the saving throw circle
                const rect = saveElement.getBoundingClientRect();
                const tooltipRect = saveTooltip.getBoundingClientRect();
                
                saveTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
                saveTooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
              }, TOOLTIP_DELAY);
            });
            
            saveElement.addEventListener('mouseleave', () => {
              clearTimeout(saveTooltipTimeout);
              saveTooltip.style.opacity = '0';
            });
          }
        });
      }
      
      // Initialize saving throw tooltips after ability tooltips
      setTimeout(initializeSavingThrowTooltips, 100);

      console.log('Starting portrait setup...');
      
      // Portrait handling with delayed tooltip setup
      setTimeout(() => {
        const portraitDisplay = document.querySelector('.portrait-display');
        
        console.log('Portrait elements found:', { portraitDisplay });

        if (portraitDisplay) {
          console.log('Setting up portrait event listeners...');

          // Create dedicated portrait tooltip to avoid conflicts with other tooltips
          let portraitTooltip = document.getElementById('portrait-tooltip');
          if (!portraitTooltip) {
            portraitTooltip = document.createElement('div');
            portraitTooltip.id = 'portrait-tooltip';
            portraitTooltip.style.cssText = `
              position: absolute;
              background: #333;
              color: white;
              padding: 8px 12px;
              border-radius: 4px;
              font-size: 12px;
              line-height: 1.4;
              z-index: 10000;
              pointer-events: none;
              opacity: 0;
              transition: opacity 0.2s;
              white-space: nowrap;
              box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(portraitTooltip);
          }
          let portraitTooltipTimeout;

          // Remove any existing event listeners and add new ones  
          portraitDisplay.removeEventListener('mouseenter', portraitDisplay._tooltipMouseEnter);
          portraitDisplay.removeEventListener('mouseleave', portraitDisplay._tooltipMouseLeave);
          portraitDisplay.removeEventListener('mouseover', portraitDisplay._tooltipMouseOver);
          portraitDisplay.removeEventListener('mouseout', portraitDisplay._tooltipMouseOut);

          // Show portrait tooltip on hover
          portraitDisplay._tooltipMouseEnter = () => {
            console.log('Portrait mouseenter triggered');
            clearTimeout(portraitTooltipTimeout);
            portraitTooltipTimeout = setTimeout(() => {
              const tipText = 'Double-click to select portrait â€¢ Right-click to adjust position';
              portraitTooltip.innerHTML = tipText;
              portraitTooltip.style.opacity = '1';
              const rect = portraitDisplay.getBoundingClientRect();
              const tooltipRect = portraitTooltip.getBoundingClientRect();
              portraitTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
              portraitTooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
              console.log('Portrait tooltip shown');
            }, TOOLTIP_DELAY);
          };
          
          portraitDisplay._tooltipMouseLeave = () => {
            console.log('Portrait mouseleave triggered');
            clearTimeout(portraitTooltipTimeout);
            portraitTooltip.style.opacity = '0';
          };
          
          // Try both mouseenter/mouseleave and mouseover/mouseout
          portraitDisplay._tooltipMouseOver = portraitDisplay._tooltipMouseEnter;
          portraitDisplay._tooltipMouseOut = portraitDisplay._tooltipMouseLeave;
          
          portraitDisplay.addEventListener('mouseenter', portraitDisplay._tooltipMouseEnter);
          portraitDisplay.addEventListener('mouseleave', portraitDisplay._tooltipMouseLeave);
          portraitDisplay.addEventListener('mouseover', portraitDisplay._tooltipMouseOver);
          portraitDisplay.addEventListener('mouseout', portraitDisplay._tooltipMouseOut);

        // Double-click on portrait opens Foundry file picker
        portraitDisplay.addEventListener('dblclick', async (event) => {
          console.log('Portrait double-clicked!', event);
          
          try {
            // Use Foundry's FilePicker
            const fp = new FilePicker({
              type: "image",
              current: "",
              callback: (path) => {
                console.log('File selected from Foundry picker:', path);
                
                // Update the portrait display
                portraitDisplay.style.backgroundImage = `url('${path}')`;
                
                // Update the hidden input with the file path
                const portraitInput = document.querySelector('input[name="system.portrait"]');
                if (portraitInput) {
                  portraitInput.value = path;
                  
                  // Trigger a change event to update the actor
                  const changeEvent = new Event('change', { bubbles: true });
                  portraitInput.dispatchEvent(changeEvent);
                }
              }
            });
            
            // Render the file picker
            fp.render(true);
            
          } catch (error) {
            console.error('Error opening Foundry file picker:', error);
          }
        });
        
        // Right-click to show portrait adjustment controls
        portraitDisplay.addEventListener('contextmenu', (event) => {
          event.preventDefault();
          console.log('Portrait right-clicked, showing controls');
          const controls = document.getElementById('portrait-controls');
          const container = document.getElementById('portrait-container');
          
          // Show controls and enter adjustment mode
          if (controls) {
            controls.style.display = 'block';
            console.log('Controls shown, display style:', controls.style.display);
            
            // Add a global observer to see if something else is hiding the controls
            const observer = new MutationObserver((mutations) => {
              mutations.forEach((mutation) => {
                if (mutation.target === controls && mutation.attributeName === 'style') {
                  console.log('Controls style changed by something else!', controls.style.display);
                  console.trace('Style change stack trace');
                }
              });
            });
            observer.observe(controls, { attributes: true, attributeFilter: ['style'] });
            
            // Store observer for cleanup
            controls._observer = observer;
          }
          if (container) {
            container.classList.add('adjusting');
          }
          
          // NO automatic hiding - only manual close via Done button
        });
        
          // Setup portrait adjustment functionality
          setupPortraitAdjustment();
          
          console.log('Portrait event listeners set up successfully');
        } else {
          console.log('Portrait elements not found!');
        }
      }, 100);
    }
    
    // Portrait adjustment system
    function setupPortraitAdjustment() {
      const controls = document.getElementById('portrait-controls');
      const container = document.getElementById('portrait-container');
      
      if (!controls || !container) {
        console.error('Portrait controls or container not found');
        return;
      }
      
      // Get current values from CSS variables or defaults
      let scale = parseFloat(getComputedStyle(container).getPropertyValue('--user-portrait-scale')) || 1;
      let x = parseFloat(getComputedStyle(container).getPropertyValue('--user-portrait-x')) || 0;
      let y = parseFloat(getComputedStyle(container).getPropertyValue('--user-portrait-y')) || 0;
      
      // Add individual event listeners to each button with maximum event blocking
      const buttons = controls.querySelectorAll('button');
      console.log('Setting up', buttons.length, 'button listeners');
      
      buttons.forEach((button, index) => {
        console.log('Setting up button', index, 'with action:', button.dataset.action);
        
        // Block all possible events that could bubble
        ['mousedown', 'mouseup', 'click', 'pointerdown', 'pointerup'].forEach(eventType => {
          button.addEventListener(eventType, (event) => {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            
            // Only execute action on 'click'
            if (eventType !== 'click') return;
            
            const action = button.dataset.action;
            console.log('Button action executed:', action);
            
            switch (action) {
              case 'zoom-in':
                scale = Math.min(scale + 0.1, 2.5);
                updatePortrait();
                console.log('Zoomed in to', scale);
                break;
              case 'zoom-out':
                scale = Math.max(scale - 0.1, 0.5);
                updatePortrait();
                console.log('Zoomed out to', scale);
                break;
              case 'move-up':
                y -= 3;
                updatePortrait();
                console.log('Moved up to y:', y);
                break;
              case 'move-down':
                y += 3;
                updatePortrait();
                console.log('Moved down to y:', y);
                break;
              case 'move-left':
                x -= 3;
                updatePortrait();
                console.log('Moved left to x:', x);
                break;
              case 'move-right':
                x += 3;
                updatePortrait();
                console.log('Moved right to x:', x);
                break;
              case 'reset':
                scale = 1;
                x = 0;
                y = 0;
                updatePortrait();
                console.log('Reset portrait');
                break;
              case 'done':
                console.log('Done button clicked - saving and closing controls');
                
                // Pause XP monitoring and mark form as submitting
                if (window.pauseXPMonitoring) {
                  window.pauseXPMonitoring();
                }
                isFormSubmitting = true;
                
                savePortraitData(); // Save the data to the actor
                
                // Resume normal operation after a delay
                setTimeout(() => {
                  isFormSubmitting = false;
                  if (window.resumeXPMonitoring) {
                    window.resumeXPMonitoring();
                  }
                  // Restore XP formatting
                  const xpField = document.getElementById('xp-display');
                  if (xpField && xpField.value && !xpField.value.includes(',')) {
                    const numericValue = parseInt(xpField.value) || 0;
                    if (numericValue >= 1000) {
                      const formattedValue = numericValue.toLocaleString();
                      console.log('Restoring XP formatting: from', xpField.value, 'to', formattedValue);
                      xpField.value = formattedValue;
                    }
                  }
                }, 2000);
                
                if (controls._observer) {
                  controls._observer.disconnect();
                }
                controls.style.display = 'none';
                container.classList.remove('adjusting');
                console.log('Portrait adjustment closed');
                break;
            }
          }, true); // Use capture phase
        });
      });
      
      // Update portrait transform and save data
      function updatePortrait() {
        // Update CSS variables
        container.style.setProperty('--user-portrait-scale', scale);
        container.style.setProperty('--user-portrait-x', x + 'px');
        container.style.setProperty('--user-portrait-y', y + 'px');
        
        // Update hidden form inputs for persistence (but don't trigger events yet)
        const scaleInput = document.querySelector('input[name="system.userPortrait.scale"]');
        const xInput = document.querySelector('input[name="system.userPortrait.x"]');
        const yInput = document.querySelector('input[name="system.userPortrait.y"]');
        
        if (scaleInput) scaleInput.value = scale;
        if (xInput) xInput.value = x;
        if (yInput) yInput.value = y;
        
        // Don't trigger change events immediately to prevent re-render
        // We'll save when the user clicks "Done" instead
        console.log('Portrait updated - scale:', scale, 'x:', x, 'y:', y);
      }
      
      // Function to save portrait data to actor (only called when Done)
      function savePortraitData() {
        console.log('Saving portrait data:', {scale, x, y});
        
        // Clean XP field before save operations
        const xpField = document.getElementById('xp-display');
        if (xpField && xpField.value) {
          const cleanValue = xpField.value.replace(/,/g, '');
          if (cleanValue !== xpField.value) {
            console.log('Cleaning XP field before portrait save: from', xpField.value, 'to', cleanValue);
            xpField.value = cleanValue;
          }
        }
        
        // Method 1: Try to get actor ID from the application instance
        let actorId = null;
        
        // Try multiple methods to find the actor ID
        // Method 1a: Check if there's a global actor reference in the sheet
        if (window.currentActorSheet && window.currentActorSheet.actor) {
          actorId = window.currentActorSheet.actor.id;
          console.log('Found actor ID from window.currentActorSheet:', actorId);
        }
        
        // Method 1b: Look for the sheet application instance
        if (!actorId) {
          const formElement = document.querySelector('form.flexcol');
          if (formElement) {
            const windowApp = formElement.closest('.window-app');
            if (windowApp) {
              const appId = windowApp.getAttribute('data-appid');
              if (appId && ui.windows[appId] && ui.windows[appId].actor) {
                actorId = ui.windows[appId].actor.id;
                console.log('Found actor ID from app instance:', actorId);
              }
            }
          }
        }
        
        // Method 2: Try to get actor ID from form data
        if (!actorId) {
          const actorIdInput = document.querySelector('input[name="id"]');
          if (actorIdInput && actorIdInput.value) {
            actorId = actorIdInput.value;
            console.log('Found actor ID from form input:', actorId);
          }
        }
        
        // Method 3: Try to get from URL or other sources
        if (!actorId) {
          const urlMatch = window.location.href.match(/actors\/([a-zA-Z0-9]+)/);
          if (urlMatch) {
            actorId = urlMatch[1];
            console.log('Found actor ID from URL:', actorId);
          }
        }
        
        if (actorId) {
          // Use Foundry's game.actors to update directly, completely bypassing form system
          const actor = game.actors.get(actorId);
          if (actor) {
            const updateData = {
              'system.userPortrait.scale': scale,
              'system.userPortrait.x': x,
              'system.userPortrait.y': y
            };
            
            console.log('Updating actor directly with portrait data:', updateData);
            console.log('Current actor XP before update:', actor.system.xp);
            
            // Use the most direct update method possible with maximum isolation
            actor.update(updateData, {
              render: false,     // Don't trigger re-render
              diff: false,       // Don't compute diffs  
              recursive: false,  // Don't do recursive updates
              noHook: true      // Don't trigger hooks that might interfere
            }).then(() => {
              console.log('Portrait data saved directly to actor without re-render');
              console.log('Actor XP after portrait update:', actor.system.xp);
              
              // Force update the hidden form fields to match saved data
              const scaleInput = document.querySelector('input[name="system.userPortrait.scale"]');
              const xInput = document.querySelector('input[name="system.userPortrait.x"]');
              const yInput = document.querySelector('input[name="system.userPortrait.y"]');
              
              if (scaleInput) {
                scaleInput.value = scale;
                scaleInput.setAttribute('value', scale);
              }
              if (xInput) {
                xInput.value = x;
                xInput.setAttribute('value', x);
              }
              if (yInput) {
                yInput.value = y;
                yInput.setAttribute('value', y);
              }
              
              console.log('Portrait save completed - hidden form fields updated');
              
            }).catch(err => {
              console.error('Error saving portrait data directly:', err);
            });
            return;
          }
        }
        
        console.error('Could not find actor ID for direct portrait save, falling back to form method');
        
        // Fallback: Use form system to save portrait data
        const scaleInput = document.querySelector('input[name="system.userPortrait.scale"]');
        const xInput = document.querySelector('input[name="system.userPortrait.x"]');
        const yInput = document.querySelector('input[name="system.userPortrait.y"]');
        
        console.log('Fallback: Found form inputs:', {
          scaleInput: !!scaleInput,
          xInput: !!xInput,
          yInput: !!yInput
        });
        
        if (scaleInput) {
          scaleInput.value = scale;
          scaleInput.setAttribute('value', scale);
          console.log('Fallback: Updated scale input to', scale);
        }
        if (xInput) {
          xInput.value = x;
          xInput.setAttribute('value', x);
          console.log('Fallback: Updated x input to', x);
        }
        if (yInput) {
          yInput.value = y;
          yInput.setAttribute('value', y);
          console.log('Fallback: Updated y input to', y);
        }
        
        // Trigger a form change event to save the data
        const formElement = document.querySelector('form.flexcol');
        if (formElement) {
          const changeEvent = new Event('change', { bubbles: true });
          if (scaleInput) {
            scaleInput.dispatchEvent(changeEvent);
            console.log('Fallback: Triggered change event on scale input');
          }
          console.log('Portrait data saved via form system fallback');
        } else {
          console.error('Fallback: Could not find form element');
        }
      }
    }

  // Check if DOM is already ready or wait for it
    if (document.readyState === 'loading') {
      console.log('DOM still loading, waiting for DOMContentLoaded...');
      document.addEventListener('DOMContentLoaded', initializeCharacterSheet);
    } else {
      console.log('DOM already ready, initializing immediately...');
    // DOM is already ready, run immediately
    setTimeout(initializeCharacterSheet, 0);
  }
  </script>

  <!-- Character Level - Positioned behind everything -->
  <div class="level-progress-bar-container" id="level-container"
       style="position: absolute; width: 64px; height: 34px; left: 460px; top: 20px; z-index: 8;">
    <!-- Shadow overlay for Level field -->
    <div style="position: absolute; top: 0; left: 0; width: 64px; height: 34px; z-index: 9; pointer-events: none; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8); border-radius: 6px;"></div>
  <!-- Hidden inputs for level position data -->
  <input type="hidden" name="system.levelPosition.x" value="{{system.levelPosition.x}}" />
  <input type="hidden" name="system.levelPosition.y" value="{{system.levelPosition.y}}" />
  <input type="hidden" name="system.levelPosition.zIndex" value="{{system.levelPosition.zIndex}}" />
        
        <!-- Horizontal Progress Bar Background -->
        <div style="
          position: absolute; 
          top: 0px; 
          left: 0; 
          width: 64px; 
          height: 34px; 
          box-shadow: none !important;
          overflow: hidden;
          z-index: 8;
        ">
          <!-- Progress Fill -->
          <div class="level-progress-bar" style="
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 3px;
            background-color: #22c55e;
            width: 0%;
            transition: width 0.3s ease;
          "></div>
          
          <!-- Level display in center -->
          <div class="level-display" style="
            position: absolute; 
            top: 2px; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            font-size: 24px; 
            color: #000; 
            z-index: 1; 
            line-height: 34px;
            font-family: 'Minion Pro', serif;
            text-align: center;
            box-sizing: border-box;
            background: transparent !important;
            box-shadow: none !important;
            display: flex;
            align-items: center;
            justify-content: center;
          ">{{system.level}}</div>
        </div>
      </div>

  <!-- Character Portrait - Positioned behind everything -->
  <div class="portrait-container" id="portrait-container"
       style="--portrait-size: 138px; --user-portrait-scale: {{#if system.userPortrait.scale}}{{system.userPortrait.scale}}{{else}}1{{/if}}; --user-portrait-x: {{#if system.userPortrait.x}}{{system.userPortrait.x}}px{{else}}0px{{/if}}; --user-portrait-y: {{#if system.userPortrait.y}}{{system.userPortrait.y}}px{{else}}0px{{/if}}; position: absolute; width: var(--portrait-size); height: 141px; left: 34px; top: 75px; z-index: 15; overflow: hidden;">
    <!-- Hidden inputs for portrait data -->
    <input type="hidden" name="system.portrait" value="{{system.portrait}}" />
    <input type="hidden" name="system.userPortrait.scale" value="{{system.userPortrait.scale}}" />
    <input type="hidden" name="system.userPortrait.x" value="{{system.userPortrait.x}}" />
    <input type="hidden" name="system.userPortrait.y" value="{{system.userPortrait.y}}" />
    
    <!-- Portrait display area -->
    <div class="portrait-display" style="
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      border-radius: 3px;
      overflow: hidden;
      pointer-events: auto;
    ">
      <img class="portrait-img" src="{{#if system.portrait}}{{system.portrait}}{{else}}icons/svg/mystery-man-black.svg{{/if}}" alt="{{actor.name}}" style="width:100%;height:100%;object-fit:contain;display:block;" draggable="false" />
    </div>
    
    <!-- Portrait adjustment controls -->
    <div class="portrait-controls" id="portrait-controls">
      <div class="btn-group">
        <button type="button" data-action="zoom-out" title="Zoom Out">âˆ’</button>
        <button type="button" data-action="zoom-in" title="Zoom In">+</button>
      </div>
      <div class="btn-group">
        <button type="button" data-action="move-up" title="Move Up">â†‘</button>
        <button type="button" data-action="move-down" title="Move Down">â†“</button>
        <button type="button" data-action="move-left" title="Move Left">â†</button>
        <button type="button" data-action="move-right" title="Move Right">â†’</button>
      </div>
      <div class="btn-group">
        <button type="button" data-action="reset" title="Reset">â†»</button>
        <button type="button" data-action="done" title="Done">âœ“</button>
      </div>
    </div>
  </div>

  <!-- Static Header Section - Absolute Positioning Layout -->
  <div class="static-header" style="height: 230px; flex-shrink: 0; position: relative; z-index: 10; background: url('systems/osp-houserules/assets/character-sheet/static-sheet.webp') no-repeat left top !important; background-size: 100% auto !important; background-color: transparent !important; margin-top: 0 !important; padding-top: 0 !important; pointer-events: none;">

      <!-- Character Name - Centered positioning -->
  <div class="character-name-section" id="character-name-container"
    style="position: absolute; left: 40px; top: 14px; z-index: 9;">

      </div>

  <!-- Character Name - Absolute positioned -->
  <div class="character-name-group" id="character-name-container"
       style="position: absolute; left: 33px; top: 16px; z-index: 9; pointer-events: none;">
    <input type="hidden" name="system.namePosition.x" value="{{system.namePosition.x}}" />
    <input type="hidden" name="system.namePosition.y" value="{{system.namePosition.y}}" />
    <input type="hidden" name="system.namePosition.zIndex" value="{{system.namePosition.zIndex}}" />
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
      <input class="char-name" id="char-name" name="name" type="text" value="{{actor.name}}" style="width: 280px; height: 34px; text-align: center; font-family: 'Minion Pro', serif; font-size: 24px; background-color: transparent !important; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 6px 2px 0 2px; margin: 0; transform: translateY(4px); overflow: visible; white-space: nowrap; text-overflow: clip; border: none; pointer-events: auto;" />
    </div>
  </div>
      
  <!-- Character Class & Alignment - Centered under name as one element -->
  <!-- Character Class - Independent container for positioning -->
  <div class="class-group" id="class-container"
       style="position: absolute; left: 319px; top: 16px; z-index: 9;">
    <input type="hidden" name="system.classPosition.x" value="{{system.classPosition.x}}" />
    <input type="hidden" name="system.classPosition.y" value="{{system.classPosition.y}}" />
    <input type="hidden" name="system.classPosition.zIndex" value="{{system.classPosition.zIndex}}" />
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
  <select class="char-class" id="char-class" name="system.class" style="width: 134px; height: 34px; text-align: center; font-size: 24px; background-color: transparent !important; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 6px 5px 2px 5px; margin: 0; transform: translateY(4px); overflow: visible; white-space: nowrap; text-overflow: clip; border: none; pointer-events: auto;">
        <option value="Assassin" {{#if (eq system.class "Assassin")}}selected{{/if}}>Assassin</option>
        <option value="Barbarian" {{#if (eq system.class "Barbarian")}}selected{{/if}}>Barbarian</option>
        <option value="Bard" {{#if (eq system.class "Bard")}}selected{{/if}}>Bard</option>
        <option value="Beast Master" {{#if (eq system.class "Beast Master")}}selected{{/if}}>Beast Master</option>
        <option value="Cleric" {{#if (eq system.class "Cleric")}}selected{{/if}}>Cleric</option>
        <option value="Druid" {{#if (eq system.class "Druid")}}selected{{/if}}>Druid</option>
        <option value="Dwarf" {{#if (eq system.class "Dwarf")}}selected{{/if}}>Dwarf</option>
        <option value="Elf" {{#if (eq system.class "Elf")}}selected{{/if}}>Elf</option>
        <option value="Fighter" {{#if (eq system.class "Fighter")}}selected{{/if}}>Fighter</option>
        <option value="Gnome" {{#if (eq system.class "Gnome")}}selected{{/if}}>Gnome</option>
        <option value="Half-Elf" {{#if (eq system.class "Half-Elf")}}selected{{/if}}>Half-Elf</option>
        <option value="Half-Orc" {{#if (eq system.class "Half-Orc")}}selected{{/if}}>Half-Orc</option>
        <option value="Hobbit" {{#if (eq system.class "Hobbit")}}selected{{/if}}>Hobbit</option>
        <option value="Illusionist" {{#if (eq system.class "Illusionist")}}selected{{/if}}>Illusionist</option>
        <option value="Knight" {{#if (eq system.class "Knight")}}selected{{/if}}>Knight</option>
        <option value="Mage" {{#if (eq system.class "Mage")}}selected{{/if}}>Mage</option>
        <option value="Magic-User" {{#if (eq system.class "Magic-User")}}selected{{/if}}>Magic-User</option>
        <option value="Paladin" {{#if (eq system.class "Paladin")}}selected{{/if}}>Paladin</option>
        <option value="Ranger" {{#if (eq system.class "Ranger")}}selected{{/if}}>Ranger</option>
        <option value="Thief" {{#if (eq system.class "Thief")}}selected{{/if}}>Thief</option>
        <option value="Warden" {{#if (eq system.class "Warden")}}selected{{/if}}>Warden</option>
      </select>
    </div>
  </div>

  <!-- Character Alignment - Independent container for positioning -->
  <div class="alignment-group" id="alignment-container"
       style="position: absolute; left: 319px; top: 125px; z-index: 9;">
    <input type="hidden" name="system.alignmentPosition.x" value="{{system.alignmentPosition.x}}" />
    <input type="hidden" name="system.alignmentPosition.y" value="{{system.alignmentPosition.y}}" />
    <input type="hidden" name="system.alignmentPosition.zIndex" value="{{system.alignmentPosition.zIndex}}" />
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
  <select class="char-align" id="char-align" name="system.alignment" style="width: 134px; height: 34px; text-align: center; font-size: 24px; background-color: transparent !important; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 5px 0 0 0; margin: 0; transform: translateY(4px); border: none; pointer-events: auto;">
        <option value="Chaotic" {{#if (eq system.alignment "Chaotic")}}selected{{/if}}>Chaotic</option>
        <option value="Lawful" {{#if (eq system.alignment "Lawful")}}selected{{/if}}>Lawful</option>
        <option value="Neutral" {{#if (eq system.alignment "Neutral")}}selected{{/if}}>Neutral</option>
      </select>
    </div>
  </div>

  <!-- Character Race - Positioned next to existing fields -->
  <div class="race-group" id="race-container"
       style="position: absolute; left: 179px; top: 74px; z-index: 9;">
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
      <select class="char-race" id="char-race" name="system.race" style="width: 132px; height: 35px; text-align: center; font-size: 24px; background-color: transparent !important; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 34px; padding: 3px 0 0 0; margin: 0; border: none; pointer-events: auto;">
        <option value="Dwarf" {{#if (eq system.race "Dwarf")}}selected{{/if}}>Dwarf</option>
        <option value="Elf" {{#if (eq system.race "Elf")}}selected{{/if}}>Elf</option>
        <option value="Gnome" {{#if (eq system.race "Gnome")}}selected{{/if}}>Gnome</option>
        <option value="Half-Elf" {{#if (eq system.race "Half-Elf")}}selected{{/if}}>Half-Elf</option>
        <option value="Half-Orc" {{#if (eq system.race "Half-Orc")}}selected{{/if}}>Half-Orc</option>
        <option value="Hobbit" {{#if (eq system.race "Hobbit")}}selected{{/if}}>Hobbit</option>
        <option value="Human" {{#if (eq system.race "Human")}}selected{{/if}}>Human</option>
      </select>
    </div>
  </div>

  <!-- Character Age and Sex - Small fields -->
  <div class="age-group" id="age-container"
       style="position: absolute; left: 179px; top: 129px; z-index: 9;">
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
      <input class="char-age" id="char-age" name="system.age" type="text" value="{{system.age}}" style="width: 63px; height: 34px; text-align: center; font-size: 24px; background-color: transparent !important; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; padding: 5px 0 2px 0; margin: 0; border: none; pointer-events: auto; display: flex; align-items: center; justify-content: center; line-height: 1; vertical-align: middle;" />
    </div>
  </div>

  <div class="sex-group" id="sex-container"
       style="position: absolute; left: 249px; top: 129px; z-index: 9;">
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
      <select class="char-sex" id="char-sex" name="system.sex" style="width: 63px; height: 34px; text-align: center; font-size: 24px; background-color: transparent !important; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; padding: 6px 0 1px 0; margin: 0; border: none; pointer-events: auto; display: flex; align-items: center; justify-content: center; line-height: 1; vertical-align: middle;">
        <option value="Male" {{#if (eq system.sex "Male")}}selected{{/if}}>M</option>
        <option value="Female" {{#if (eq system.sex "Female")}}selected{{/if}}>F</option>
        <option value="Other" {{#if (eq system.sex "Other")}}selected{{/if}}>O</option>
      </select>
    </div>
  </div>

  <!-- HandW field -->
  <div class="handw-group" id="handw-container"
       style="position: absolute; left: 179px; top: 182px; z-index: 8;">
    <div class="char-field-group" style="display: flex; flex-direction: column;">
      <input class="char-handw" id="char-handw" name="system.handw" type="text" value="{{system.handw}}" readonly style="width:134px; height: 34px; background-color: transparent !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; margin: 0; pointer-events: none; display: flex; line-height: 1; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; border: none !important; border-width: 0 !important; outline: none !important;" />
    </div>
  </div>

  <!-- Height field -->
  <div class="height-group" id="height-container"
       style="position: absolute; left: 179px; top: 183px; z-index: 9;">
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
      <input class="char-height" id="char-height" name="system.height" type="text" value="{{system.height}}" style="width: 65px; height: 35px; text-align: center; font-size: 19px; background-color: transparent !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; padding: 3px 2px 0 2px; margin: 0; border: none; box-shadow: none !important; pointer-events: auto; display: flex; align-items: center; justify-content: center; line-height: 1;" />
    </div>
  </div>

  <!-- Weight field -->
  <div class="weight-group" id="weight-container"
       style="position: absolute; left: 247px; top: 183px; z-index: 9;">
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
      <input class="char-weight" id="char-weight" name="system.weight" type="text" value="{{system.weight}}" style="width: 65px; height: 35px; text-align: center; font-size: 19px; background-color: transparent !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; padding: 3px 2px 0 2px; margin: 0; border: none; box-shadow: none !important; pointer-events: auto; display: flex; align-items: center; justify-content: center; line-height: 1;" />
    </div>
  </div>

  <!-- Background field -->
  <div class="background-group" id="background-container"
       style="position: absolute; left: 460px; top: 129px; z-index: 9;">
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; margin-bottom: -5px;">
      <select class="char-background" id="char-background" name="system.background" style="width: 133px; height: 34px; text-align: center; font-size: 24px; background-color: transparent !important; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 34px; padding: 2px; margin: 0; border: none; pointer-events: auto;">
 <option value="" {{#unless system.background}}selected{{/unless}}>-- Select Background --</option>
                  <option value="Actor" {{#if (eq system.background "Actor")}}selected{{/if}}>Actor</option>
                  <option value="Armorer" {{#if (eq system.background "Armorer")}}selected{{/if}}>Armorer</option>
                  <option value="Artisan" {{#if (eq system.background "Artisan")}}selected{{/if}}>Artisan</option>
                  <option value="Baker" {{#if (eq system.background "Baker")}}selected{{/if}}>Baker</option>
                  <option value="Banker" {{#if (eq system.background "Banker")}}selected{{/if}}>Banker</option>
                  <option value="Barber" {{#if (eq system.background "Barber")}}selected{{/if}}>Barber</option>
                  <option value="Barkeep" {{#if (eq system.background "Barkeep")}}selected{{/if}}>Barkeep</option>
                  <option value="Beggar" {{#if (eq system.background "Beggar")}}selected{{/if}}>Beggar</option>
                  <option value="Blacksmith" {{#if (eq system.background "Blacksmith")}}selected{{/if}}>Blacksmith</option>
                  <option value="Bookbinder" {{#if (eq system.background "Bookbinder")}}selected{{/if}}>Bookbinder</option>
                  <option value="Bouncer" {{#if (eq system.background "Bouncer")}}selected{{/if}}>Bouncer</option>
                  <option value="Bowyer" {{#if (eq system.background "Bowyer")}}selected{{/if}}>Bowyer</option>
                  <option value="Brewer" {{#if (eq system.background "Brewer")}}selected{{/if}}>Brewer</option>
                  <option value="Bricklayer" {{#if (eq system.background "Bricklayer")}}selected{{/if}}>Bricklayer</option>
                  <option value="Butcher" {{#if (eq system.background "Butcher")}}selected{{/if}}>Butcher</option>
                  <option value="Caretaker" {{#if (eq system.background "Caretaker")}}selected{{/if}}>Caretaker</option>
                  <option value="Carpenter" {{#if (eq system.background "Carpenter")}}selected{{/if}}>Carpenter</option>
                  <option value="Cartographer" {{#if (eq system.background "Cartographer")}}selected{{/if}}>Cartographer</option>
                  <option value="Charcoal Maker" {{#if (eq system.background "Charcoal Maker")}}selected{{/if}}>Charcoal Maker</option>
                  <option value="Clerk" {{#if (eq system.background "Clerk")}}selected{{/if}}>Clerk</option>
                  <option value="Coachman" {{#if (eq system.background "Coachman")}}selected{{/if}}>Coachman</option>
                  <option value="Cobbler" {{#if (eq system.background "Cobbler")}}selected{{/if}}>Cobbler</option>
                  <option value="Cook" {{#if (eq system.background "Cook")}}selected{{/if}}>Cook</option>
                  <option value="Cooper" {{#if (eq system.background "Cooper")}}selected{{/if}}>Cooper</option>
                  <option value="Courier" {{#if (eq system.background "Courier")}}selected{{/if}}>Courier</option>
                  <option value="Crier" {{#if (eq system.background "Crier")}}selected{{/if}}>Crier</option>
                  <option value="Dairyboy" {{#if (eq system.background "Dairyboy")}}selected{{/if}}>Dairyboy</option>
                  <option value="Distiller" {{#if (eq system.background "Distiller")}}selected{{/if}}>Distiller</option>
                  <option value="Ditch Digger" {{#if (eq system.background "Ditch Digger")}}selected{{/if}}>Ditch Digger</option>
                  <option value="Dyer" {{#if (eq system.background "Dyer")}}selected{{/if}}>Dyer</option>
                  <option value="Engraver" {{#if (eq system.background "Engraver")}}selected{{/if}}>Engraver</option>
                  <option value="Entertainer" {{#if (eq system.background "Entertainer")}}selected{{/if}}>Entertainer</option>
                  <option value="Falconer" {{#if (eq system.background "Falconer")}}selected{{/if}}>Falconer</option>
                  <option value="Farmer" {{#if (eq system.background "Farmer")}}selected{{/if}}>Farmer</option>
                  <option value="Ferrier" {{#if (eq system.background "Ferrier")}}selected{{/if}}>Ferrier</option>
                  <option value="Fishmonger" {{#if (eq system.background "Fishmonger")}}selected{{/if}}>Fishmonger</option>
                  <option value="Fletcher" {{#if (eq system.background "Fletcher")}}selected{{/if}}>Fletcher</option>
                  <option value="Fuller" {{#if (eq system.background "Fuller")}}selected{{/if}}>Fuller</option>
                  <option value="Furrier" {{#if (eq system.background "Furrier")}}selected{{/if}}>Furrier</option>
                  <option value="Gardener" {{#if (eq system.background "Gardener")}}selected{{/if}}>Gardener</option>
                  <option value="Glassblower" {{#if (eq system.background "Glassblower")}}selected{{/if}}>Glassblower</option>
                  <option value="Glazier" {{#if (eq system.background "Glazier")}}selected{{/if}}>Glazier</option>
                  <option value="Glover" {{#if (eq system.background "Glover")}}selected{{/if}}>Glover</option>
                  <option value="Gong Farmer" {{#if (eq system.background "Gong Farmer")}}selected{{/if}}>Gong Farmer</option>
                  <option value="Gravedigger" {{#if (eq system.background "Gravedigger")}}selected{{/if}}>Gravedigger</option>
                  <option value="Groom" {{#if (eq system.background "Groom")}}selected{{/if}}>Groom</option>
                  <option value="Guard" {{#if (eq system.background "Guard")}}selected{{/if}}>Guard</option>
                  <option value="Hatmaker" {{#if (eq system.background "Hatmaker")}}selected{{/if}}>Hatmaker</option>
                  <option value="Herdsman" {{#if (eq system.background "Herdsman")}}selected{{/if}}>Herdsman</option>
                  <option value="Houndsman" {{#if (eq system.background "Houndsman")}}selected{{/if}}>Houndsman</option>
                  <option value="Innkeeper" {{#if (eq system.background "Innkeeper")}}selected{{/if}}>Innkeeper</option>
                  <option value="Jailer" {{#if (eq system.background "Jailer")}}selected{{/if}}>Jailer</option>
                  <option value="Jester" {{#if (eq system.background "Jester")}}selected{{/if}}>Jester</option>
                  <option value="Joiner" {{#if (eq system.background "Joiner")}}selected{{/if}}>Joiner</option>
                  <option value="Juggler" {{#if (eq system.background "Juggler")}}selected{{/if}}>Juggler</option>
                  <option value="Laborer" {{#if (eq system.background "Laborer")}}selected{{/if}}>Laborer</option>
                  <option value="Launderer" {{#if (eq system.background "Launderer")}}selected{{/if}}>Launderer</option>
                  <option value="Lector" {{#if (eq system.background "Lector")}}selected{{/if}}>Lector</option>
                  <option value="Librarian" {{#if (eq system.background "Librarian")}}selected{{/if}}>Librarian</option>
                  <option value="Lumberjack" {{#if (eq system.background "Lumberjack")}}selected{{/if}}>Lumberjack</option>
                  <option value="Maid/Butler" {{#if (eq system.background "Maid/Butler")}}selected{{/if}}>Maid/Butler</option>
                  <option value="Mason" {{#if (eq system.background "Mason")}}selected{{/if}}>Mason</option>
                  <option value="Merchant" {{#if (eq system.background "Merchant")}}selected{{/if}}>Merchant</option>
                  <option value="Messenger" {{#if (eq system.background "Messenger")}}selected{{/if}}>Messenger</option>
                  <option value="Miller" {{#if (eq system.background "Miller")}}selected{{/if}}>Miller</option>
                  <option value="Millwright" {{#if (eq system.background "Millwright")}}selected{{/if}}>Millwright</option>
                  <option value="Mortician" {{#if (eq system.background "Mortician")}}selected{{/if}}>Mortician</option>
                  <option value="Musician" {{#if (eq system.background "Musician")}}selected{{/if}}>Musician</option>
                  <option value="Ne'er-do-well" {{#if (eq system.background "Ne'er-do-well")}}selected{{/if}}>Ne'er-do-well</option>
                  <option value="Page" {{#if (eq system.background "Page")}}selected{{/if}}>Page</option>
                  <option value="Painter" {{#if (eq system.background "Painter")}}selected{{/if}}>Painter</option>
                  <option value="Philosopher" {{#if (eq system.background "Philosopher")}}selected{{/if}}>Philosopher</option>
                  <option value="Porter" {{#if (eq system.background "Porter")}}selected{{/if}}>Porter</option>
                  <option value="Potter" {{#if (eq system.background "Potter")}}selected{{/if}}>Potter</option>
                  <option value="Printer" {{#if (eq system.background "Printer")}}selected{{/if}}>Printer</option>
                  <option value="Prostitute" {{#if (eq system.background "Prostitute")}}selected{{/if}}>Prostitute</option>
                  <option value="Rag & Bone" {{#if (eq system.background "Rag & Bone")}}selected{{/if}}>Rag & Bone</option>
                  <option value="Ratter" {{#if (eq system.background "Ratter")}}selected{{/if}}>Ratter</option>
                  <option value="Runaway Slave" {{#if (eq system.background "Runaway Slave")}}selected{{/if}}>Runaway Slave</option>
                  <option value="Scavenger" {{#if (eq system.background "Scavenger")}}selected{{/if}}>Scavenger</option>
                  <option value="Scholar" {{#if (eq system.background "Scholar")}}selected{{/if}}>Scholar</option>
                  <option value="Serf" {{#if (eq system.background "Serf")}}selected{{/if}}>Serf</option>
                  <option value="Server" {{#if (eq system.background "Server")}}selected{{/if}}>Server</option>
                  <option value="Sexton" {{#if (eq system.background "Sexton")}}selected{{/if}}>Sexton</option>
                  <option value="Squire" {{#if (eq system.background "Squire")}}selected{{/if}}>Squire</option>
                  <option value="Stablehand" {{#if (eq system.background "Stablehand")}}selected{{/if}}>Stablehand</option>
                  <option value="Stonecutter" {{#if (eq system.background "Stonecutter")}}selected{{/if}}>Stonecutter</option>
                  <option value="Street Sweeper" {{#if (eq system.background "Street Sweeper")}}selected{{/if}}>Street Sweeper</option>
                  <option value="Tailor" {{#if (eq system.background "Tailor")}}selected{{/if}}>Tailor</option>
                  <option value="Tallow Chandler" {{#if (eq system.background "Tallow Chandler")}}selected{{/if}}>Tallow Chandler</option>
                  <option value="Tanner" {{#if (eq system.background "Tanner")}}selected{{/if}}>Tanner</option>
                  <option value="Thatcher" {{#if (eq system.background "Thatcher")}}selected{{/if}}>Thatcher</option>
                  <option value="Tobacconist" {{#if (eq system.background "Tobacconist")}}selected{{/if}}>Tobacconist</option>
                  <option value="Trapper" {{#if (eq system.background "Trapper")}}selected{{/if}}>Trapper</option>
                  <option value="Wainwright" {{#if (eq system.background "Wainwright")}}selected{{/if}}>Wainwright</option>
                  <option value="Washer" {{#if (eq system.background "Washer")}}selected{{/if}}>Washer</option>
                  <option value="Weaver" {{#if (eq system.background "Weaver")}}selected{{/if}}>Weaver</option>
                  <option value="Wheelwright" {{#if (eq system.background "Wheelwright")}}selected{{/if}}>Wheelwright</option>
                  <option value="Winemaker" {{#if (eq system.background "Winemaker")}}selected{{/if}}>Winemaker</option>
                  <option value="Woodcutter" {{#if (eq system.background "Woodcutter")}}selected{{/if}}>Woodcutter</option>
      </select>
    </div>
  </div>

  <!-- Languages field -->
  <div class="languages-group" id="languages-container"
       style="position: absolute; left: 318px; top: 183px; z-index: 9; pointer-events: auto;">
    <div class="char-field-group" style="display: flex; flex-direction: column; align-items: center; pointer-events: auto;">
      <div class="languages-row open-language-dialog" style="width: 272px; height: 33px; background-color: transparent !important; min-height: 30px; cursor: pointer; border: none !important; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; pointer-events: auto; padding: 2px; z-index: 101; display: flex; align-items: center; justify-content: center;" title="Click to add languages">
        <div class="languages-tags" style="display: flex; background: transparent !important; border: none !important; pointer-events: auto; text-align: center; width: 100%; line-height: 1; white-space: nowrap; overflow: hidden; align-items: center; justify-content: center; height: 100%;"></div>
      </div>
      <input type="hidden" name="system.languages" class="char-languages" value="{{system.languages}}" />
    </div>
  </div>

  <!-- XP Mod % field -->
  <div class="xp-mod-group" id="xp-mod-container"
       style="position: absolute; left: 530px; top: 20px; z-index: 9;">
    <input type="text" class="xp-mod-display" id="xp-mod-display" readonly 
           style="width: 64px; height: 34px; text-align: center; font-size: 24px; 
                  background-color: transparent !important; border: none; 
                  box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; 
                  padding: 4px 0 0 0; margin: 0; line-height: 1; color: inherit; pointer-events: none;
                  display: flex; align-items: center; justify-content: center;" />
  </div>

  <!-- XP field -->
  <div class="xp-group" id="xp-container"
       style="position: absolute; left: 319px; top: 74px; z-index: 15;">
    <input type="text" class="xp-display" id="xp-display" name="system.xp" value="{{system.xp}}"
           style="width: 134px; height: 34px; text-align: center; font-size: 24px; 
                  background-color: transparent !important; border: none; 
                  box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; 
                  padding: 5px 0 0 0; margin: 0; line-height: 1; color: inherit; cursor: pointer; pointer-events: auto;
                  display: flex; align-items: center; justify-content: center;" />
  </div>

  <!-- Next Level field -->
  <div class="next-level-group" id="next-level-container"
       style="position: absolute; left: 460px; top: 74px; z-index: 9;">
    <input type="text" class="next-level-display" id="next-level-display" readonly
           style="width: 134px; height: 34px; text-align: center; font-size: 24px; 
                  background-color: transparent !important; border: none; 
                  box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8) !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; 
                  padding: 5px 0 0 0; margin: 0; line-height: 1; color: inherit; cursor: default; pointer-events: none;
                  display: flex; align-items: center; justify-content: center;" />
  </div>
      
      <!-- Horizontal separator line at bottom of static header -->
      <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 1px; background-color: #000; z-index: 15;"></div>
      
    </div>

    <!-- Right-side Tab Navigation -->
    <nav class="sheet-tabs tabs" data-group="primary">
      <a class="item" data-tab="combat">Combat</a>
      <a class="item" data-tab="skills">Skills</a>
      <a class="item" data-tab="equipment">Equipment</a>
      <a class="item" data-tab="bio">Bio</a>
    </nav>

    <!-- Sheet Body - Tab Content Area -->
    <section class="sheet-body" style="position: absolute; top: 350px; left: 0; right: 0; bottom: 0; padding: 1rem 0.75rem; overflow-y: auto;">
      <!-- Combat Tab -->
      <div class="tab" data-group="primary" data-tab="combat">
        <div class="combat-section">
          <div class="combat-stats" style="display: flex; gap: 1.5rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap;">
            <div class="combat-stat" style="display: flex; flex-direction: column; align-items: center;">
              <label for="char-ac" style="margin-bottom: 0.5rem; font-size: 1.1rem;">Armor Class</label>
              <input class="char-ac" id="char-ac" name="system.ac" type="number" value="{{system.ac}}" min="0" max="20" style="width: 80px; height: 40px; text-align: center; font-size: 1.2rem; border: 2px solid #4a5568; border-radius: 8px; background-color: white;" />
            </div>
            <div class="combat-stat" style="display: flex; flex-direction: column; align-items: center;">
              <label style="margin-bottom: 0.5rem; font-size: 1.1rem;">Unarmored AC</label>
              <div style="width: 80px; height: 40px; text-align: center; font-size: 1.2rem; border: 2px solid #4a5568; border-radius: 8px; display: flex; align-items: center; justify-content: center; background-color: white;">
                {{unarmoredAC system.attributes.dex.value}}
              </div>
            </div>
            <div class="combat-stat" style="display: flex; flex-direction: column; align-items: center;">
              <label for="char-hp" style="margin-bottom: 0.5rem; font-size: 1.1rem;">Current HP</label>
              <input class="char-hp" id="char-hp" name="system.hitpoints" type="number" value="{{system.hitpoints}}" min="0" style="width: 80px; height: 40px; text-align: center; font-size: 1.2rem; border: 2px solid #4a5568; border-radius: 8px; background-color: white;" />
            </div>
            <div class="combat-stat" style="display: flex; flex-direction: column; align-items: center;">
              <label for="char-max-hp" style="margin-bottom: 0.5rem; font-size: 1.1rem;">Max HP</label>
              <input class="char-max-hp" id="char-max-hp" name="system.maxhitpoints" type="number" value="{{system.maxhitpoints}}" min="0" style="width: 80px; height: 40px; text-align: center; font-size: 1.2rem; border: 2px solid #4a5568; border-radius: 8px; background-color: white;" />
            </div>
          </div>

          <!-- Saving Throw Groups - Positioned relative to combat section -->
          <!-- Death Ray/Poison Group -->
          <div class="save-group-death" style="position: relative; display: inline-block; margin: 0 10px;">
            <div class="save death-save" style="position: relative; display: flex; flex-direction: column; align-items: center; width: 80px; height: 80px; overflow: visible;">
              <div style="width: 75px; height: 75px; border: 2px solid #4a5568; border-radius: 50%; position: relative; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);">
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) translateY(5px); font-size: 60px; line-height: 1; font-family: 'Minion Pro', serif; letter-spacing: -1px;">{{saves.death.value}}</span>
              </div>
            </div>
            <div class="save-label-death" style="position: absolute; left: -161px; top: 14px; width: 400px; height: 60px; overflow: visible; z-index: 15; pointer-events: none;">
              <svg width="400" height="60" style="overflow: visible;">
                <defs>
                  <path id="deathTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text style="font-family: 'Minion Pro', serif; font-size: 14px; fill: #000; letter-spacing: 0.5px;">
                  <textPath href="#deathTextPath" startOffset="50%" text-anchor="middle">
                    Death / Poison
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Wands Group -->
          <div class="save-group-wands" style="position: relative; display: inline-block; margin: 0 10px;">
            <div class="save wands-save" style="position: relative; display: flex; flex-direction: column; align-items: center; width: 80px; height: 80px; overflow: visible;">
              <div style="width: 75px; height: 75px; border: 2px solid #4a5568; border-radius: 50%; position: relative; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);">
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) translateY(5px); font-size: 60px; line-height: 1; font-family: 'Minion Pro', serif; letter-spacing: -1px;">{{saves.wands.value}}</span>
              </div>
            </div>
            <div class="save-label-wands" style="position: absolute; left: -161px; top: 14px; width: 400px; height: 60px; overflow: visible; z-index: 15; pointer-events: none;">
              <svg width="400" height="60" style="overflow: visible;">
                <defs>
                  <path id="wandsTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text style="font-family: 'Minion Pro', serif; font-size: 14px; fill: #000; letter-spacing: 0.8px;">
                  <textPath href="#wandsTextPath" startOffset="50%" text-anchor="middle">
                    Wands
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Paralysis Group -->
          <div class="save-group-paralysis" style="position: relative; display: inline-block; margin: 0 10px;">
            <div class="save paralysis-save" style="position: relative; display: flex; flex-direction: column; align-items: center; width: 80px; height: 80px; overflow: visible;">
              <div style="width: 75px; height: 75px; border: 2px solid #4a5568; border-radius: 50%; position: relative; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);">
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) translateY(5px); font-size: 60px; line-height: 1; font-family: 'Minion Pro', serif; letter-spacing: -1px;">{{saves.paralysis.value}}</span>
              </div>
            </div>
            <div class="save-label-paralysis" style="position: absolute; left: -161px; top: 14px; width: 400px; height: 60px; overflow: visible; z-index: 15; pointer-events: none;">
              <svg width="400" height="60" style="overflow: visible;">
                <defs>
                  <path id="paralysisTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text style="font-family: 'Minion Pro', serif; font-size: 14px; fill: #000; letter-spacing: 0.3px;">
                  <textPath href="#paralysisTextPath" startOffset="50%" text-anchor="middle">
                    Paralysis / Petrification
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Breath Attacks Group -->
          <div class="save-group-breath" style="position: relative; display: inline-block; margin: 0 10px;">
            <div class="save breath-save" style="position: relative; display: flex; flex-direction: column; align-items: center; width: 80px; height: 80px; overflow: visible;">
              <div style="width: 75px; height: 75px; border: 2px solid #4a5568; border-radius: 50%; position: relative; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);">
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) translateY(5px); font-size: 60px; font-weight: normal; line-height: 1; font-family: 'Minion Pro', serif; letter-spacing: -1px;">{{saves.breath.value}}</span>
              </div>
            </div>
            <div class="save-label-breath" style="position: absolute; left: -161px; top: 14px; width: 400px; height: 60px; overflow: visible; z-index: 15; pointer-events: none;">
              <svg width="400" height="60" style="overflow: visible;">
                <defs>
                  <path id="breathTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text style="font-family: 'Minion Pro', serif; font-size: 14px; font-weight: normal; fill: #000; letter-spacing: 0.8px;">
                  <textPath href="#breathTextPath" startOffset="50%" text-anchor="middle">
                    Breath Attacks
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Spells/Rods/Staves Group -->
          <div class="save-group-spells" style="position: relative; display: inline-block; margin: 0 10px;">
            <div class="save spells-save" style="position: relative; display: flex; flex-direction: column; align-items: center; width: 80px; height: 80px; overflow: visible;">
              <div style="width: 75px; height: 75px; border: 2px solid #4a5568; border-radius: 50%; position: relative; background-color: white; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);">
                <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) translateY(5px); font-size: 60px; font-weight: normal; line-height: 1; font-family: 'Minion Pro', serif; letter-spacing: -1px;">{{saves.spells.value}}</span>
              </div>
            </div>
            <div class="save-label-spells" style="position: absolute; left: -161px; top: 14px; width: 400px; height: 60px; overflow: visible; z-index: 15; pointer-events: none;">
              <svg width="400" height="60" style="overflow: visible;">
                <defs>
                  <path id="spellsTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text style="font-family: 'Minion Pro', serif; font-size: 14px; font-weight: normal; fill: #000; letter-spacing: 0.5px;">
                  <textPath href="#spellsTextPath" startOffset="50%" text-anchor="middle">
                    Spells / Rods / Staves
                  </textPath>
                </text>
              </svg>
            </div>
          </div>
        </div>
      </div>
      <!-- Skills Tab -->
  <div class="tab" data-group="primary" data-tab="skills" style="position: relative;">
        <!-- Ability Scores Section -->
        <div class="ability-scores-section" style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap;">
          
          <!-- STR Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Minion Pro', serif; letter-spacing: 0.03em;">STR</label>
            <select class="attr-str" id="attr-str" name="system.attributes.str.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: normal; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.str.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
          <!-- DEX Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Minion Pro', serif; letter-spacing: 0.03em;">DEX</label>
            <select class="attr-dex" id="attr-dex" name="system.attributes.dex.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: normal; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.dex.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
          <!-- CON Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Minion Pro', serif; letter-spacing: 0.03em;">CON</label>
            <select class="attr-con" id="attr-con" name="system.attributes.con.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: normal; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.con.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
          <!-- INT Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Minion Pro', serif; letter-spacing: 0.03em;">INT</label>
            <select class="attr-int" id="attr-int" name="system.attributes.int.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: normal; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.int.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
          <!-- WIS Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Minion Pro', serif; letter-spacing: 0.03em;">WIS</label>
            <select class="attr-wis" id="attr-wis" name="system.attributes.wis.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: normal; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.wis.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
          <!-- CHA Ability Score -->
          <div class="ability" style="display: flex; flex-direction: column; align-items: center;">
            <label style="font-size: 45px; font-family: 'Minion Pro', serif; letter-spacing: 0.03em;">CHA</label>
            <select class="attr-cha" id="attr-cha" name="system.attributes.cha.value" style="width: 75px; height: 75px; text-align: center; font-size: 70px; font-weight: normal; background-color: white !important; appearance: none; -webkit-appearance: none; -moz-appearance: none; line-height: 1; padding: 8px 3px 0px 0px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 9px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15), inset -2px -2px 3px rgba(255,255,255,0.8);">
              {{#each (range 3 18) as |val|}}
                <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.cha.value) val)}}selected{{/if}}>{{val}}</option>
              {{/each}}
            </select>
          </div>
          
        </div>
        
        <!-- Additional Skills content can go here -->
        
      </div>
      <!-- Equipment Tab -->
      <div class="tab" data-group="primary" data-tab="equipment">
        <section class="equipment-tab">
          {{!-- Weapons Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Weapons</div>
              <div class="field-short">Damage</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="weapon" title="Add Weapon">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each weapons as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow {{#if item.isWeapon}}item-rollable{{/if}}">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.damage}}</div>
                  <div class="field-short">{{item.system.weight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-hand"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                  {{#if item.displayTags}}
                  <div class="item-tags">
                    {{#each item.displayTags as |tag|}}
                    <span class="tag">{{tag.value}}</span>
                    {{/each}}
                  </div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Armor Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Armor</div>
              <div class="field-short">AC</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="armor" title="Add Armor">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each armor as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.ac.value}}</div>
                  <div class="field-short">{{item.system.weight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-tshirt"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Containers Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Containers</div>
              <div class="field-short">Capacity</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="container" title="Add Container">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each containers as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.capacity.value}}/{{item.system.capacity.max}}</div>
                  <div class="field-short">{{item.system.weight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-hand"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- General Items Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Items</div>
              <div class="field-short">Qty</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="item" title="Add Item">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each items as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short quantity">
                    <input 
                      value="{{item.system.quantity.value}}" 
                      type="number" 
                      min="0" 
                      data-field="system.quantity.value"
                      data-item-id="{{item.id}}"
                    />
                    {{#if item.system.quantity.max}}
                    <span>/{{item.system.quantity.max}}</span>
                    {{/if}}
                  </div>
                  <div class="field-short">{{multiply item.system.weight item.system.quantity.value}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-hand"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Treasure Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Treasure</div>
              <div class="field-short">Value</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="item" data-treasure="true" title="Add Treasure">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each treasures as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.cumulativeCost}} gp</div>
                  <div class="field-short">{{item.system.cumulativeWeight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Encumbrance Bar --}}
          <section class="encumbrance-section">
            <div class="encumbrance-label">Encumbrance</div>
            <div class="encumbrance-bar-container">
              <div class="encumbrance-bar" data-encumbrance="{{encumbrancePercentage}}"></div>
              <span class="encumbrance-text">{{totalWeight}} / {{maxWeight}} lbs</span>
            </div>
          </section>
          </section>
        </div>

      <!-- Bio Tab -->
      <div class="tab" data-group="primary" data-tab="bio">
        <div class="bio-content" style="padding: 1rem; display: flex; flex-direction: column; gap: 1rem;">          
          <!-- Character Appearance -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Appearance</h3>
            <textarea name="system.bio.appearance" placeholder="Describe your character's physical appearance..." 
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px; resize: vertical; font-family: inherit; background-color: white;">{{system.bio.appearance}}</textarea>
          </div>

          <!-- Character Personality -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Personality</h3>
            <textarea name="system.bio.personality" placeholder="Describe your character's personality, traits, and mannerisms..." 
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px; resize: vertical; font-family: inherit; background-color: white;">{{system.bio.personality}}</textarea>
          </div>

          <!-- Character Background/History -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Background & History</h3>
            <textarea name="system.bio.history" placeholder="Tell your character's story, background, and important life events..." 
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px; resize: vertical; font-family: inherit; background-color: white;">{{system.bio.history}}</textarea>
          </div>

          <!-- Character Goals & Motivations -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Goals & Motivations</h3>
            <textarea name="system.bio.goals" placeholder="What drives your character? What are their goals and motivations..." 
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px; resize: vertical; font-family: inherit; background-color: white;">{{system.bio.goals}}</textarea>
          </div>

          <!-- Additional Notes -->
          <div class="bio-section">
            <h3 style="margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ccc; font-size: 1.1em;">Additional Notes</h3>
            <textarea name="system.bio.notes" placeholder="Any additional notes, relationships, or important details..." 
                      style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px; resize: vertical; font-family: inherit; background-color: white;">{{system.bio.notes}}</textarea>
          </div>

        </div>
      </div>
    </section>
</form>
