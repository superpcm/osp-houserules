<form class="osp sheet actor character" autocomplete="off">
  <script>
    /* Styles moved to src/styles/_character-sheet.scss */
    function updateXPModifier() {
      const xpModField = document.getElementById('xp-mod-display');
      if (!xpModField) return;

      // Get current character data from form fields
      const characterClass = document.querySelector('.char-class')?.value || '';
      const attributes = {
        str: { value: parseInt(document.querySelector('.attr-str')?.value) || 10 },
        dex: { value: parseInt(document.querySelector('.attr-dex')?.value) || 10 },
        con: { value: parseInt(document.querySelector('.attr-con')?.value) || 10 },
        int: { value: parseInt(document.querySelector('.attr-int')?.value) || 10 },
        wis: { value: parseInt(document.querySelector('.attr-wis')?.value) || 10 },
        cha: { value: parseInt(document.querySelector('.attr-cha')?.value) || 10 }
      };

      // Calculate XP modifier using the same logic as the system
      const xpMod = calculateXPModifier(characterClass, attributes);

      // Format and display the modifier using utility
      const formattedMod = window.OSP?.NumberFormatter?.formatXPModifier(xpMod) || `${xpMod}%`;
      xpModField.value = formattedMod;
    }

    // Function to format numbers with commas (uses simplified utility)
    function formatNumberWithCommas(num) {
      return window.OSP?.NumberFormatter?.formatWithCommas(num) || num.toString();
    }

    // Function to update XP display
    function updateXPDisplay() {
      const xpField = document.getElementById('xp-display');
      if (!xpField) return;

      // Check if we're in the middle of an XP update by our handler
      // If so, don't interfere with the display
      if (window.xpHandlerUpdating) return;

      // Only format if not currently focused (to avoid interfering with user input)
      if (document.activeElement !== xpField) {
        const currentXP = parseInt(xpField.value.replace(/,/g, '')) || 0;
        xpField.value = formatNumberWithCommas(currentXP);
      }
    }

    // Function to handle XP field formatting
    function setupXPFieldFormatting() {
      const xpField = document.getElementById('xp-display');
      if (!xpField) return;

      // Create a function to clean XP field value before any form operation
      function cleanXPFieldForSubmission() {
        if (xpField && xpField.value) {
          const cleanValue = xpField.value.replace(/,/g, '');
          if (cleanValue !== xpField.value) {

            xpField.value = cleanValue;
          } else {

          }
        } else {

        }
      }

      // Function to restore XP formatting after form operations
      function restoreXPFormatting() {
        if (xpField && xpField.value && !xpField.value.includes(',')) {
          const numericValue = parseInt(xpField.value) || 0;
          if (numericValue >= 1000) { // Only format numbers 1000 and above
            const formattedValue = numericValue.toLocaleString();

            xpField.value = formattedValue;
          }
        }
      }

      // Add comprehensive debugging for XP field changes
      const logXPFieldState = (context) => {
        if (xpField) {

        }
      };

      // Add form submission handler to remove commas from XP field
      const form = xpField.closest('form');
      if (form) {


        // Handle form submit events
        form.addEventListener('submit', function(e) {

          isFormSubmitting = true;
          logXPFieldState('form submit');
          cleanXPFieldForSubmission();
          // Re-enable formatting after submission completes
          setTimeout(() => {
            isFormSubmitting = false;
            restoreXPFormatting();
          }, 100);
        });

        // Handle change events that might trigger auto-save
        form.addEventListener('change', function(e) {

          isFormSubmitting = true;
          logXPFieldState('form change');
          cleanXPFieldForSubmission();
          // Re-enable formatting after change completes
          setTimeout(() => {
            isFormSubmitting = false;
            restoreXPFormatting();
          }, 100);
        });

        // Also handle input events that might trigger form processing
        form.addEventListener('input', function(e) {
          if (e.target !== xpField) { // Don't interfere with XP field's own input handling

            isFormSubmitting = true;
            logXPFieldState('form input');
            cleanXPFieldForSubmission();
            // Re-enable formatting after input completes
            setTimeout(() => {
              isFormSubmitting = false;
              restoreXPFormatting();
            }, 100);
          }
        });

        // Set up a mutation observer to catch any form data collection
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && (
                mutation.attributeName === 'data-submitting' ||
                mutation.attributeName === 'data-processing'
            )) {

              cleanXPFieldForSubmission();
            }
          });
        });

        observer.observe(form, {
          attributes: true,
          attributeFilter: ['data-submitting', 'data-processing']
        });

        // Intercept any attempts to collect form data
        const originalFormData = window.FormData;
        let isIntercepting = false;

        function FormDataInterceptor(formElement) {
          if (!isIntercepting && formElement === form) {
            isIntercepting = true;

            cleanXPFieldForSubmission();
            setTimeout(() => { isIntercepting = false; }, 100);
          }
          return new originalFormData(...arguments);
        }

        // Copy prototype and properties
        FormDataInterceptor.prototype = originalFormData.prototype;
        Object.setPrototypeOf(FormDataInterceptor, originalFormData);

        // Temporarily replace FormData during critical operations
        const interceptFormData = () => {
          const originalFD = window.FormData;
          window.FormData = FormDataInterceptor;
          setTimeout(() => {
            if (window.FormData === FormDataInterceptor) {
              window.FormData = originalFD;
            }
          }, 1000);
        };

        // Set up interception on key events
        form.addEventListener('submit', interceptFormData);
        form.addEventListener('change', interceptFormData);
      }

      // Input validation - only allow numbers and commas - DISABLED for readonly field
      // xpField.addEventListener('input', function(e) {
      //   // Remove any non-digit characters except commas
      //   let value = this.value.replace(/[^\d,]/g, '');
      //
      //   // Remove commas, parse as number, then reformat with commas
      //   const numericValue = parseInt(value.replace(/,/g, '')) || 0;
      //
      //   // Only update if the field is focused (user is typing)
      //   if (document.activeElement === this) {
      //     // Just show the raw number while typing
      //     this.value = numericValue.toString();
      //   }
      // });

      // Format on blur (when user leaves the field) - DISABLED for readonly field
      // xpField.addEventListener('blur', function() {
      //   const value = parseInt(this.value.replace(/,/g, '')) || 0;
      //   this.value = formatNumberWithCommas(value);
      // });

      // Remove commas before change events (for auto-save) - DISABLED for readonly field
      // xpField.addEventListener('change', function() {
      //   const rawValue = this.value.replace(/,/g, '');
      //
      //   // Temporarily store raw value for form processing
      //   this.dataset.rawValue = rawValue;
      //
      //   // Temporarily clean for any immediate form processing
      //   this.value = rawValue;
      //
      //   // Restore formatting after a brief delay (unless we're in a form submission)
      //   setTimeout(() => {
      //     if (!isFormSubmitting && document.activeElement !== this) {
      //       const numericValue = parseInt(rawValue) || 0;
      //       if (numericValue >= 1000) {
      //         this.value = numericValue.toLocaleString();
      //
      //       }
      //     }
      //   }, 200);
      // });

      // Remove commas on focus (for easier editing) - DISABLED for readonly field
      // xpField.addEventListener('focus', function() {
      //   const value = parseInt(this.value.replace(/,/g, '')) || 0;
      //   this.value = value.toString();
      // });

      // Add a smart monitoring system that preserves display formatting but ensures clean form submissions
      let cleanupInterval;
      let monitoringPaused = false;
      let isFormSubmitting = false;

      const startXPMonitoring = () => {
        if (cleanupInterval) return; // Already running

        // DO NOT continuously clean the display - only during actual form submissions
        cleanupInterval = setInterval(() => {
          if (monitoringPaused) return; // Skip if paused

          // Only check if we're in the middle of a form submission
          if (isFormSubmitting && xpField && xpField.value && xpField.value.includes(',')) {
            const cleanValue = xpField.value.replace(/,/g, '');

            xpField.value = cleanValue;
          }
        }, 50); // Check frequently during form submissions
      };

      const stopXPMonitoring = () => {
        if (cleanupInterval) {
          clearInterval(cleanupInterval);
          cleanupInterval = null;
        }
      };

      const pauseXPMonitoring = () => {
        monitoringPaused = true;

      };

      const resumeXPMonitoring = () => {
        monitoringPaused = false;

      };

      // Export functions for portrait system
      window.pauseXPMonitoring = pauseXPMonitoring;
      window.resumeXPMonitoring = resumeXPMonitoring;

      // Start monitoring when document is ready
      startXPMonitoring();

      // Clean up interval when form is removed
      const formObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.removedNodes.forEach((node) => {
            if (node.contains && node.contains(xpField)) {
              stopXPMonitoring();
            }
          });
        });
      });

      formObserver.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    // Function to update Next Level display
    function updateNextLevelDisplay() {
      const nextLevelField = document.getElementById('next-level-display');
      if (!nextLevelField) return;

      // Get current level and class to calculate next level XP
      const level = parseInt(document.querySelector('input[name="system.level"]')?.value) || 1;
      const characterClass = document.querySelector('select[name="system.class"]')?.value || 'fighter';

      // Calculate next level XP using the same tables as the actor
      const nextLevelXP = calculateNextLevelXP(level, characterClass);
      nextLevelField.value = formatNumberWithCommas(nextLevelXP);
    }

    // Function to override XP Progress Handler formatting
    function formatExistingFields() {
      // Format XP display if it exists
      const xpField = document.getElementById('xp-display');
      if (xpField && xpField.value) {
        const currentXP = parseInt(xpField.value.replace(/,/g, '')) || 0;
        if (document.activeElement !== xpField) {
          xpField.value = formatNumberWithCommas(currentXP);
        }
      }

      // Format Next Level display if it exists
      const nextLevelField = document.getElementById('next-level-display');
      if (nextLevelField && nextLevelField.value) {
        const nextLevelXP = parseInt(nextLevelField.value.replace(/,/g, '')) || 0;
        nextLevelField.value = formatNumberWithCommas(nextLevelXP);
      }
    }

    // Function to calculate next level XP (uses centralized config)
    function calculateNextLevelXP(level, characterClass) {
      // Use the centralized config function made available globally
      if (window.OSP && window.OSP.getNextLevelXP) {
        return window.OSP.getNextLevelXP(characterClass, level);
      }
      
      // Fallback for development/testing (should not be needed in production)
      console.warn('OSP global config not available, using fallback XP calculation');
      return 2000; // Basic fallback
    }

    // XP Modifier calculation function (uses centralized config)
    function calculateXPModifier(characterClass, attributes) {
      // Use the centralized config function made available globally
      if (window.OSP && window.OSP.calculateXPModifier) {
        return window.OSP.calculateXPModifier(characterClass, attributes);
      }
      
      // Fallback for development/testing (should not be needed in production)
      console.warn('OSP global config not available, using fallback XP modifier calculation');
      return 0; // Basic fallback
    }

    // Function to run when DOM is ready
    function initializeCharacterSheet() {


      // Set encumbrance bar width after rendering
      const bar = document.querySelector('.encumbrance-bar[data-encumbrance]');
      if (bar) {
        const percent = bar.getAttribute('data-encumbrance');
        bar.style.width = percent + '%';
      }

      // Update XP Modifier display
      updateXPModifier();

      // Setup XP field formatting
      setupXPFieldFormatting();

      // Update XP display with comma formatting
      updateXPDisplay();

      // Update Next Level display
      updateNextLevelDisplay();

      // Set up periodic formatting to override XP progress handler
      setInterval(formatExistingFields, 500); // Run every 500ms to catch updates from XP progress handler

      // Add event listeners to update XP modifier when class or attributes change
      const classField = document.querySelector('select[name="system.class"]');
      const levelField = document.querySelector('input[name="system.level"]');
      const attributeFields = document.querySelectorAll('.attr-str, .attr-dex, .attr-con, .attr-int, .attr-wis, .attr-cha');

      if (classField) {
        classField.addEventListener('change', updateXPModifier);
        classField.addEventListener('change', updateNextLevelDisplay);
      }

      if (levelField) {
        levelField.addEventListener('change', updateNextLevelDisplay);
      }

      attributeFields.forEach(field => {
        field.addEventListener('change', updateXPModifier);
      });

      // Add event listener to update XP display when XP changes - DISABLED for readonly field
      const xpInput = document.querySelector('#xp-display');
      if (xpInput) {
        // xpInput.addEventListener('change', updateXPDisplay);
        // xpInput.addEventListener('input', updateXPDisplay);
      }

      // Ability Score Tooltips System
      const TOOLTIP_DELAY = 900; // Reduced delay for testing - was 800ms

      // Safe tooltip content setter: defaults to textContent, optionally allows HTML when explicitly requested
      function setTooltipContent(el, content, opts = { allowHtml: false }) {
        if (!el) return;
        const allowHtml = !!(opts && opts.allowHtml);
        if (allowHtml && window.DOMPurify) {
          try {
            el.innerHTML = window.DOMPurify.sanitize(String(content));
          } catch (err) {
            el.textContent = String(content);
          }
        } else if (allowHtml && !window.DOMPurify) {
          // Fallback: don't allow raw HTML if sanitizer is unavailable
          el.textContent = String(content);
        } else {
          el.textContent = String(content);
        }
      }

      const abilityScoreData = {
        "Strength": [
          { "score_range": "3", "melee": -3, "open_doors": "1-in-6" },
          { "score_range": "4-5", "melee": -2, "open_doors": "1-in-6" },
          { "score_range": "6-8", "melee": -1, "open_doors": "1-in-6" },
          { "score_range": "9-12", "melee": 0, "open_doors": "2-in-6" },
          { "score_range": "13-15", "melee": 1, "open_doors": "3-in-6" },
          { "score_range": "16-17", "melee": 2, "open_doors": "4-in-6" },
          { "score_range": "18", "melee": 3, "open_doors": "5-in-6" }
        ],
        "Intelligence": [
          { "score_range": "3", "languages": "Native (broken speech)", "literacy": "Illiterate" },
          { "score_range": "4-5", "languages": "Native", "literacy": "Illiterate" },
          { "score_range": "6-8", "languages": "Native", "literacy": "Basic" },
          { "score_range": "9-12", "languages": "Native", "literacy": "Literate" },
          { "score_range": "13-15", "languages": "Native +1 additional", "literacy": "Literate" },
          { "score_range": "16-17", "languages": "Native +2 additional", "literacy": "Literate" },
          { "score_range": "18", "languages": "Native +3 additional", "literacy": "Literate" }
        ],
        "Wisdom": [
          { "score_range": "3", "magic_saves": -3 },
          { "score_range": "4-5", "magic_saves": -2 },
          { "score_range": "6-8", "magic_saves": -1 },
          { "score_range": "9-12", "magic_saves": 0 },
          { "score_range": "13-15", "magic_saves": 1 },
          { "score_range": "16-17", "magic_saves": 2 },
          { "score_range": "18", "magic_saves": 3 }
        ],
        "Dexterity": [
          { "score_range": "3", "ac": -3, "missile": -3, "initiative": -2 },
          { "score_range": "4-5", "ac": -2, "missile": -2, "initiative": -1 },
          { "score_range": "6-8", "ac": -1, "missile": -1, "initiative": -1 },
          { "score_range": "9-12", "ac": 0, "missile": 0, "initiative": 0 },
          { "score_range": "13-15", "ac": 1, "missile": 1, "initiative": 1 },
          { "score_range": "16-17", "ac": 2, "missile": 2, "initiative": 1 },
          { "score_range": "18", "ac": 3, "missile": 3, "initiative": 2 }
        ],
        "Constitution": [
          { "score_range": "3", "hit_points": -3 },
          { "score_range": "4-5", "hit_points": -2 },
          { "score_range": "6-8", "hit_points": -1 },
          { "score_range": "9-12", "hit_points": 0 },
          { "score_range": "13-15", "hit_points": 1 },
          { "score_range": "16-17", "hit_points": 2 },
          { "score_range": "18", "hit_points": 3 }
        ],
        "Charisma": [
          { "score_range": "3", "npc_reactions": -2, "max_retainers": 1, "loyalty": 4 },
          { "score_range": "4-5", "npc_reactions": -1, "max_retainers": 2, "loyalty": 5 },
          { "score_range": "6-8", "npc_reactions": -1, "max_retainers": 3, "loyalty": 6 },
          { "score_range": "9-12", "npc_reactions": 0, "max_retainers": 4, "loyalty": 7 },
          { "score_range": "13-15", "npc_reactions": 1, "max_retainers": 5, "loyalty": 8 },
          { "score_range": "16-17", "npc_reactions": 1, "max_retainers": 6, "loyalty": 9 },
          { "score_range": "18", "npc_reactions": 2, "max_retainers": 7, "loyalty": 10 }
        ]
      };

      // Helper function to format modifier values
      function formatModifier(value) {
        if (typeof value === 'number') {
          return value > 0 ? `+${value}` : value.toString();
        }
        return value;
      }

      // Helper function to find score data based on ability score
      function getScoreData(abilityName, score) {
        const data = abilityScoreData[abilityName];
        if (!data) return null;

        for (const entry of data) {
          const range = entry.score_range;
          if (range.includes('-')) {
            const [min, max] = range.split('-').map(Number);
            if (score >= min && score <= max) return entry;
          } else {
            if (score === parseInt(range)) return entry;
          }
        }
        return null;
      }

      // Helper function to create tooltip content
      function createTooltipContent(abilityName, scoreData) {
        if (!scoreData) return '';

        const lines = [];

        if (abilityName === 'Strength') {
          lines.push(`Melee: ${formatModifier(scoreData.melee)}`);
          lines.push(`Open Doors: ${scoreData.open_doors}`);
        } else if (abilityName === 'Intelligence') {
          lines.push(`Languages: ${scoreData.languages}`);
          lines.push(`Literacy: ${scoreData.literacy}`);
        } else if (abilityName === 'Wisdom') {
          lines.push(`Magic Saves: ${formatModifier(scoreData.magic_saves)}`);
        } else if (abilityName === 'Dexterity') {
          lines.push(`AC: ${formatModifier(scoreData.ac)}`);
          lines.push(`Missile: ${formatModifier(scoreData.missile)}`);
          lines.push(`Initiative: ${formatModifier(scoreData.initiative)}`);
        } else if (abilityName === 'Constitution') {
          lines.push(`HP: ${formatModifier(scoreData.hit_points)}`);
        } else if (abilityName === 'Charisma') {
          lines.push(`NPC Reactions: ${formatModifier(scoreData.npc_reactions)}`);
          lines.push(`Max Retainers: ${scoreData.max_retainers}`);
          lines.push(`Loyalty: ${scoreData.loyalty}`);
        }

        return lines.join('<br>');
      }

      // Create tooltip element
  const tooltip = document.createElement('div');
  tooltip.id = 'ability-tooltip';
  // Use CSS class for visual styling; styles live in src/styles/_character-sheet.scss
  tooltip.className = 'cs-tooltip';
  document.body.appendChild(tooltip);

      let tooltipTimeout;

      // Setup tooltips for ability scores
      const abilityMappings = [
        { selector: '.attr-str', name: 'Strength' },
        { selector: '.attr-dex', name: 'Dexterity' },
        { selector: '.attr-con', name: 'Constitution' },
        { selector: '.attr-int', name: 'Intelligence' },
        { selector: '.attr-wis', name: 'Wisdom' },
        { selector: '.attr-cha', name: 'Charisma' }
      ];

      abilityMappings.forEach(({ selector, name }) => {
        const element = document.querySelector(selector);
        if (element) {
          element.addEventListener('mouseenter', (e) => {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
              const score = parseInt(element.value);
              const scoreData = getScoreData(name, score);
              const content = createTooltipContent(name, scoreData);

              if (content) {
                setTooltipContent(tooltip, content, { allowHtml: true });

                // Position tooltip above the element
                const rect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();

                tooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
                tooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
                tooltip.style.opacity = '1';
              }
            }, TOOLTIP_DELAY);
          });

          element.addEventListener('mouseleave', () => {
            clearTimeout(tooltipTimeout);
            tooltip.style.opacity = '0';
          });

          // Update tooltip when value changes
          element.addEventListener('change', () => {
            if (tooltip.style.opacity === '1') {
              const score = parseInt(element.value);
              const scoreData = getScoreData(name, score);
              const content = createTooltipContent(name, scoreData);
              if (content) {
                setTooltipContent(tooltip, content, { allowHtml: true });
              }
            }
          });
        }
      });

      // Setup dedicated tooltip for XP field with improved event handling
      setTimeout(() => {
        const xpElement = document.querySelector('#xp-display');
        if (xpElement) {


          // Create dedicated XP tooltip to avoid conflicts
          let xpTooltip = document.getElementById('xp-tooltip');
          if (!xpTooltip) {
            xpTooltip = document.createElement('div');
            xpTooltip.id = 'xp-tooltip';
            // Apply tooltip classes - visual styles handled by CSS
            xpTooltip.className = 'cs-tooltip cs-tooltip--xp';
            document.body.appendChild(xpTooltip);
          }
          let xpTooltipTimeout;

          // Remove any existing event listeners and add new ones
          xpElement.removeEventListener('mouseenter', xpElement._tooltipMouseEnter);
          xpElement.removeEventListener('mouseleave', xpElement._tooltipMouseLeave);
          xpElement.removeEventListener('mouseover', xpElement._tooltipMouseOver);
          xpElement.removeEventListener('mouseout', xpElement._tooltipMouseOut);

          xpElement._tooltipMouseEnter = (e) => {

            clearTimeout(xpTooltipTimeout);
            xpTooltipTimeout = setTimeout(() => {
              setTooltipContent(xpTooltip, 'Double-click to award XP');

              // Position tooltip above the element
              const rect = xpElement.getBoundingClientRect();
              const tooltipRect = xpTooltip.getBoundingClientRect();

              xpTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
              xpTooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
              xpTooltip.style.opacity = '1';

            }, TOOLTIP_DELAY);
          };

          xpElement._tooltipMouseLeave = () => {

            clearTimeout(xpTooltipTimeout);
            xpTooltip.style.opacity = '0';
          };

          // Try both mouseenter/mouseleave and mouseover/mouseout
          xpElement._tooltipMouseOver = xpElement._tooltipMouseEnter;
          xpElement._tooltipMouseOut = xpElement._tooltipMouseLeave;

          xpElement.addEventListener('mouseenter', xpElement._tooltipMouseEnter);
          xpElement.addEventListener('mouseleave', xpElement._tooltipMouseLeave);
          xpElement.addEventListener('mouseover', xpElement._tooltipMouseOver);
          xpElement.addEventListener('mouseout', xpElement._tooltipMouseOut);
        }
      }, 100);

      // Language Tooltip System
      setTimeout(() => {
        const languageElement = document.querySelector('.open-language-dialog');
        if (languageElement) {
          // Create dedicated language tooltip
          let languageTooltip = document.getElementById('language-tooltip');
          if (!languageTooltip) {
            languageTooltip = document.createElement('div');
            languageTooltip.id = 'language-tooltip';
            // Apply tooltip classes to match XP style
            languageTooltip.className = 'cs-tooltip cs-tooltip--xp';
            document.body.appendChild(languageTooltip);
          }
          let languageTooltipTimeout;

          // Remove any existing event listeners and add new ones
          languageElement.removeEventListener('mouseenter', languageElement._tooltipMouseEnter);
          languageElement.removeEventListener('mouseleave', languageElement._tooltipMouseLeave);
          languageElement.removeEventListener('mouseover', languageElement._tooltipMouseOver);
          languageElement.removeEventListener('mouseout', languageElement._tooltipMouseOut);

          languageElement._tooltipMouseEnter = (e) => {
            clearTimeout(languageTooltipTimeout);
            languageTooltipTimeout = setTimeout(() => {
              setTooltipContent(languageTooltip, 'Double-click to add languages');

              // Position tooltip above the element
              const rect = languageElement.getBoundingClientRect();
              const tooltipRect = languageTooltip.getBoundingClientRect();

              languageTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
              languageTooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
              languageTooltip.style.opacity = '1';

            }, TOOLTIP_DELAY);
          };

          languageElement._tooltipMouseLeave = () => {
            clearTimeout(languageTooltipTimeout);
            languageTooltip.style.opacity = '0';
          };

          // Try both mouseenter/mouseleave and mouseover/mouseout
          languageElement._tooltipMouseOver = languageElement._tooltipMouseEnter;
          languageElement._tooltipMouseOut = languageElement._tooltipMouseLeave;

          languageElement.addEventListener('mouseenter', languageElement._tooltipMouseEnter);
          languageElement.addEventListener('mouseleave', languageElement._tooltipMouseLeave);
          languageElement.addEventListener('mouseover', languageElement._tooltipMouseOver);
          languageElement.addEventListener('mouseout', languageElement._tooltipMouseOut);
        }
      }, 100);

      // Saving Throw Tooltips System
      function initializeSavingThrowTooltips() {


        // Get character data
        const race = (document.querySelector('#char-race')?.value || '').toLowerCase().trim();
        const characterClass = (document.querySelector('#char-class')?.value || '').toLowerCase().trim();
        const conScore = parseInt(document.querySelector('[name="system.abilities.con.value"]')?.value) || 10;



        // Check if character is an elf (race or class)
        const isElf = race === 'elf' || characterClass === 'elf';

        // Only show CON-based racial tooltips if race is different from class (race+class combo, not race-as-class)
        const showRacialBonuses = race && race !== characterClass;

        if (!showRacialBonuses && !isElf) {

          return;
        }

        // Calculate racial bonuses and special abilities
        function getRacialBonus(race, characterClass, saveType, conScore) {
          let bonus = 0;
          let description = '';

          // Elf paralysis immunity (works for race or class)
          const isElf = race === 'elf' || characterClass === 'elf';
          if (isElf && saveType === 'paralysis') {
            description = 'Unaffected by the paralysis that ghouls can inflict.';
            return { bonus, description };
          }

          // CON-based racial bonuses (only for race+class combinations, not race-as-class)
          if (!race || race === characterClass) {
            return { bonus, description };
          }

          if (race === 'dwarf') {
            if (saveType === 'death') { // Death Ray/Poison - only poison part
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Poison';
            } else if (saveType === 'wands' || saveType === 'spells') {
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Magic';
            }
          } else if (race === 'gnome') {
            if (saveType === 'wands' || saveType === 'spells') {
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Magic';
            }
          } else if (race === 'hobbit' || race === 'halfling') {
            if (saveType === 'death') { // Death Ray/Poison - only poison part
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Poison';
            } else if (saveType === 'wands' || saveType === 'spells') {
              if (conScore <= 6) bonus = 0;
              else if (conScore >= 7 && conScore <= 10) bonus = 2;
              else if (conScore >= 11 && conScore <= 14) bonus = 3;
              else if (conScore >= 15 && conScore <= 17) bonus = 4;
              else if (conScore >= 18) bonus = 5;
              description = '+' + bonus + ' vs Magic';
            }
          }

          return { bonus, description };
        }

        // Create tooltip element for saving throws
        let saveTooltip = document.getElementById('save-tooltip');
        if (!saveTooltip) {
          saveTooltip = document.createElement('div');
          saveTooltip.id = 'save-tooltip';
          saveTooltip.style.cssText = `
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.4;
            z-index: var(--z-overlay, 1000);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
          `;
          document.body.appendChild(saveTooltip);
        }

        let saveTooltipTimeout;

        // Setup tooltips for each saving throw
        const saveTypes = ['death', 'wands', 'paralysis', 'breath', 'spells'];

        saveTypes.forEach(saveType => {
          const saveElement = document.querySelector(`.save-group-${saveType} .save span`);
          if (!saveElement) return;

          const racialData = getRacialBonus(race, characterClass, saveType, conScore);

          // Show tooltip if there's a racial bonus OR if it's elf paralysis immunity
          if (racialData.bonus > 0 || racialData.description) {


            saveElement.addEventListener('mouseenter', () => {
              clearTimeout(saveTooltipTimeout);
              saveTooltipTimeout = setTimeout(() => {
                setTooltipContent(saveTooltip, racialData.description);
                saveTooltip.style.opacity = '1';

                // Position tooltip above the saving throw circle
                const rect = saveElement.getBoundingClientRect();
                const tooltipRect = saveTooltip.getBoundingClientRect();

                saveTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
                saveTooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';
              }, TOOLTIP_DELAY);
            });

            saveElement.addEventListener('mouseleave', () => {
              clearTimeout(saveTooltipTimeout);
              saveTooltip.style.opacity = '0';
            });
          }
        });
      }

      // Initialize saving throw tooltips after ability tooltips
      setTimeout(initializeSavingThrowTooltips, 100);



      // Portrait handling with delayed tooltip setup
      setTimeout(() => {
        const portraitDisplay = document.querySelector('.portrait-display');



        if (portraitDisplay) {


          // Create dedicated portrait tooltip to avoid conflicts with other tooltips
          let portraitTooltip = document.getElementById('portrait-tooltip');
          if (!portraitTooltip) {
            portraitTooltip = document.createElement('div');
            portraitTooltip.id = 'portrait-tooltip';
            portraitTooltip.className = 'cs-tooltip cs-tooltip--portrait';
            document.body.appendChild(portraitTooltip);
          }
          let portraitTooltipTimeout;

          // Remove any existing event listeners and add new ones  
          portraitDisplay.removeEventListener('mouseenter', portraitDisplay._tooltipMouseEnter);
          portraitDisplay.removeEventListener('mouseleave', portraitDisplay._tooltipMouseLeave);
          portraitDisplay.removeEventListener('mouseover', portraitDisplay._tooltipMouseOver);
          portraitDisplay.removeEventListener('mouseout', portraitDisplay._tooltipMouseOut);

          // Show portrait tooltip on hover
          portraitDisplay._tooltipMouseEnter = () => {

            clearTimeout(portraitTooltipTimeout);
            portraitTooltipTimeout = setTimeout(() => {
              const tipText = 'Double-click to select portrait • Right-click to adjust position';
              setTooltipContent(portraitTooltip, tipText);
              portraitTooltip.style.opacity = '1';
              const rect = portraitDisplay.getBoundingClientRect();
              const tooltipRect = portraitTooltip.getBoundingClientRect();
              portraitTooltip.style.left = (rect.left + rect.width / 2 - tooltipRect.width / 2) + 'px';
              portraitTooltip.style.top = (rect.top - tooltipRect.height - 8) + 'px';

            }, TOOLTIP_DELAY);
          };

          portraitDisplay._tooltipMouseLeave = () => {

            clearTimeout(portraitTooltipTimeout);
            portraitTooltip.style.opacity = '0';
          };

          // Try both mouseenter/mouseleave and mouseover/mouseout
          portraitDisplay._tooltipMouseOver = portraitDisplay._tooltipMouseEnter;
          portraitDisplay._tooltipMouseOut = portraitDisplay._tooltipMouseLeave;

          portraitDisplay.addEventListener('mouseenter', portraitDisplay._tooltipMouseEnter);
          portraitDisplay.addEventListener('mouseleave', portraitDisplay._tooltipMouseLeave);
          portraitDisplay.addEventListener('mouseover', portraitDisplay._tooltipMouseOver);
          portraitDisplay.addEventListener('mouseout', portraitDisplay._tooltipMouseOut);

        // Double-click on portrait opens Foundry file picker
        portraitDisplay.addEventListener('dblclick', async (event) => {


          try {
            // Use Foundry's FilePicker
            const fp = new FilePicker({
              type: "image",
              current: "",
              callback: (path) => {


                // Update the portrait display
                portraitDisplay.style.backgroundImage = `url('${path}')`;

                // Update the hidden input with the file path
                const portraitInput = document.querySelector('input[name="system.portrait"]');
                if (portraitInput) {
                  portraitInput.value = path;

                  // Trigger a change event to update the actor
                  const changeEvent = new Event('change', { bubbles: true });
                  portraitInput.dispatchEvent(changeEvent);
                }
              }
            });

            // Render the file picker
            fp.render(true);

          } catch (error) {

          }
        });

        // Right-click to show portrait adjustment controls
        portraitDisplay.addEventListener('contextmenu', (event) => {
          event.preventDefault();

          const controls = document.getElementById('portrait-controls');
          const container = document.getElementById('portrait-container');

          // Show controls and enter adjustment mode
          if (controls) {
            controls.style.display = 'block';


            // Add a global observer to see if something else is hiding the controls
            const observer = new MutationObserver((mutations) => {
              mutations.forEach((mutation) => {
                if (mutation.target === controls && mutation.attributeName === 'style') {


                }
              });
            });
            observer.observe(controls, { attributes: true, attributeFilter: ['style'] });

            // Store observer for cleanup
            controls._observer = observer;
          }
          if (container) {
            container.classList.add('adjusting');
          }

          // NO automatic hiding - only manual close via Done button
        });

          // Setup portrait adjustment functionality
          setupPortraitAdjustment();


        } else {

        }
      }, 100);
    }

    // Portrait adjustment system
    function setupPortraitAdjustment() {
      const controls = document.getElementById('portrait-controls');
      const container = document.getElementById('portrait-container');

      if (!controls || !container) {

        return;
      }

      // Get current values from CSS variables or defaults
      let scale = parseFloat(getComputedStyle(container).getPropertyValue('--user-portrait-scale')) || 1;
      let x = parseFloat(getComputedStyle(container).getPropertyValue('--user-portrait-x')) || 0;
      let y = parseFloat(getComputedStyle(container).getPropertyValue('--user-portrait-y')) || 0;

      // Add individual event listeners to each button with maximum event blocking
      const buttons = controls.querySelectorAll('button');


      buttons.forEach((button, index) => {


        // Block all possible events that could bubble
        ['mousedown', 'mouseup', 'click', 'pointerdown', 'pointerup'].forEach(eventType => {
          button.addEventListener(eventType, (event) => {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();

            // Only execute action on 'click'
            if (eventType !== 'click') return;

            const action = button.dataset.action;

            // Determine adjustment step size based on modifier keys
            // Shift = fine adjustments, Ctrl = very fine, no modifier = normal
            let scaleStep = 0.1;  // Normal scale step
            let moveStep = 3;     // Normal move step (pixels)
            
            if (event.shiftKey && event.ctrlKey) {
              // Very fine adjustments (Shift + Ctrl)
              scaleStep = 0.01;
              moveStep = 0.5;
            } else if (event.shiftKey) {
              // Fine adjustments (Shift only)
              scaleStep = 0.02;
              moveStep = 1;
            } else if (event.ctrlKey) {
              // Coarse adjustments (Ctrl only)
              scaleStep = 0.25;
              moveStep = 10;
            }
            // No modifier = normal (default values above)

            switch (action) {
              case 'zoom-in':
                scale = Math.min(scale + scaleStep, 2.5);
                updatePortrait();

                break;
              case 'zoom-out':
                scale = Math.max(scale - scaleStep, 0.5);
                updatePortrait();

                break;
              case 'move-up':
                y -= moveStep;
                updatePortrait();

                break;
              case 'move-down':
                y += moveStep;
                updatePortrait();

                break;
              case 'move-left':
                x -= moveStep;
                updatePortrait();

                break;
              case 'move-right':
                x += moveStep;
                updatePortrait();

                break;
              case 'reset':
                scale = 1;
                x = 0;
                y = 0;
                updatePortrait();

                break;
              case 'done':


                // Pause XP monitoring and mark form as submitting
                if (window.pauseXPMonitoring) {
                  window.pauseXPMonitoring();
                }
                isFormSubmitting = true;

                savePortraitData(); // Save the data to the actor

                // Resume normal operation after a delay
                setTimeout(() => {
                  isFormSubmitting = false;
                  if (window.resumeXPMonitoring) {
                    window.resumeXPMonitoring();
                  }
                  // Restore XP formatting
                  const xpField = document.getElementById('xp-display');
                  if (xpField && xpField.value && !xpField.value.includes(',')) {
                    const numericValue = parseInt(xpField.value) || 0;
                    if (numericValue >= 1000) {
                      const formattedValue = numericValue.toLocaleString();

                      xpField.value = formattedValue;
                    }
                  }
                }, 2000);

                if (controls._observer) {
                  controls._observer.disconnect();
                }
                controls.style.display = 'none';
                container.classList.remove('adjusting');

                break;
            }
          }, true); // Use capture phase
        });
      });

      // Update portrait transform and save data
      function updatePortrait() {
        // Update CSS variables
        container.style.setProperty('--user-portrait-scale', scale);
        container.style.setProperty('--user-portrait-x', x + 'px');
        container.style.setProperty('--user-portrait-y', y + 'px');

        // Update hidden form inputs for persistence (but don't trigger events yet)
        const scaleInput = document.querySelector('input[name="system.userPortrait.scale"]');
        const xInput = document.querySelector('input[name="system.userPortrait.x"]');
        const yInput = document.querySelector('input[name="system.userPortrait.y"]');

        if (scaleInput) scaleInput.value = scale;
        if (xInput) xInput.value = x;
        if (yInput) yInput.value = y;

        // Don't trigger change events immediately to prevent re-render
        // We'll save when the user clicks "Done" instead

      }

      // Function to save portrait data to actor (only called when Done)
      function savePortraitData() {


        // Clean XP field before save operations (unchanged)
        const xpField = document.getElementById('xp-display');
        if (xpField && xpField.value) {
          const cleanValue = xpField.value.replace(/,/g, '');
          if (cleanValue !== xpField.value) {

            xpField.value = cleanValue;
          }
        }

        // Gather update payload
        const updateData = {
          'system.userPortrait.scale': scale,
          'system.userPortrait.x': x,
          'system.userPortrait.y': y
        };

        // Helper: update hidden inputs to keep form in sync
        function syncHiddenInputs() {
          const scaleInput = document.querySelector('input[name="system.userPortrait.scale"]');
          const xInput = document.querySelector('input[name="system.userPortrait.x"]');
          const yInput = document.querySelector('input[name="system.userPortrait.y"]');
          if (scaleInput) { scaleInput.value = scale; scaleInput.setAttribute('value', scale); }
          if (xInput) { xInput.value = x; xInput.setAttribute('value', x); }
          if (yInput) { yInput.value = y; yInput.setAttribute('value', y); }
        }

        // Attempt 1: Use the sheet instance stored on the window (most reliable if set)
        try {
          if (window.currentActorSheet && window.currentActorSheet.actor) {
            const actor = window.currentActorSheet.actor;

            return actor.update(updateData, {render: false}).then(() => { syncHiddenInputs();  }).catch(err => { /* ignored */ });
          }
        } catch (err) {

        }

        // Attempt 2: Resolve via the containing window-app of the portrait container
        try {
          const container = document.getElementById('portrait-container');
          if (container) {
            const windowApp = container.closest('.window-app');
            if (windowApp) {
              const appId = windowApp.getAttribute('data-appid');
              if (appId && ui && ui.windows && ui.windows[appId] && ui.windows[appId].actor) {
                const actor = ui.windows[appId].actor;

                return actor.update(updateData, {render: false}).then(() => { syncHiddenInputs();  }).catch(err => { /* ignored */ });
              }
            }
          }
        } catch (err) {

        }

        // Attempt 3: Look for a form-bound actor id or known inputs
        try {
          const actorIdInput = document.querySelector('input[name="id"]');
          if (actorIdInput && actorIdInput.value) {
            const actor = game.actors.get(actorIdInput.value);
              if (actor) {

              return actor.update(updateData, {render: false}).then(() => { syncHiddenInputs();  }).catch(err => { /* ignored */ });
            }
          }
        } catch (err) {

        }

        // Attempt 4: Try to find actor id from URL
        try {
          const urlMatch = window.location.href.match(/actors\/([a-zA-Z0-9]+)/);
          if (urlMatch) {
            const actor = game.actors.get(urlMatch[1]);
            if (actor) {

              return actor.update(updateData, {render: false}).then(() => { syncHiddenInputs();  }).catch(err => { /* ignored */ });
            }
          }
        } catch (err) {

        }

        // Final fallback: update hidden inputs and try to trigger a change on a nearest form
        console.warn('All direct actor save methods failed; using form fallback');
        try {
          syncHiddenInputs();
          const nearestForm = document.getElementById('portrait-container')?.closest('form') || document.querySelector('form.flexcol') || document.querySelector('form');
          if (nearestForm) {
            // Dispatch an input/change event on the nearest inputs and the form
            const changeEvent = new Event('change', { bubbles: true });
            const scaleInput = document.querySelector('input[name="system.userPortrait.scale"]');
            if (scaleInput) scaleInput.dispatchEvent(changeEvent);
            nearestForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));

            return Promise.resolve();
          }
        } catch (err) {

        }


      }

      // Listening at Doors Management
      function updateListeningAtDoors() {
        const listeningField = document.getElementById('listening-doors');
        const raceField = document.getElementById('char-race');
        const classField = document.querySelector('select[name="system.class"]');
        
        if (!listeningField || !raceField || !classField) return;

        const race = raceField.value.toLowerCase();
        const characterClass = classField.value.toLowerCase();
        
        // Check if class is Thief or Assassin (editable)
        const isThiefAssassin = characterClass === 'thief' || characterClass === 'assassin';
        
        if (isThiefAssassin) {
          // Thief/Assassin: editable field, default to 1 if not set
          listeningField.disabled = false;
          if (!listeningField.value || listeningField.value === '') {
            listeningField.value = '1';
          }
        } else {
          // Other classes: read-only, set by race
          listeningField.disabled = true;
          
          // Set value based on race per OSE rules
          switch (race) {
            case 'human':
            case 'half-elf':
            case 'half-orc':
              listeningField.value = '1';
              break;
            case 'dwarf':
            case 'elf':
            case 'halfling':
            case 'hobbit':
            case 'gnome':
              listeningField.value = '2';
              break;
            default:
              listeningField.value = '1';
              break;
          }
        }
      }

      function updateOpenStuckDoors() {
        const openStuckDoorsField = document.getElementById('open-stuck-doors');
        const strField = document.getElementById('attr-str');
        
        if (!openStuckDoorsField || !strField) return;
        
        const strValue = parseInt(strField.value) || 10;
        let doorValue = '1';
        
        // OSE Open Doors chances based on STR
        if (strValue >= 3 && strValue <= 8) {
          doorValue = '1';
        } else if (strValue >= 9 && strValue <= 12) {
          doorValue = '2';
        } else if (strValue >= 13 && strValue <= 15) {
          doorValue = '3';
        } else if (strValue >= 16 && strValue <= 17) {
          doorValue = '4';
        } else if (strValue >= 18) {
          doorValue = '5';
        }
        
        openStuckDoorsField.value = doorValue;
        openStuckDoorsField.disabled = true; // Always read-only
      }

      function updateFindSecretDoor() {
        const findSecretDoorField = document.getElementById('find-secret-door');
        const raceField = document.getElementById('char-race');
        const classField = document.querySelector('select[name="system.class"]');
        
        if (!findSecretDoorField || !raceField || !classField) return;

        const race = raceField.value.toLowerCase();
        const characterClass = classField.value.toLowerCase();
        
        // Check if class is Thief, Assassin, or Barbarian (editable)
        const isEditableClass = characterClass === 'thief' || characterClass === 'assassin' || characterClass === 'barbarian';
        
        if (isEditableClass) {
          // Thief/Assassin/Barbarian: editable field, set default based on race if not set
          findSecretDoorField.disabled = false;
          if (!findSecretDoorField.value || findSecretDoorField.value === '') {
            // Set racial default for editable classes
            switch (race) {
              case 'elf':
              case 'half-elf':
                findSecretDoorField.value = '2';
                break;
              default:
                findSecretDoorField.value = '1';
                break;
            }
          }
        } else {
          // Other classes: read-only, set by race
          findSecretDoorField.disabled = true;
          
          // Set value based on race per OSE rules
          switch (race) {
            case 'elf':
            case 'half-elf':
              findSecretDoorField.value = '2';
              break;
            default:
              findSecretDoorField.value = '1';
              break;
          }
        }
      }

      function updateDetectConstruction() {
        const detectConstructionField = document.getElementById('detect-construction');
        const raceField = document.getElementById('char-race');
        
        if (!detectConstructionField || !raceField) return;

        const race = raceField.value.toLowerCase();
        
        // Only Dwarf and Gnome can use this ability - but field is read-only
        if (race === 'dwarf' || race === 'gnome') {
          detectConstructionField.disabled = true; // Always read-only
          detectConstructionField.value = '2'; // 2-in-6 for Dwarf/Gnome
        } else {
          // All other races cannot use this ability
          detectConstructionField.disabled = true;
          detectConstructionField.value = ''; // No number shown
        }
      }

      function updateDetectRoomTraps() {
        const detectRoomTrapsField = document.getElementById('detect-room-traps');
        const raceField = document.getElementById('char-race');
        
        if (!detectRoomTrapsField || !raceField) return;

        const race = raceField.value.toLowerCase();
        
        // Only Dwarf can use this ability - but field is read-only
        if (race === 'dwarf') {
          detectRoomTrapsField.disabled = true; // Always read-only
          detectRoomTrapsField.value = '2'; // 2-in-6 for Dwarf
        } else {
          // All other races cannot use this ability
          detectRoomTrapsField.disabled = true;
          detectRoomTrapsField.value = ''; // No number shown
        }
      }

      function updateBarbarianSkills() {
        const barbarianClimbField = document.getElementById('barbarian-climb');
        const barbarianHideField = document.getElementById('barbarian-hide');
        const barbarianMoveField = document.getElementById('barbarian-move');
        const classField = document.querySelector('select[name="system.class"]');
        const levelField = document.querySelector('input[name="system.level"]');
        
        if (!barbarianClimbField || !barbarianHideField || !barbarianMoveField || !classField || !levelField) return;

        // Get the parent divs to control visibility
        const barbarianClimbDiv = barbarianClimbField.closest('.listening-group');
        const barbarianHideDiv = barbarianHideField.closest('.listening-group');
        const barbarianMoveDiv = barbarianMoveField.closest('.listening-group');

        const characterClass = classField.value.toLowerCase();
        const level = parseInt(levelField.value) || 1;
        
        if (characterClass === 'barbarian') {
          // Show and configure Barbarian fields
          if (barbarianClimbDiv) barbarianClimbDiv.style.display = 'block';
          if (barbarianHideDiv) barbarianHideDiv.style.display = 'block';
          if (barbarianMoveDiv) barbarianMoveDiv.style.display = 'block';
          
          // Barbarian: read-only fields with level-based progression
          barbarianClimbField.disabled = true;
          barbarianHideField.disabled = true;
          barbarianMoveField.disabled = true;
          
          // Set values based on level progression
          // CS: Always 5-in-6
          barbarianClimbField.value = '5';
          
          // HD: 1-in-6 (levels 1-5), 2-in-6 (levels 6-10), 3-in-6 (levels 11-13), 4-in-6 (level 14)
          if (level <= 5) {
            barbarianHideField.value = '1';
          } else if (level <= 10) {
            barbarianHideField.value = '2';
          } else if (level <= 13) {
            barbarianHideField.value = '3';
          } else {
            barbarianHideField.value = '4';
          }
          
          // MS: 1-in-6 (levels 1-3), 2-in-6 (levels 4-10), 3-in-6 (levels 11+)
          if (level <= 3) {
            barbarianMoveField.value = '1';
          } else if (level <= 10) {
            barbarianMoveField.value = '2';
          } else {
            barbarianMoveField.value = '3';
          }
        } else {
          // Non-Barbarian: hide fields completely
          if (barbarianClimbDiv) barbarianClimbDiv.style.display = 'none';
          if (barbarianHideDiv) barbarianHideDiv.style.display = 'none';
          if (barbarianMoveDiv) barbarianMoveDiv.style.display = 'none';
          
          barbarianClimbField.disabled = true;
          barbarianHideField.disabled = true;
          barbarianMoveField.disabled = true;
          barbarianClimbField.value = '';
          barbarianHideField.value = '';
          barbarianMoveField.value = '';
        }
      }

      // Initialize listening at doors
      updateListeningAtDoors();
      
      // Initialize open stuck doors
      updateOpenStuckDoors();
      
      // Initialize find secret door
      updateFindSecretDoor();
      
      // Initialize detect construction
      updateDetectConstruction();
      
      // Initialize detect room traps
      updateDetectRoomTraps();
      
      // Initialize barbarian skills
      updateBarbarianSkills();

      // Add event listeners for race and class changes
      const raceField = document.getElementById('char-race');
      const classField = document.querySelector('select[name="system.class"]');
      const strField = document.getElementById('attr-str');
      
      if (raceField) {
        raceField.addEventListener('change', updateListeningAtDoors);
        raceField.addEventListener('change', updateFindSecretDoor);
        raceField.addEventListener('change', updateDetectConstruction);
        raceField.addEventListener('change', updateDetectRoomTraps);
      }
      if (classField) {
        classField.addEventListener('change', updateListeningAtDoors);
        classField.addEventListener('change', updateFindSecretDoor);
        classField.addEventListener('change', updateBarbarianSkills);
      }
      if (strField) {
        strField.addEventListener('change', updateOpenStuckDoors);
      }
      
      // Add level change listener for Barbarian skills
      const levelField = document.querySelector('input[name="system.level"]');
      if (levelField) {
        levelField.addEventListener('change', updateBarbarianSkills);
      }
    }

  // Check if DOM is already ready or wait for it
    if (document.readyState === 'loading') {

      document.addEventListener('DOMContentLoaded', initializeCharacterSheet);
    } else {

    // DOM is already ready, run immediately
    setTimeout(initializeCharacterSheet, 0);
  }
  </script>

  <!-- Position Adjustment Tool - Only active when debug borders are enabled -->
  <script>
    // Position Adjustment Tool - Only works when debug is enabled
    (function() {
      'use strict';
      
      let currentTool = null;
      let currentElement = null;
      let cssVariableMap = {}; // Maps element classes to their CSS variables
      
      // Initialize CSS variable mapping for positioned elements
      function initializeVariableMap() {
        cssVariableMap = {
          'cs-pos-name': { left: '$cs-pos-name-left', top: '$cs-pos-name-top' },
          'cs-pos-namegroup': { left: '$cs-pos-namegroup-left', top: '$cs-pos-namegroup-top' },
          'cs-pos-class': { left: '$cs-pos-class-left', top: '$cs-pos-class-top' },
          'cs-pos-alignment': { left: '$cs-pos-alignment-left', top: '$cs-pos-alignment-top' },
          'cs-pos-race': { left: '$cs-pos-race-left', top: '$cs-pos-race-top' },
          'cs-pos-age': { left: '$cs-pos-age-left', top: '$cs-pos-age-top' },
          'cs-pos-sex': { left: '$cs-pos-sex-left', top: '$cs-pos-sex-top' },
          'cs-pos-height': { left: '$cs-pos-height-left', top: '$cs-pos-height-top' },
          'cs-pos-weight': { left: '$cs-pos-weight-left', top: '$cs-pos-weight-top' },
          'cs-pos-background': { left: '$cs-pos-background-left', top: '$cs-pos-background-top' },
          'cs-pos-languages': { left: '$cs-pos-languages-left', top: '$cs-pos-languages-top' },
          'cs-pos-xp': { left: '$cs-pos-xp-left', top: '$cs-pos-xp-top' },
          'cs-pos-xpmod': { left: '$cs-pos-xpmod-left', top: '$cs-pos-xpmod-top' },
          'cs-pos-level': { left: '$cs-pos-level-left', top: '$cs-pos-level-top' },
          'cs-pos-portrait': { left: '$cs-pos-portrait-left', top: '$cs-pos-portrait-top' },
          'cs-pos-next': { left: '$cs-pos-next-left', top: '$cs-pos-next-top' },
          // Individual save value positioning
          'cs-pos-save-death': { left: '$cs-pos-save-death-left', top: '$cs-pos-save-death-top' },
          'cs-pos-save-wands': { left: '$cs-pos-save-wands-left', top: '$cs-pos-save-wands-top' },
          'cs-pos-save-paralysis': { left: '$cs-pos-save-paralysis-left', top: '$cs-pos-save-paralysis-top' },
          'cs-pos-save-breath': { left: '$cs-pos-save-breath-left', top: '$cs-pos-save-breath-top' },
          'cs-pos-save-spells': { left: '$cs-pos-save-spells-left', top: '$cs-pos-save-spells-top' },
          // Individual save label positioning
          'cs-pos-save-label-death': { left: '$cs-pos-save-label-death-left', top: '$cs-pos-save-label-death-top' },
          'cs-pos-save-label-wands': { left: '$cs-pos-save-label-wands-left', top: '$cs-pos-save-label-wands-top' },
          'cs-pos-save-label-paralysis': { left: '$cs-pos-save-label-paralysis-left', top: '$cs-pos-save-label-paralysis-top' },
          'cs-pos-save-label-breath': { left: '$cs-pos-save-label-breath-left', top: '$cs-pos-save-label-breath-top' },
          'cs-pos-save-label-spells': { left: '$cs-pos-save-label-spells-left', top: '$cs-pos-save-label-spells-top' },
          'cs-pos-save-label': { left: '$cs-pos-save-label-left', top: '$cs-pos-save-label-top' },
          // Add pseudo-positioning for elements that don't have dedicated CSS variables
          'ability-scores-section': { left: 'inline-left', top: 'inline-top' },
          'cs-combat-stats': { left: 'inline-left', top: 'inline-top' },
          'cs-save-group': { left: 'inline-left', top: 'inline-top' }
        };
      }
      
      // Check if debug borders are enabled by looking for the red dashed border style
      function isDebugEnabled() {
        const testEl = document.querySelector('.cs-char-name');
        if (!testEl) return false;
        const style = window.getComputedStyle(testEl);
        return style.borderStyle.includes('dashed') && style.borderColor.includes('rgb(255, 0, 0)');
      }
      
      // Get position class from element
      function getPositionClass(element) {
        const classes = Array.from(element.classList);
        const posClass = classes.find(cls => cls.startsWith('cs-pos-'));
        if (posClass) return posClass;
        
        // For elements without direct position classes, check their class names
        if (element.classList.contains('ability-scores-section')) return 'ability-scores-section';
        if (element.classList.contains('cs-combat-stats')) return 'cs-combat-stats';
        if (element.classList.contains('cs-save-group')) return 'cs-save-group';
        
        return null;
      }
      
      // Extract current pixel values from styles
      function getCurrentValues(element) {
        const rect = element.getBoundingClientRect();
        const style = window.getComputedStyle(element);
        
        // For position values, we need to handle elements positioned relative to their container
        let currentLeft = 0;
        let currentTop = 0;
        
        // If element already has inline positioning, use those values
        if (element.style.left) {
          currentLeft = parseInt(element.style.left);
        } else {
          // Calculate position relative to the offsetParent (positioning context)
          const parentRect = element.offsetParent ? element.offsetParent.getBoundingClientRect() : {left: 0, top: 0};
          currentLeft = Math.round(rect.left - parentRect.left);
        }
        
        if (element.style.top) {
          currentTop = parseInt(element.style.top);
        } else {
          // Calculate position relative to the offsetParent (positioning context)
          const parentRect = element.offsetParent ? element.offsetParent.getBoundingClientRect() : {left: 0, top: 0};
          currentTop = Math.round(rect.top - parentRect.top);
        }
        
        return {
          width: Math.round(rect.width),
          height: Math.round(rect.height),
          x: currentLeft,
          y: currentTop
        };
      }
      
      // Create the position adjustment tool UI
      function createPositionTool(element) {
        if (currentTool) {
          document.body.removeChild(currentTool);
        }
        
        const posClass = getPositionClass(element);
        if (!posClass || !cssVariableMap[posClass]) {
          console.warn('No CSS variable mapping found for element', element);
          return;
        }
        
        currentElement = element;
        const values = getCurrentValues(element);
        
        const tool = document.createElement('div');
        tool.className = 'cs-position-tool';
        tool.innerHTML = `
          <div class="tool-header">
            <span>Position Tool: ${posClass}</span>
            <button class="close-btn" onclick="closePositionTool()">✕</button>
          </div>
          
          <div class="tool-section">
            <div class="section-title">Position (pixels)</div>
            <div class="controls">
              <span class="control-label">X:</span>
              <div class="control-buttons">
                <button onclick="adjustValue('x', -1)">-</button>
                <button onclick="adjustValue('x', 1)">+</button>
              </div>
              <span class="control-value" id="x-value">${values.x}px</span>
            </div>
            <div class="controls">
              <span class="control-label">Y:</span>
              <div class="control-buttons">
                <button onclick="adjustValue('y', -1)">-</button>
                <button onclick="adjustValue('y', 1)">+</button>
              </div>
              <span class="control-value" id="y-value">${values.y}px</span>
            </div>
          </div>
          
          <div class="tool-section">
            <div class="section-title">Size (pixels)</div>
            <div class="controls">
              <span class="control-label">Width:</span>
              <div class="control-buttons">
                <button onclick="adjustValue('width', -1)">-</button>
                <button onclick="adjustValue('width', 1)">+</button>
              </div>
              <span class="control-value" id="width-value">${values.width}px</span>
            </div>
            <div class="controls">
              <span class="control-label">Height:</span>
              <div class="control-buttons">
                <button onclick="adjustValue('height', -1)">-</button>
                <button onclick="adjustValue('height', 1)">+</button>
              </div>
              <span class="control-value" id="height-value">${values.height}px</span>
            </div>
          </div>
          
          <div class="tool-footer">
            <button class="save-btn" onclick="saveToCSSFile()">Save to CSS</button>
            <button class="reset-btn" onclick="resetValues()">Reset</button>
            <button id="toggle-borders-btn" class="toggle-btn" onclick="toggleDiagnosticBorders()">Hide Borders</button>
          </div>
        `;
        
        document.body.appendChild(tool);
        currentTool = tool;
        
        // Make the tool draggable
        makeDraggable(tool);
        
        // Store original values for reset
        tool._originalValues = values;
        tool._positionClass = posClass;
      }
      
      // Force resize with high specificity and multiple approaches
      function forceResize(element, property, value) {
        console.log('Force resizing:', element, property, value);
        
        // Apply with !important to override CSS specificity
        element.style.setProperty(property, value, 'important');
        
        // Also try setting box-sizing to ensure consistent behavior
        element.style.setProperty('box-sizing', 'border-box', 'important');
        
        // For certain elements, also set min/max constraints
        if (property === 'width') {
          element.style.setProperty('min-width', '0', 'important');
          element.style.setProperty('max-width', 'none', 'important');
          
          // For input elements, also try setting size attribute
          if (element.tagName === 'INPUT' || element.tagName === 'SELECT') {
            element.style.setProperty('width', value, 'important');
            // Remove any conflicting flex or grid properties
            element.style.setProperty('flex', 'none', 'important');
            element.style.setProperty('flex-grow', '0', 'important');
            element.style.setProperty('flex-shrink', '0', 'important');
          }
        }
        if (property === 'height') {
          element.style.setProperty('min-height', '0', 'important');
          element.style.setProperty('max-height', 'none', 'important');
          
          // For input elements, ensure height takes effect
          if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
            element.style.setProperty('height', value, 'important');
            element.style.setProperty('line-height', 'normal', 'important');
          }
        }
        
        // Force a reflow to ensure the changes take effect
        void element.offsetHeight;
      }
      
      // Make tool draggable
      function makeDraggable(toolElement) {
        const header = toolElement.querySelector('.tool-header');
        let isDragging = false;
        let startX, startY, startLeft, startTop;
        
        header.style.cursor = 'move';
        header.style.userSelect = 'none';
        
        header.addEventListener('mousedown', function(e) {
          if (e.target.classList.contains('close-btn')) return; // Don't drag when clicking close button
          
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          
          const rect = toolElement.getBoundingClientRect();
          startLeft = rect.left;
          startTop = rect.top;
          
          // Remove transform to use absolute positioning
          toolElement.style.transform = 'none';
          toolElement.style.left = startLeft + 'px';
          toolElement.style.top = startTop + 'px';
          
          e.preventDefault();
        });
        
        document.addEventListener('mousemove', function(e) {
          if (!isDragging) return;
          
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          
          toolElement.style.left = (startLeft + deltaX) + 'px';
          toolElement.style.top = (startTop + deltaY) + 'px';
        });
        
        document.addEventListener('mouseup', function() {
          isDragging = false;
        });
      }
      
      // Adjust value and update display
      window.adjustValue = function(property, delta) {
        if (!currentElement || !currentTool) return;
        
        console.log('=== DEBUGGING ADJUSTMENT ===');
        console.log('Property:', property, 'Delta:', delta);
        console.log('Element:', currentElement);
        console.log('Current computed style position:', window.getComputedStyle(currentElement).position);
        console.log('Current computed style display:', window.getComputedStyle(currentElement).display);
        console.log('Current getBoundingClientRect():', currentElement.getBoundingClientRect());
        console.log('Current style.left:', currentElement.style.left);
        console.log('Current style.top:', currentElement.style.top);
        console.log('Current style.width:', currentElement.style.width);
        console.log('Current style.height:', currentElement.style.height);
        
        switch(property) {
          case 'x':
            // For positioning, we need to account for the element's positioning context
            let currentLeft;
            if (currentElement.style.left) {
              // Already has inline positioning, use that
              currentLeft = parseInt(currentElement.style.left);
            } else {
              // Calculate position relative to the offsetParent (positioning context)
              const rect = currentElement.getBoundingClientRect();
              const parentRect = currentElement.offsetParent ? currentElement.offsetParent.getBoundingClientRect() : {left: 0, top: 0};
              currentLeft = Math.round(rect.left - parentRect.left);
              console.log('X: No existing left value, calculated relative position:', currentLeft);
              console.log('X: Element rect.left:', rect.left, 'Parent rect.left:', parentRect.left);
            }
            
            const newLeft = currentLeft + delta;
            console.log('X: Setting left from', currentLeft, 'to', newLeft);
            
            currentElement.style.setProperty('position', 'absolute', 'important');
            currentElement.style.setProperty('left', newLeft + 'px', 'important');
            // Clear any conflicting positioning
            currentElement.style.setProperty('right', 'auto', 'important');
            
            // Update border if it exists and borders are visible
            if (typeof bordersVisible !== 'undefined' && bordersVisible) {
              currentElement.style.setProperty('border', '0.5px dashed red', 'important');
            }
            
            document.getElementById('x-value').textContent = newLeft + 'px';
            
            console.log('After X change - getBoundingClientRect():', currentElement.getBoundingClientRect());
            break;
            
          case 'y':
            // For positioning, we need to account for the element's positioning context
            let currentTop;
            if (currentElement.style.top) {
              // Already has inline positioning, use that
              currentTop = parseInt(currentElement.style.top);
            } else {
              // Calculate position relative to the offsetParent (positioning context)
              const rect = currentElement.getBoundingClientRect();
              const parentRect = currentElement.offsetParent ? currentElement.offsetParent.getBoundingClientRect() : {left: 0, top: 0};
              currentTop = Math.round(rect.top - parentRect.top);
              console.log('Y: No existing top value, calculated relative position:', currentTop);
              console.log('Y: Element rect.top:', rect.top, 'Parent rect.top:', parentRect.top);
            }
            
            const newTop = currentTop + delta;
            console.log('Y: Setting top from', currentTop, 'to', newTop);
            
            currentElement.style.setProperty('position', 'absolute', 'important');
            currentElement.style.setProperty('top', newTop + 'px', 'important');
            // Clear any conflicting positioning
            currentElement.style.setProperty('bottom', 'auto', 'important');
            
            // Update border if it exists and borders are visible
            if (typeof bordersVisible !== 'undefined' && bordersVisible) {
              currentElement.style.setProperty('border', '0.5px dashed red', 'important');
            }
            
            document.getElementById('y-value').textContent = newTop + 'px';
            
            console.log('After Y change - getBoundingClientRect():', currentElement.getBoundingClientRect());
            break;
            
          case 'width':
            const currentRect = currentElement.getBoundingClientRect();
            const currentWidth = Math.round(currentRect.width);
            const newWidth = Math.max(10, currentWidth + delta);
            
            console.log('Width: Changing from', currentWidth, 'to', newWidth);
            
            // Try different approaches based on element type
            if (currentElement.tagName === 'INPUT' || currentElement.tagName === 'SELECT' || currentElement.tagName === 'TEXTAREA') {
              console.log('Form element detected, using form-specific approach');
              currentElement.style.setProperty('width', newWidth + 'px', 'important');
              currentElement.style.setProperty('min-width', 'auto', 'important');
              currentElement.style.setProperty('max-width', 'none', 'important');
            } else {
              console.log('Non-form element, using standard approach');
              currentElement.style.setProperty('width', newWidth + 'px', 'important');
              currentElement.style.setProperty('min-width', '0', 'important');
              currentElement.style.setProperty('max-width', 'none', 'important');
            }
            
            // Update border to match new dimensions (only if borders are visible)
            if (typeof bordersVisible !== 'undefined' && bordersVisible) {
              // Remove any existing border first to avoid doubling
              currentElement.style.removeProperty('border');
              // Force reflow
              void currentElement.offsetHeight;
              // Apply the diagnostic border inline to match new dimensions
              currentElement.style.setProperty('border', '0.5px dashed red', 'important');
            }
            
            document.getElementById('width-value').textContent = newWidth + 'px';
            
            setTimeout(() => {
              const afterRect = currentElement.getBoundingClientRect();
              console.log('Width verification: expected', newWidth, 'actual', Math.round(afterRect.width));
            }, 100);
            break;
            
          case 'height':
            const currentRectH = currentElement.getBoundingClientRect();
            const currentHeight = Math.round(currentRectH.height);
            const newHeight = Math.max(10, currentHeight + delta);
            
            console.log('Height: Changing from', currentHeight, 'to', newHeight);
            
            // Try different approaches based on element type
            if (currentElement.tagName === 'INPUT' || currentElement.tagName === 'SELECT' || currentElement.tagName === 'TEXTAREA') {
              console.log('Form element detected, using form-specific approach');
              currentElement.style.setProperty('height', newHeight + 'px', 'important');
              currentElement.style.setProperty('min-height', 'auto', 'important');
              currentElement.style.setProperty('max-height', 'none', 'important');
            } else {
              console.log('Non-form element, using standard approach');
              currentElement.style.setProperty('height', newHeight + 'px', 'important');
              currentElement.style.setProperty('min-height', '0', 'important');
              currentElement.style.setProperty('max-height', 'none', 'important');
            }
            
            // Update border to match new dimensions (only if borders are visible)
            if (typeof bordersVisible !== 'undefined' && bordersVisible) {
              // Remove any existing border first to avoid doubling
              currentElement.style.removeProperty('border');
              // Force reflow
              void currentElement.offsetHeight;
              // Apply the diagnostic border inline to match new dimensions
              currentElement.style.setProperty('border', '0.5px dashed red', 'important');
            }
            
            document.getElementById('height-value').textContent = newHeight + 'px';
            
            setTimeout(() => {
              const afterRectH = currentElement.getBoundingClientRect();
              console.log('Height verification: expected', newHeight, 'actual', Math.round(afterRectH.height));
            }, 100);
            break;
        }
        
        console.log('=== END DEBUGGING ===');
      };
      
      // Close the tool
      window.closePositionTool = function() {
        if (currentTool) {
          document.body.removeChild(currentTool);
          currentTool = null;
          currentElement = null;
        }
      };
      
      // Reset to original values
      window.resetValues = function() {
        if (!currentElement || !currentTool) return;
        
        // Clear all positioning and sizing styles
        currentElement.style.removeProperty('position');
        currentElement.style.removeProperty('left');
        currentElement.style.removeProperty('top');
        currentElement.style.removeProperty('width');
        currentElement.style.removeProperty('height');
        currentElement.style.removeProperty('min-width');
        currentElement.style.removeProperty('max-width');
        currentElement.style.removeProperty('min-height');
        currentElement.style.removeProperty('max-height');
        currentElement.style.removeProperty('box-sizing');
        
        // Update display values
        const values = getCurrentValues(currentElement);
        document.getElementById('x-value').textContent = values.x + 'px';
        document.getElementById('y-value').textContent = values.y + 'px';
        document.getElementById('width-value').textContent = values.width + 'px';
        document.getElementById('height-value').textContent = values.height + 'px';
      };

      // Toggle diagnostic borders
      let bordersVisible = true;
      window.toggleDiagnosticBorders = function() {
        const button = document.getElementById('toggle-borders-btn');
        // Match all the selectors from the SCSS debug system
        const formFields = document.querySelectorAll(`
          input, select, textarea, button,
          .cs-char-name,
          .cs-class-select,
          .cs-background-select,
          .cs-race-select,
          .cs-alignment-select,
          .cs-age-field,
          .cs-sex-field,
          .cs-height-field,
          .cs-weight-field,
          .char-height,
          .char-weight,
          .cs-languages-field,
          .languages-tags,
          .char-languages,
          .cs-input-small,
          .cs-input-medium,
          .cs-select-inline,
          .cs-listening-select,
          .cs-bio-textarea,
          .cs-ability-select,
          .attr-str,
          .attr-dex,
          .attr-con,
          .attr-int,
          .attr-wis,
          .attr-cha,
          .cs-save-value,
          .cs-save-badge,
          .cs-combat-input,
          .cs-portrait-img,
          .portrait-img,
          .cs-portrait-display,
          .portrait-display,
          .cs-level-display,
          .cs-xp-display,
          .cs-xp-mod-display,
          .cs-next-level-field,
          input[name*="height"],
          input[name*="weight"],
          input[name*="languages"],
          select[name*="attributes"]
        `);

        if (bordersVisible) {
          // Hide borders - use !important to override CSS
          formFields.forEach(field => {
            field.style.setProperty('border', 'none', 'important');
          });
          button.textContent = 'Show Borders';
          button.style.background = '#4CAF50';
          bordersVisible = false;
        } else {
          // Show borders - remove the override to restore CSS borders
          formFields.forEach(field => {
            field.style.removeProperty('border');
          });
          button.textContent = 'Hide Borders';
          button.style.background = '#2196F3';
          bordersVisible = true;
        }
      };
      
      // Save changes to CSS file (placeholder - would need server-side implementation)
      window.saveToCSSFile = function() {
        if (!currentElement || !currentTool) return;
        
        const posClass = currentTool._positionClass;
        const mapping = cssVariableMap[posClass];
        if (!mapping) return;
        
        const currentLeft = parseInt(currentElement.style.left) || 0;
        const currentTop = parseInt(currentElement.style.top) || 0;
        
        // Check if this is an inline-positioned element
        if (mapping.left === 'inline-left' && mapping.top === 'inline-top') {
          console.log('Inline positioning saved:', {
            class: posClass,
            element: currentElement.className,
            leftValue: currentLeft + 'px',
            topValue: currentTop + 'px'
          });
          
          // Show confirmation for inline positioning
          alert(`Inline positioning saved!\nElement: ${posClass}\nLeft: ${currentLeft}px\nTop: ${currentTop}px\n\nNote: This uses inline styles, not CSS variables.`);
        } else {
          // In a real implementation, this would make an API call to update the SCSS file
          console.log('Save to CSS:', {
            class: posClass,
            leftVar: mapping.left,
            topVar: mapping.top,
            leftValue: currentLeft + 'px',
            topValue: currentTop + 'px'
          });
          
          // Show confirmation
          alert('Changes saved!\n' + mapping.left + ': ' + currentLeft + 'px\n' + mapping.top + ': ' + currentTop + 'px\n\nNote: This is a placeholder. Server-side implementation needed.');
        }
        
        closePositionTool();
      };
      
      // Add right-click event listener to positioned elements with debug borders
      function addPositionToolListeners() {
        console.log('addPositionToolListeners called');
        console.log('Debug enabled:', isDebugEnabled());
        
        if (!isDebugEnabled()) return;
        
        // Find all elements with cs-pos-* classes that also have debug borders
        const positionedElements = document.querySelectorAll('[class*="cs-pos-"]');
        console.log('Found positioned elements:', positionedElements.length);
        
        positionedElements.forEach(element => {
          element.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            createPositionTool(this);
          });
          
          // Add visual indicator that right-click is available
          element.style.cursor = 'context-menu';
          element.title = (element.title || '') + ' (Right-click for position tool)';
        });
        
        // Also add listeners to specific form elements that have diagnostic borders but don't have positioning classes
        const formElements = document.querySelectorAll(`
          .cs-ability-select,
          .attr-str, .attr-dex, .attr-con, .attr-int, .attr-wis, .attr-cha,
          .cs-save-value,
          .cs-save-badge,
          .cs-xp-display,
          .cs-xp-mod-display,
          .cs-next-level-field
        `);
        
        console.log('Found form elements:', formElements.length);
        
        formElements.forEach(element => {
          console.log('Checking form element:', element.className);
          
          // Find the closest parent with a cs-pos-* class for these elements
          let positionedParent = element.closest('[class*="cs-pos-"]');
          
          // If no cs-pos-* parent found, try specific container classes
          if (!positionedParent) {
            positionedParent = element.closest('.ability-scores-section, .cs-combat-stats, .cs-save-group');
            console.log('Found alternative parent:', positionedParent?.className);
          }
          
          if (positionedParent) {
            element.addEventListener('contextmenu', function(e) {
              e.preventDefault();
              console.log('Right-click on form element, opening tool for parent:', positionedParent.className);
              createPositionTool(positionedParent);
            });
            
            // Add visual indicator that right-click is available
            element.style.cursor = 'context-menu';
            element.title = (element.title || '') + ' (Right-click for position tool)';
            console.log('Added listener to:', element.className);
          } else {
            console.log('No positioned parent found for:', element.className);
          }
        });
      }
      
      // Initialize when DOM is ready
      function init() {
        initializeVariableMap();
        
        // Check if debug is enabled and add listeners
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            setTimeout(addPositionToolListeners, 100);
          });
        } else {
          setTimeout(addPositionToolListeners, 100);
        }
      }
      
      // Start initialization
      init();
      
    })();
  </script>

  <!-- Character Level - Positioned behind everything -->
  <div class="level-progress-bar-container cs-level-container cs-abs cs-pos-level" id="level-container">
    <!-- Shadow overlay for Level field -->
  <div class="cs-level-shadow"></div>
  <!-- Hidden inputs for level position data -->
  <input type="hidden" name="system.levelPosition.x" value="{{system.levelPosition.x}}" />
  <input type="hidden" name="system.levelPosition.y" value="{{system.levelPosition.y}}" />
  <input type="hidden" name="system.levelPosition.zIndex" value="{{system.levelPosition.zIndex}}" />

        <!-- Level display without progress bar -->
        <div>
          <!-- Level display in center -->
          <div class="cs-level-display">{{system.level}}</div>
        </div>
      </div>

  <!-- Character Portrait - Positioned behind everything -->
  <div class="portrait-container cs-portrait-container cs-abs cs-pos-portrait" id="portrait-container" style="--portrait-size:138px; --portrait-height:183px; --user-portrait-scale: {{#if system.userPortrait.scale}}{{system.userPortrait.scale}}{{else}}1{{/if}}; --user-portrait-x: {{#if system.userPortrait.x}}{{system.userPortrait.x}}px{{else}}0px{{/if}}; --user-portrait-y: {{#if system.userPortrait.y}}{{system.userPortrait.y}}px{{else}}0px{{/if}};">
    <!-- Hidden inputs for portrait data -->
    <input type="hidden" name="system.portrait" value="{{system.portrait}}" />
    <input type="hidden" name="system.userPortrait.scale" value="{{system.userPortrait.scale}}" />
    <input type="hidden" name="system.userPortrait.x" value="{{system.userPortrait.x}}" />
    <input type="hidden" name="system.userPortrait.y" value="{{system.userPortrait.y}}" />

    <!-- Portrait display area -->
    <div class="portrait-display cs-portrait-display">
      <img class="portrait-img cs-portrait-img" src="{{#if system.portrait}}{{system.portrait}}{{else}}icons/svg/mystery-man-black.svg{{/if}}" alt="{{actor.name}}" draggable="false" />
    </div>

    <!-- Portrait adjustment controls -->
    <div class="portrait-controls" id="portrait-controls">
      <div class="btn-group">
        <button type="button" data-action="zoom-out" title="Zoom Out&#10;Hold Shift for fine adjustment&#10;Hold Ctrl for coarse adjustment&#10;Hold Shift+Ctrl for very fine adjustment">−</button>
        <button type="button" data-action="zoom-in" title="Zoom In&#10;Hold Shift for fine adjustment&#10;Hold Ctrl for coarse adjustment&#10;Hold Shift+Ctrl for very fine adjustment">+</button>
      </div>
      <div class="btn-group">
        <button type="button" data-action="move-up" title="Move Up&#10;Hold Shift for fine movement (1px)&#10;Hold Ctrl for coarse movement (10px)&#10;Hold Shift+Ctrl for very fine movement (0.5px)">↑</button>
        <button type="button" data-action="move-down" title="Move Down&#10;Hold Shift for fine movement (1px)&#10;Hold Ctrl for coarse movement (10px)&#10;Hold Shift+Ctrl for very fine movement (0.5px)">↓</button>
        <button type="button" data-action="move-left" title="Move Left&#10;Hold Shift for fine movement (1px)&#10;Hold Ctrl for coarse movement (10px)&#10;Hold Shift+Ctrl for very fine movement (0.5px)">←</button>
        <button type="button" data-action="move-right" title="Move Right&#10;Hold Shift for fine movement (1px)&#10;Hold Ctrl for coarse movement (10px)&#10;Hold Shift+Ctrl for very fine movement (0.5px)">→</button>
      </div>
      <div class="btn-group">
        <button type="button" data-action="reset" title="Reset">↻</button>
        <button type="button" data-action="done" title="Done">✓</button>
      </div>
    </div>
  </div>

  <!-- Static Header Section - Absolute Positioning Layout -->
  <div class="static-header cs-static-header">

      <!-- Character Name - Centered positioning -->
  <div class="character-name-section cs-abs cs-pos-name" id="character-name-container">

      </div>

  <!-- Character Name - Absolute positioned -->
  <div class="character-name-group cs-abs cs-pos-namegroup" id="character-name-container">
    <input type="hidden" name="system.namePosition.x" value="{{system.namePosition.x}}" />
    <input type="hidden" name="system.namePosition.y" value="{{system.namePosition.y}}" />
    <input type="hidden" name="system.namePosition.zIndex" value="{{system.namePosition.zIndex}}" />
    <div class="cs-char-field-group">
      <input class="char-name cs-char-name" id="char-name" name="name" type="text" value="{{actor.name}}" />
    </div>
  </div>

  <!-- Character Class & Alignment - Centered under name as one element -->
  <!-- Character Class - Independent container for positioning -->
  <div class="class-group cs-abs cs-pos-class" id="class-container">
    <input type="hidden" name="system.classPosition.x" value="{{system.classPosition.x}}" />
    <input type="hidden" name="system.classPosition.y" value="{{system.classPosition.y}}" />
    <input type="hidden" name="system.classPosition.zIndex" value="{{system.classPosition.zIndex}}" />
    <div class="cs-char-field-group">
  <select class="char-class cs-class-select" id="char-class" name="system.class">
        <option value="Assassin" {{#if (eq system.class "Assassin")}}selected{{/if}}>Assassin</option>
        <option value="Barbarian" {{#if (eq system.class "Barbarian")}}selected{{/if}}>Barbarian</option>
        <option value="Bard" {{#if (eq system.class "Bard")}}selected{{/if}}>Bard</option>
        <option value="Beast Master" {{#if (eq system.class "Beast Master")}}selected{{/if}}>Beast Master</option>
        <option value="Cleric" {{#if (eq system.class "Cleric")}}selected{{/if}}>Cleric</option>
        <option value="Druid" {{#if (eq system.class "Druid")}}selected{{/if}}>Druid</option>
        <option value="Dwarf" {{#if (eq system.class "Dwarf")}}selected{{/if}}>Dwarf</option>
        <option value="Elf" {{#if (eq system.class "Elf")}}selected{{/if}}>Elf</option>
        <option value="Fighter" {{#if (eq system.class "Fighter")}}selected{{/if}}>Fighter</option>
        <option value="Gnome" {{#if (eq system.class "Gnome")}}selected{{/if}}>Gnome</option>
        <option value="Half-Elf" {{#if (eq system.class "Half-Elf")}}selected{{/if}}>Half-Elf</option>
        <option value="Half-Orc" {{#if (eq system.class "Half-Orc")}}selected{{/if}}>Half-Orc</option>
        <option value="Hobbit" {{#if (eq system.class "Hobbit")}}selected{{/if}}>Hobbit</option>
        <option value="Illusionist" {{#if (eq system.class "Illusionist")}}selected{{/if}}>Illusionist</option>
        <option value="Knight" {{#if (eq system.class "Knight")}}selected{{/if}}>Knight</option>
        <option value="Mage" {{#if (eq system.class "Mage")}}selected{{/if}}>Mage</option>
        <option value="Magic-User" {{#if (eq system.class "Magic-User")}}selected{{/if}}>Magic-User</option>
        <option value="Paladin" {{#if (eq system.class "Paladin")}}selected{{/if}}>Paladin</option>
        <option value="Ranger" {{#if (eq system.class "Ranger")}}selected{{/if}}>Ranger</option>
        <option value="Thief" {{#if (eq system.class "Thief")}}selected{{/if}}>Thief</option>
        <option value="Warden" {{#if (eq system.class "Warden")}}selected{{/if}}>Warden</option>
      </select>
    </div>
  </div>

  <!-- Character Alignment - Independent container for positioning -->
  <div class="alignment-group cs-abs cs-pos-alignment" id="alignment-container">
    <input type="hidden" name="system.alignmentPosition.x" value="{{system.alignmentPosition.x}}" />
    <input type="hidden" name="system.alignmentPosition.y" value="{{system.alignmentPosition.y}}" />
    <input type="hidden" name="system.alignmentPosition.zIndex" value="{{system.alignmentPosition.zIndex}}" />
    <div class="cs-char-field-group">
  <select class="char-align cs-alignment-select" id="char-align" name="system.alignment">
        <option value="Chaotic" {{#if (eq system.alignment "Chaotic")}}selected{{/if}}>Chaotic</option>
        <option value="Lawful" {{#if (eq system.alignment "Lawful")}}selected{{/if}}>Lawful</option>
        <option value="Neutral" {{#if (eq system.alignment "Neutral")}}selected{{/if}}>Neutral</option>
      </select>
    </div>
  </div>

  <!-- Character Race - Positioned next to existing fields -->
  <div class="race-group cs-abs cs-pos-race" id="race-container">
    <div class="cs-char-field-group">
      <select class="char-race cs-race-select" id="char-race" name="system.race">
        <option value="Dwarf" {{#if (eq system.race "Dwarf")}}selected{{/if}}>Dwarf</option>
        <option value="Elf" {{#if (eq system.race "Elf")}}selected{{/if}}>Elf</option>
        <option value="Gnome" {{#if (eq system.race "Gnome")}}selected{{/if}}>Gnome</option>
        <option value="Half-Elf" {{#if (eq system.race "Half-Elf")}}selected{{/if}}>Half-Elf</option>
        <option value="Half-Orc" {{#if (eq system.race "Half-Orc")}}selected{{/if}}>Half-Orc</option>
        <option value="Hobbit" {{#if (eq system.race "Hobbit")}}selected{{/if}}>Hobbit</option>
        <option value="Human" {{#if (eq system.race "Human")}}selected{{/if}}>Human</option>
      </select>
    </div>
  </div>

  <!-- Character Age and Sex - Small fields -->
  <div class="age-group cs-abs cs-pos-age" id="age-container">
    <div class="cs-char-field-group">
      <input class="char-age cs-age-field" id="char-age" name="system.age" type="text" value="{{system.age}}" />
    </div>
  </div>

  <div class="sex-group cs-abs cs-pos-sex" id="sex-container">
    <div class="cs-char-field-group">
      <select class="char-sex cs-sex-field" id="char-sex" name="system.sex">
        <option value="Male" {{#if (eq system.sex "Male")}}selected{{/if}}>M</option>
        <option value="Female" {{#if (eq system.sex "Female")}}selected{{/if}}>F</option>
        <option value="Other" {{#if (eq system.sex "Other")}}selected{{/if}}>O</option>
      </select>
    </div>
  </div>

  <!-- Height field -->
  <div class="height-group cs-abs cs-pos-height" id="height-container">
    <div class="cs-char-field-group">
      <input class="char-height cs-height-field" id="char-height" name="system.height" type="text" value="{{system.height}}" />
    </div>
  </div>

  <!-- Weight field -->
  <div class="weight-group cs-abs cs-pos-weight" id="weight-container">
    <div class="cs-char-field-group">
      <input class="char-weight cs-weight-field" id="char-weight" name="system.weight" type="text" value="{{system.weight}}" />
    </div>
  </div>

  <!-- Background field -->
  <div class="background-group cs-abs cs-pos-background" id="background-container">
    <div class="char-field-group cs-char-field-group">
      <select class="char-background cs-background-select" id="char-background" name="system.background">
 <option value="" {{#unless system.background}}selected{{/unless}}>-- Select Background --</option>
                  <option value="Actor" {{#if (eq system.background "Actor")}}selected{{/if}}>Actor</option>
                  <option value="Armorer" {{#if (eq system.background "Armorer")}}selected{{/if}}>Armorer</option>
                  <option value="Artisan" {{#if (eq system.background "Artisan")}}selected{{/if}}>Artisan</option>
                  <option value="Baker" {{#if (eq system.background "Baker")}}selected{{/if}}>Baker</option>
                  <option value="Banker" {{#if (eq system.background "Banker")}}selected{{/if}}>Banker</option>
                  <option value="Barber" {{#if (eq system.background "Barber")}}selected{{/if}}>Barber</option>
                  <option value="Barkeep" {{#if (eq system.background "Barkeep")}}selected{{/if}}>Barkeep</option>
                  <option value="Beggar" {{#if (eq system.background "Beggar")}}selected{{/if}}>Beggar</option>
                  <option value="Blacksmith" {{#if (eq system.background "Blacksmith")}}selected{{/if}}>Blacksmith</option>
                  <option value="Bookbinder" {{#if (eq system.background "Bookbinder")}}selected{{/if}}>Bookbinder</option>
                  <option value="Bouncer" {{#if (eq system.background "Bouncer")}}selected{{/if}}>Bouncer</option>
                  <option value="Bowyer" {{#if (eq system.background "Bowyer")}}selected{{/if}}>Bowyer</option>
                  <option value="Brewer" {{#if (eq system.background "Brewer")}}selected{{/if}}>Brewer</option>
                  <option value="Bricklayer" {{#if (eq system.background "Bricklayer")}}selected{{/if}}>Bricklayer</option>
                  <option value="Butcher" {{#if (eq system.background "Butcher")}}selected{{/if}}>Butcher</option>
                  <option value="Caretaker" {{#if (eq system.background "Caretaker")}}selected{{/if}}>Caretaker</option>
                  <option value="Carpenter" {{#if (eq system.background "Carpenter")}}selected{{/if}}>Carpenter</option>
                  <option value="Cartographer" {{#if (eq system.background "Cartographer")}}selected{{/if}}>Cartographer</option>
                  <option value="Charcoal Maker" {{#if (eq system.background "Charcoal Maker")}}selected{{/if}}>Charcoal Maker</option>
                  <option value="Clerk" {{#if (eq system.background "Clerk")}}selected{{/if}}>Clerk</option>
                  <option value="Coachman" {{#if (eq system.background "Coachman")}}selected{{/if}}>Coachman</option>
                  <option value="Cobbler" {{#if (eq system.background "Cobbler")}}selected{{/if}}>Cobbler</option>
                  <option value="Cook" {{#if (eq system.background "Cook")}}selected{{/if}}>Cook</option>
                  <option value="Cooper" {{#if (eq system.background "Cooper")}}selected{{/if}}>Cooper</option>
                  <option value="Courier" {{#if (eq system.background "Courier")}}selected{{/if}}>Courier</option>
                  <option value="Crier" {{#if (eq system.background "Crier")}}selected{{/if}}>Crier</option>
                  <option value="Dairyboy" {{#if (eq system.background "Dairyboy")}}selected{{/if}}>Dairyboy</option>
                  <option value="Distiller" {{#if (eq system.background "Distiller")}}selected{{/if}}>Distiller</option>
                  <option value="Ditch Digger" {{#if (eq system.background "Ditch Digger")}}selected{{/if}}>Ditch Digger</option>
                  <option value="Dyer" {{#if (eq system.background "Dyer")}}selected{{/if}}>Dyer</option>
                  <option value="Engraver" {{#if (eq system.background "Engraver")}}selected{{/if}}>Engraver</option>
                  <option value="Entertainer" {{#if (eq system.background "Entertainer")}}selected{{/if}}>Entertainer</option>
                  <option value="Falconer" {{#if (eq system.background "Falconer")}}selected{{/if}}>Falconer</option>
                  <option value="Farmer" {{#if (eq system.background "Farmer")}}selected{{/if}}>Farmer</option>
                  <option value="Ferrier" {{#if (eq system.background "Ferrier")}}selected{{/if}}>Ferrier</option>
                  <option value="Fishmonger" {{#if (eq system.background "Fishmonger")}}selected{{/if}}>Fishmonger</option>
                  <option value="Fletcher" {{#if (eq system.background "Fletcher")}}selected{{/if}}>Fletcher</option>
                  <option value="Fuller" {{#if (eq system.background "Fuller")}}selected{{/if}}>Fuller</option>
                  <option value="Furrier" {{#if (eq system.background "Furrier")}}selected{{/if}}>Furrier</option>
                  <option value="Gardener" {{#if (eq system.background "Gardener")}}selected{{/if}}>Gardener</option>
                  <option value="Glassblower" {{#if (eq system.background "Glassblower")}}selected{{/if}}>Glassblower</option>
                  <option value="Glazier" {{#if (eq system.background "Glazier")}}selected{{/if}}>Glazier</option>
                  <option value="Glover" {{#if (eq system.background "Glover")}}selected{{/if}}>Glover</option>
                  <option value="Gong Farmer" {{#if (eq system.background "Gong Farmer")}}selected{{/if}}>Gong Farmer</option>
                  <option value="Gravedigger" {{#if (eq system.background "Gravedigger")}}selected{{/if}}>Gravedigger</option>
                  <option value="Groom" {{#if (eq system.background "Groom")}}selected{{/if}}>Groom</option>
                  <option value="Guard" {{#if (eq system.background "Guard")}}selected{{/if}}>Guard</option>
                  <option value="Hatmaker" {{#if (eq system.background "Hatmaker")}}selected{{/if}}>Hatmaker</option>
                  <option value="Herdsman" {{#if (eq system.background "Herdsman")}}selected{{/if}}>Herdsman</option>
                  <option value="Houndsman" {{#if (eq system.background "Houndsman")}}selected{{/if}}>Houndsman</option>
                  <option value="Innkeeper" {{#if (eq system.background "Innkeeper")}}selected{{/if}}>Innkeeper</option>
                  <option value="Jailer" {{#if (eq system.background "Jailer")}}selected{{/if}}>Jailer</option>
                  <option value="Jester" {{#if (eq system.background "Jester")}}selected{{/if}}>Jester</option>
                  <option value="Joiner" {{#if (eq system.background "Joiner")}}selected{{/if}}>Joiner</option>
                  <option value="Juggler" {{#if (eq system.background "Juggler")}}selected{{/if}}>Juggler</option>
                  <option value="Laborer" {{#if (eq system.background "Laborer")}}selected{{/if}}>Laborer</option>
                  <option value="Launderer" {{#if (eq system.background "Launderer")}}selected{{/if}}>Launderer</option>
                  <option value="Lector" {{#if (eq system.background "Lector")}}selected{{/if}}>Lector</option>
                  <option value="Librarian" {{#if (eq system.background "Librarian")}}selected{{/if}}>Librarian</option>
                  <option value="Lumberjack" {{#if (eq system.background "Lumberjack")}}selected{{/if}}>Lumberjack</option>
                  <option value="Maid/Butler" {{#if (eq system.background "Maid/Butler")}}selected{{/if}}>Maid/Butler</option>
                  <option value="Mason" {{#if (eq system.background "Mason")}}selected{{/if}}>Mason</option>
                  <option value="Merchant" {{#if (eq system.background "Merchant")}}selected{{/if}}>Merchant</option>
                  <option value="Messenger" {{#if (eq system.background "Messenger")}}selected{{/if}}>Messenger</option>
                  <option value="Miller" {{#if (eq system.background "Miller")}}selected{{/if}}>Miller</option>
                  <option value="Millwright" {{#if (eq system.background "Millwright")}}selected{{/if}}>Millwright</option>
                  <option value="Mortician" {{#if (eq system.background "Mortician")}}selected{{/if}}>Mortician</option>
                  <option value="Musician" {{#if (eq system.background "Musician")}}selected{{/if}}>Musician</option>
                  <option value="Ne'er-do-well" {{#if (eq system.background "Ne'er-do-well")}}selected{{/if}}>Ne'er-do-well</option>
                  <option value="Page" {{#if (eq system.background "Page")}}selected{{/if}}>Page</option>
                  <option value="Painter" {{#if (eq system.background "Painter")}}selected{{/if}}>Painter</option>
                  <option value="Philosopher" {{#if (eq system.background "Philosopher")}}selected{{/if}}>Philosopher</option>
                  <option value="Porter" {{#if (eq system.background "Porter")}}selected{{/if}}>Porter</option>
                  <option value="Potter" {{#if (eq system.background "Potter")}}selected{{/if}}>Potter</option>
                  <option value="Printer" {{#if (eq system.background "Printer")}}selected{{/if}}>Printer</option>
                  <option value="Prostitute" {{#if (eq system.background "Prostitute")}}selected{{/if}}>Prostitute</option>
                  <option value="Rag & Bone" {{#if (eq system.background "Rag & Bone")}}selected{{/if}}>Rag & Bone</option>
                  <option value="Ratter" {{#if (eq system.background "Ratter")}}selected{{/if}}>Ratter</option>
                  <option value="Runaway Slave" {{#if (eq system.background "Runaway Slave")}}selected{{/if}}>Runaway Slave</option>
                  <option value="Scavenger" {{#if (eq system.background "Scavenger")}}selected{{/if}}>Scavenger</option>
                  <option value="Scholar" {{#if (eq system.background "Scholar")}}selected{{/if}}>Scholar</option>
                  <option value="Serf" {{#if (eq system.background "Serf")}}selected{{/if}}>Serf</option>
                  <option value="Server" {{#if (eq system.background "Server")}}selected{{/if}}>Server</option>
                  <option value="Sexton" {{#if (eq system.background "Sexton")}}selected{{/if}}>Sexton</option>
                  <option value="Squire" {{#if (eq system.background "Squire")}}selected{{/if}}>Squire</option>
                  <option value="Stablehand" {{#if (eq system.background "Stablehand")}}selected{{/if}}>Stablehand</option>
                  <option value="Stonecutter" {{#if (eq system.background "Stonecutter")}}selected{{/if}}>Stonecutter</option>
                  <option value="Street Sweeper" {{#if (eq system.background "Street Sweeper")}}selected{{/if}}>Street Sweeper</option>
                  <option value="Tailor" {{#if (eq system.background "Tailor")}}selected{{/if}}>Tailor</option>
                  <option value="Tallow Chandler" {{#if (eq system.background "Tallow Chandler")}}selected{{/if}}>Tallow Chandler</option>
                  <option value="Tanner" {{#if (eq system.background "Tanner")}}selected{{/if}}>Tanner</option>
                  <option value="Thatcher" {{#if (eq system.background "Thatcher")}}selected{{/if}}>Thatcher</option>
                  <option value="Tobacconist" {{#if (eq system.background "Tobacconist")}}selected{{/if}}>Tobacconist</option>
                  <option value="Trapper" {{#if (eq system.background "Trapper")}}selected{{/if}}>Trapper</option>
                  <option value="Wainwright" {{#if (eq system.background "Wainwright")}}selected{{/if}}>Wainwright</option>
                  <option value="Washer" {{#if (eq system.background "Washer")}}selected{{/if}}>Washer</option>
                  <option value="Weaver" {{#if (eq system.background "Weaver")}}selected{{/if}}>Weaver</option>
                  <option value="Wheelwright" {{#if (eq system.background "Wheelwright")}}selected{{/if}}>Wheelwright</option>
                  <option value="Winemaker" {{#if (eq system.background "Winemaker")}}selected{{/if}}>Winemaker</option>
                  <option value="Woodcutter" {{#if (eq system.background "Woodcutter")}}selected{{/if}}>Woodcutter</option>
      </select>
    </div>
  </div>

  <!-- Languages field -->
  <div class="languages-group cs-abs cs-pos-languages" id="languages-container">
  <div class="char-field-group cs-char-field-group">
  <div class="cs-languages-field open-language-dialog">
        <div class="languages-tags"></div>
      </div>
      <input type="hidden" name="system.languages" class="char-languages" value="{{system.languages}}" />
    </div>
  </div>

  <!-- XP Mod % field -->
  <div class="xp-mod-group cs-abs cs-pos-xpmod" id="xp-mod-container">
  <input type="text" class="xp-mod-display cs-field cs-xp-mod-display" id="xp-mod-display" readonly />
  </div>

  <!-- XP field -->
  <div class="xp-group cs-abs cs-pos-xp" id="xp-container">
  <input type="text" class="xp-display cs-field cs-xp-display" id="xp-display" name="system.xp" value="{{system.xp}}" />
  </div>

  <!-- Next Level field -->
  <div class="next-level-group cs-abs cs-pos-next" id="next-level-container">
    <!-- XP Progress Bar -->
    <div class="level-xp-progress"></div>
    <!-- Next Level Display -->
    <input type="text" class="next-level-display cs-next-level-field" id="next-level-display" readonly />
  </div>

      <!-- Horizontal separator line at bottom of static header -->
  <div class="cs-abs cs-pos-sep"></div>

    </div>

    <!-- Right-side Tab Navigation -->
    <nav class="sheet-tabs tabs cs-tabs" data-group="primary">
  <a class="item cs-tab-item" data-tab="combat">Combat</a>
  <a class="item cs-tab-item" data-tab="skills">Skills</a>
  <a class="item cs-tab-item" data-tab="equipment">Equipment</a>
  <a class="item cs-tab-item" data-tab="bio">Bio</a>
    </nav>

    <!-- Sheet Body - Tab Content Area -->
  <section class="sheet-body cs-sheet-body">
      <!-- Combat Tab -->
      <div class="tab" data-group="primary" data-tab="combat">
        <div class="combat-section">

          <!-- Ability Scores Section -->
          <div class="ability-scores-section cs-combat-stats">

            <!-- STR Ability Score -->
            <div class="ability cs-ability">
              <select class="attr-str cs-ability-select" id="attr-str" name="system.attributes.str.value">
                {{#each (range 3 18) as |val|}}
                  <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.str.value) val)}}selected{{/if}}>{{val}}</option>
                {{/each}}
              </select>
            </div>

            <!-- DEX Ability Score -->
            <div class="ability cs-ability">
              <select class="attr-dex cs-ability-select" id="attr-dex" name="system.attributes.dex.value">
                {{#each (range 3 18) as |val|}}
                  <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.dex.value) val)}}selected{{/if}}>{{val}}</option>
                {{/each}}
              </select>
            </div>

            <!-- CON Ability Score -->
            <div class="ability cs-ability">
              <select class="attr-con cs-ability-select" id="attr-con" name="system.attributes.con.value">
                {{#each (range 3 18) as |val|}}
                  <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.con.value) val)}}selected{{/if}}>{{val}}</option>
                {{/each}}
              </select>
            </div>

            <!-- INT Ability Score -->
            <div class="ability cs-ability">
              <select class="attr-int cs-ability-select" id="attr-int" name="system.attributes.int.value">
                {{#each (range 3 18) as |val|}}
                  <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.int.value) val)}}selected{{/if}}>{{val}}</option>
                {{/each}}
              </select>
            </div>

            <!-- WIS Ability Score -->
            <div class="ability cs-ability">
              <select class="attr-wis cs-ability-select" id="attr-wis" name="system.attributes.wis.value">
                {{#each (range 3 18) as |val|}}
                  <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.wis.value) val)}}selected{{/if}}>{{val}}</option>
                {{/each}}
              </select>
            </div>

            <!-- CHA Ability Score -->
            <div class="ability cs-ability">
              <select class="attr-cha cs-ability-select" id="attr-cha" name="system.attributes.cha.value">
                {{#each (range 3 18) as |val|}}
                  <option value="{{val}}" {{#if (eq (parseInt ../system.attributes.cha.value) val)}}selected{{/if}}>{{val}}</option>
                {{/each}}
              </select>
            </div>

          </div>

          <!-- Saving Throw Groups - Positioned relative to combat section -->
          <!-- Death Ray/Poison Group -->
          <div class="save-group-death cs-save-group">
            <div class="save death-save cs-save cs-abs cs-pos-save-death">
              <div class="cs-save-badge">
                <span class="cs-save-value">{{saves.death.value}}</span>
              </div>
            </div>
            <div class="save-label-death cs-save-label cs-abs cs-pos-save-label-death">
              <svg width="400" height="60">
                <defs>
                  <path id="deathTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text>
                  <textPath href="#deathTextPath" startOffset="50%" text-anchor="middle">
                    Death / Poison
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Wands Group -->
          <div class="save-group-wands cs-save-group">
            <div class="save wands-save cs-save cs-abs cs-pos-save-wands">
              <div class="cs-save-badge">
                <span class="cs-save-value">{{saves.wands.value}}</span>
              </div>
            </div>
            <div class="save-label-wands cs-save-label cs-abs cs-pos-save-label-wands">
              <svg width="400" height="60">
                <defs>
                  <path id="wandsTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text>
                  <textPath href="#wandsTextPath" startOffset="50%" text-anchor="middle">
                    Wands
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Paralysis Group -->
          <div class="save-group-paralysis cs-save-group">
            <div class="save paralysis-save cs-save cs-abs cs-pos-save-paralysis">
              <div class="cs-save-badge">
                <span class="cs-save-value">{{saves.paralysis.value}}</span>
              </div>
            </div>
            <div class="save-label-paralysis cs-save-label cs-abs cs-pos-save-label-paralysis">
              <svg width="400" height="60">
                <defs>
                  <path id="paralysisTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text>
                  <textPath href="#paralysisTextPath" startOffset="50%" text-anchor="middle">
                    Paralysis / Petrification
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Breath Attacks Group -->
          <div class="save-group-breath cs-save-group">
            <div class="save breath-save cs-save cs-abs cs-pos-save-breath">
              <div class="cs-save-badge">
                <span class="cs-save-value">{{saves.breath.value}}</span>
              </div>
            </div>
            <div class="save-label-breath cs-save-label cs-abs cs-pos-save-label-breath">
              <svg width="400" height="60">
                <defs>
                  <path id="breathTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text>
                  <textPath href="#breathTextPath" startOffset="50%" text-anchor="middle">
                    Breath Attacks
                  </textPath>
                </text>
              </svg>
            </div>
          </div>

          <!-- Spells/Rods/Staves Group -->
          <div class="save-group-spells cs-save-group">
            <div class="save spells-save cs-save cs-abs cs-pos-save-spells">
              <div class="cs-save-badge">
                <span class="cs-save-value">{{saves.spells.value}}</span>
              </div>
            </div>
            <div class="save-label-spells cs-save-label cs-abs cs-pos-save-label-spells">
              <svg width="400" height="60">
                <defs>
                  <path id="spellsTextPath" d="M 150,25 A 50,50 0 0,0 250,25" stroke="none" fill="none"/>
                </defs>
                <text>
                  <textPath href="#spellsTextPath" startOffset="50%" text-anchor="middle">
                    Spells / Rods / Staves
                  </textPath>
                </text>
              </svg>
            </div>
          </div>


          <!-- Listening at Doors Field -->
          <div class="listening-group cs-abs cs-pos-listening">
            <div class="cs-char-field-group">
              <label class="cs-field-label">Listen at Doors</label>
              <select class="listening-doors cs-listening-select" id="listening-doors" name="system.listeningAtDoors" data-dtype="String">
                <option value="1" {{#if (eq system.listeningAtDoors "1")}}selected{{/if}}>1</option>
                <option value="2" {{#if (eq system.listeningAtDoors "2")}}selected{{/if}}>2</option>
                <option value="3" {{#if (eq system.listeningAtDoors "3")}}selected{{/if}}>3</option>
                <option value="4" {{#if (eq system.listeningAtDoors "4")}}selected{{/if}}>4</option>
                <option value="5" {{#if (eq system.listeningAtDoors "5")}}selected{{/if}}>5</option>
              </select>
            </div>
          </div>

          <!-- Find Secret Door Field -->
          <div class="listening-group cs-abs cs-pos-find-secret-door">
            <div class="cs-char-field-group">
              <label class="cs-field-label">Find Secret Door</label>
              <select class="find-secret-door cs-listening-select" id="find-secret-door" name="system.findSecretDoor" data-dtype="String">
                <option value="1" {{#if (eq system.findSecretDoor "1")}}selected{{/if}}>1</option>
                <option value="2" {{#if (eq system.findSecretDoor "2")}}selected{{/if}}>2</option>
                <option value="3" {{#if (eq system.findSecretDoor "3")}}selected{{/if}}>3</option>
                <option value="4" {{#if (eq system.findSecretDoor "4")}}selected{{/if}}>4</option>
                <option value="5" {{#if (eq system.findSecretDoor "5")}}selected{{/if}}>5</option>
              </select>
            </div>
          </div>

          <!-- Open Stuck Doors Field -->
          <div class="listening-group cs-abs cs-pos-open-stuck-doors">
            <div class="cs-char-field-group">
              <label class="cs-field-label">Open Stuck Doors</label>
              <select class="open-stuck-doors cs-listening-select" id="open-stuck-doors" name="system.openStuckDoors" data-dtype="String">
                <option value="1" {{#if (eq system.openStuckDoors "1")}}selected{{/if}}>1</option>
                <option value="2" {{#if (eq system.openStuckDoors "2")}}selected{{/if}}>2</option>
                <option value="3" {{#if (eq system.openStuckDoors "3")}}selected{{/if}}>3</option>
                <option value="4" {{#if (eq system.openStuckDoors "4")}}selected{{/if}}>4</option>
                <option value="5" {{#if (eq system.openStuckDoors "5")}}selected{{/if}}>5</option>
                <option value="6" {{#if (eq system.openStuckDoors "6")}}selected{{/if}}>6</option>
              </select>
            </div>
          </div>

          <!-- Detect Construction Tricks Field -->
          <div class="listening-group cs-abs cs-pos-detect-construction">
            <div class="cs-char-field-group">
              <label class="cs-field-label">Detect Construction Tricks</label>
              <select class="detect-construction cs-listening-select" id="detect-construction" name="system.detectConstruction" data-dtype="String">
                <option value="" {{#if (eq system.detectConstruction "")}}selected{{/if}}></option>
                <option value="1" {{#if (eq system.detectConstruction "1")}}selected{{/if}}>1</option>
                <option value="2" {{#if (eq system.detectConstruction "2")}}selected{{/if}}>2</option>
                <option value="3" {{#if (eq system.detectConstruction "3")}}selected{{/if}}>3</option>
                <option value="4" {{#if (eq system.detectConstruction "4")}}selected{{/if}}>4</option>
                <option value="5" {{#if (eq system.detectConstruction "5")}}selected{{/if}}>5</option>
              </select>
            </div>
          </div>

          <!-- Detect Room Traps Field -->
          <div class="listening-group cs-abs cs-pos-detect-room-traps">
            <div class="cs-char-field-group">
              <label class="cs-field-label">Detect Room Traps</label>
              <select class="detect-room-traps cs-listening-select" id="detect-room-traps" name="system.detectRoomTraps" data-dtype="String">
                <option value="" {{#if (eq system.detectRoomTraps "")}}selected{{/if}}></option>
                <option value="1" {{#if (eq system.detectRoomTraps "1")}}selected{{/if}}>1</option>
                <option value="2" {{#if (eq system.detectRoomTraps "2")}}selected{{/if}}>2</option>
                <option value="3" {{#if (eq system.detectRoomTraps "3")}}selected{{/if}}>3</option>
                <option value="4" {{#if (eq system.detectRoomTraps "4")}}selected{{/if}}>4</option>
                <option value="5" {{#if (eq system.detectRoomTraps "5")}}selected{{/if}}>5</option>
              </select>
            </div>
          </div>

          <!-- Barbarian Climb Surfaces Field -->
          <div class="listening-group cs-abs cs-pos-barbarian-climb">
            <div class="cs-char-field-group">
              <label class="cs-field-label">Climb Surfaces (Barbarian)</label>
              <select class="barbarian-climb cs-listening-select" id="barbarian-climb" name="system.barbarianClimb" data-dtype="String">
                <option value="" {{#if (eq system.barbarianClimb "")}}selected{{/if}}></option>
                <option value="1" {{#if (eq system.barbarianClimb "1")}}selected{{/if}}>1</option>
                <option value="2" {{#if (eq system.barbarianClimb "2")}}selected{{/if}}>2</option>
                <option value="3" {{#if (eq system.barbarianClimb "3")}}selected{{/if}}>3</option>
                <option value="4" {{#if (eq system.barbarianClimb "4")}}selected{{/if}}>4</option>
                <option value="5" {{#if (eq system.barbarianClimb "5")}}selected{{/if}}>5</option>
              </select>
            </div>
          </div>

          <!-- Barbarian Hide in Undergrowth Field -->
          <div class="listening-group cs-abs cs-pos-barbarian-hide">
            <div class="cs-char-field-group">
              <label class="cs-field-label">Hide in Undergrowth (Barbarian)</label>
              <select class="barbarian-hide cs-listening-select" id="barbarian-hide" name="system.barbarianHide" data-dtype="String">
                <option value="" {{#if (eq system.barbarianHide "")}}selected{{/if}}></option>
                <option value="1" {{#if (eq system.barbarianHide "1")}}selected{{/if}}>1</option>
                <option value="2" {{#if (eq system.barbarianHide "2")}}selected{{/if}}>2</option>
                <option value="3" {{#if (eq system.barbarianHide "3")}}selected{{/if}}>3</option>
                <option value="4" {{#if (eq system.barbarianHide "4")}}selected{{/if}}>4</option>
                <option value="5" {{#if (eq system.barbarianHide "5")}}selected{{/if}}>5</option>
              </select>
            </div>
          </div>

          <!-- Barbarian Move Silently Field -->
          <div class="listening-group cs-abs cs-pos-barbarian-move">
            <div class="cs-char-field-group">
              <label class="cs-field-label">Move Silently (Barbarian)</label>
              <select class="barbarian-move cs-listening-select" id="barbarian-move" name="system.barbarianMove" data-dtype="String">
                <option value="" {{#if (eq system.barbarianMove "")}}selected{{/if}}></option>
                <option value="1" {{#if (eq system.barbarianMove "1")}}selected{{/if}}>1</option>
                <option value="2" {{#if (eq system.barbarianMove "2")}}selected{{/if}}>2</option>
                <option value="3" {{#if (eq system.barbarianMove "3")}}selected{{/if}}>3</option>
                <option value="4" {{#if (eq system.barbarianMove "4")}}selected{{/if}}>4</option>
                <option value="5" {{#if (eq system.barbarianMove "5")}}selected{{/if}}>5</option>
              </select>
            </div>
          </div>

        </div>
      </div>
      <!-- Skills Tab -->
  <div class="tab" data-group="primary" data-tab="skills">
        <!-- Combat Stats Section -->
        <div class="combat-stats cs-combat-stats">
          <div class="combat-stat cs-combat-stat">
            <label for="char-ac" class="cs-field-label">Armor Class</label>
            <input class="char-ac cs-combat-input" id="char-ac" name="system.ac" type="number" value="{{system.ac}}" min="0" max="20" />
          </div>
          <div class="combat-stat cs-combat-stat">
            <label class="cs-field-label">Unarmored AC</label>
            <div class="cs-unarmored-box">
              {{unarmoredAC system.attributes.dex.value}}
            </div>
          </div>
          <div class="combat-stat cs-combat-stat">
            <label for="char-hp" class="cs-field-label">Current HP</label>
            <input class="char-hp cs-combat-input" id="char-hp" name="system.hitpoints" type="number" value="{{system.hitpoints}}" min="0" />
          </div>
          <div class="combat-stat cs-combat-stat">
            <label for="char-max-hp" class="cs-field-label">Max HP</label>
            <input class="char-max-hp cs-combat-input" id="char-max-hp" name="system.maxhitpoints" type="number" value="{{system.maxhitpoints}}" min="0" />
          </div>
        </div>

        <!-- Additional Skills content can go here -->

      </div>
      <!-- Equipment Tab -->
      <div class="tab" data-group="primary" data-tab="equipment">
        <section class="equipment-tab">
          {{!-- Weapons Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Weapons</div>
              <div class="field-short">Damage</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="weapon" title="Add Weapon">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each weapons as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow {{#if item.isWeapon}}item-rollable{{/if}}">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.damage}}</div>
                  <div class="field-short">{{item.system.weight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-hand"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                  {{#if item.displayTags}}
                  <div class="item-tags">
                    {{#each item.displayTags as |tag|}}
                    <span class="tag">{{tag.value}}</span>
                    {{/each}}
                  </div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Armor Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Armor</div>
              <div class="field-short">AC</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="armor" title="Add Armor">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each armor as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.ac.value}}</div>
                  <div class="field-short">{{item.system.weight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-tshirt"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Containers Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Containers</div>
              <div class="field-short">Capacity</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="container" title="Add Container">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each containers as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.capacity.value}}/{{item.system.capacity.max}}</div>
                  <div class="field-short">{{item.system.weight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-hand"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- General Items Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Items</div>
              <div class="field-short">Qty</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="item" title="Add Item">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each items as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short quantity">
                    <input 
                      value="{{item.system.quantity.value}}" 
                      type="number" 
                      min="0" 
                      data-field="system.quantity.value"
                      data-item-id="{{item.id}}"
                    />
                    {{#if item.system.quantity.max}}
                    <span>/{{item.system.quantity.max}}</span>
                    {{/if}}
                  </div>
                  <div class="field-short">{{multiply item.system.weight item.system.quantity.value}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-toggle {{#unless item.system.equipped}}item-unequipped{{/unless}}" title="Equip/Unequip">
                      <i class="fas fa-hand"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Treasure Section --}}
          <div class="item-category">
            <div class="item-category-title flexrow">
              <div class="category-caret"><i class="fas fa-caret-down"></i></div>
              <div class="category-name">Treasure</div>
              <div class="field-short">Value</div>
              <div class="field-short">Weight</div>
              <div class="item-controls">
                <a class="item-control item-create" data-type="item" data-treasure="true" title="Add Treasure">
                  <i class="fa fa-plus"></i>
                </a>
              </div>
            </div>
            <ol class="item-list">
              {{#each treasures as |item|}}
              <li class="item-entry item" data-item-id="{{item.id}}">
                <div class="item-header flexrow">
                  <div class="item-image"></div>
                  <h4 class="item-name" title="{{item.name}}">{{item.name}}</h4>
                  <div class="field-short">{{item.system.cumulativeCost}} gp</div>
                  <div class="field-short">{{item.system.cumulativeWeight}}</div>
                  <div class="item-controls">
                    {{#if @root.owner}}
                    <a class="item-control item-show" title="Show Item">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="item-control item-edit" title="Edit Item">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-delete" title="Delete Item">
                      <i class="fas fa-trash"></i>
                    </a>
                    {{/if}}
                  </div>
                </div>
                <div class="item-summary {{#if item.isExpanded}}expanded{{/if}}">
                  {{#if item.system.description}}
                  <div class="item-description">{{item.system.description}}</div>
                  {{/if}}
                </div>
              </li>
              {{/each}}
            </ol>
          </div>

          {{!-- Encumbrance Bar --}}
          <section class="encumbrance-section">
            <div class="encumbrance-label">Encumbrance</div>
            <div class="encumbrance-bar-container">
              <div class="encumbrance-bar" data-encumbrance="{{encumbrancePercentage}}"></div>
              <span class="encumbrance-text">{{totalWeight}} / {{maxWeight}} lbs</span>
            </div>
          </section>
          </section>
        </div>

      <!-- Bio Tab -->
      <div class="tab" data-group="primary" data-tab="bio">
        <div class="bio-content">          
          <!-- Character Appearance -->
          <div class="bio-section">
            <h3 class="cs-bio-heading">Appearance</h3>
            <textarea class="cs-bio-textarea" name="system.bio.appearance" placeholder="Describe your character's physical appearance...">{{system.bio.appearance}}</textarea>
          </div>

          <!-- Character Personality -->
          <div class="bio-section">
            <h3 class="cs-bio-heading">Personality</h3>
            <textarea class="cs-bio-textarea" name="system.bio.personality" placeholder="Describe your character's personality, traits, and mannerisms...">{{system.bio.personality}}</textarea>
          </div>

          <!-- Character Background/History -->
          <div class="bio-section">
            <h3 class="cs-bio-heading">Background & History</h3>
            <textarea class="cs-bio-textarea" name="system.bio.history" placeholder="Tell your character's story, background, and important life events...">{{system.bio.history}}</textarea>
          </div>

          <!-- Character Goals & Motivations -->
          <div class="bio-section">
            <h3 class="cs-bio-heading">Goals & Motivations</h3>
            <textarea class="cs-bio-textarea" name="system.bio.goals" placeholder="What drives your character? What are their goals and motivations...">{{system.bio.goals}}</textarea>
          </div>

          <!-- Additional Notes -->
          <div class="bio-section">
            <h3 class="cs-bio-heading">Additional Notes</h3>
            <textarea class="cs-bio-textarea" name="system.bio.notes" placeholder="Any additional notes, relationships, or important details...">{{system.bio.notes}}</textarea>
          </div>

        </div>
      </div>
    </section>
</form>

<script>
  // Map data attributes to CSS variables so tab positions are data-driven and markup stays clean.
  (function(){
    function applyTabVars(root=document){
      const tabs = root.querySelectorAll('.sheet-tabs .item');
      tabs.forEach(el => {
        const top = el.getAttribute('data-tab-top');
        const left = el.getAttribute('data-tab-left');
        if (top !== null) el.style.setProperty('--tab-top', top);
        if (left !== null) el.style.setProperty('--tab-left', left);
      });
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => applyTabVars(document));
    } else applyTabVars(document);
  })();
</script>

<script>
  (function(){
    const BASE_Z = 500; // base z-index for tabs
    const ACTIVE_Z = 5000; // z-index for active tab (very high to override everything)

    function ensureTabZIndices(root=document){
      const tabs = Array.from(root.querySelectorAll('.sheet-tabs .item'));


      tabs.forEach((el, idx) => {
        if (el.classList.contains('active')) {
          // Active tab gets the highest z-index - use multiple methods to force it
          el.style.setProperty('z-index', String(ACTIVE_Z), 'important');
          el.style.zIndex = String(ACTIVE_Z);
          el.dataset._zAssigned = String(ACTIVE_Z);

        } else {
          // Non-active tabs get incrementally higher z-index from bottom to top
          const zValue = BASE_Z + (tabs.length - idx);
          el.style.setProperty('z-index', String(zValue), 'important');
          el.style.zIndex = String(zValue);
          el.dataset._zAssigned = String(zValue);

        }
      });
    }

    function init(){

      ensureTabZIndices(document);
      const nav = document.querySelector('.sheet-tabs');
      if (!nav) {

        return;
      }

      // Re-run z-index assignment when tabs change (mutation observer)
      const mo = new MutationObserver(() => {

        ensureTabZIndices(document);
      });
      mo.observe(nav, { childList: true, subtree: false, attributes: true, attributeFilter: ['class'] });

      // Re-run z-index assignment when active tab changes (click events)
      nav.addEventListener('click', (e) => {

        // Use setTimeout to ensure the active class has been updated
        setTimeout(() => {

          ensureTabZIndices(document);
        }, 50);
      });

      // Also listen for class changes directly
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {

            setTimeout(() => ensureTabZIndices(document), 10);
          }
        });
      });

      tabs.forEach(tab => {
        observer.observe(tab, { attributes: true, attributeFilter: ['class'] });
      });
    }

  // Z-INDEX MANAGEMENT - Run after character sheet JS initializes
  setTimeout(function(){

    const BASE_Z = 500;
    const ACTIVE_Z = 5000;

    function forceTabZIndices(){
      const tabs = Array.from(document.querySelectorAll('.sheet-tabs .item'));


      tabs.forEach((el, idx) => {
        const isActive = el.classList.contains('active');
        const zValue = isActive ? ACTIVE_Z : (BASE_Z + (tabs.length - idx));

        // Force z-index with multiple methods
        el.style.setProperty('z-index', String(zValue), 'important');
        el.style.zIndex = String(zValue);


      });
    }

    // Run immediately
    forceTabZIndices();

    // Hook into the existing character sheet tab system
    const nav = document.querySelector('.sheet-tabs');
    if (nav) {


      // Intercept ALL click events on the tab container
      nav.addEventListener('click', function(e) {

        // Run after a delay to let the character sheet JS finish
        setTimeout(forceTabZIndices, 100);
      }, true); // Use capture phase

      // Also run periodically to catch any missed updates
      setInterval(forceTabZIndices, 2000);
    }


  }, 1000); // Wait 1 second for character sheet to initialize
})();
</script>
